<!DOCTYPE html>
<html lang="ne">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Construction Site Management</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <style>
      :root {
        --green: #1ab189;
        --blue: #0b5db8;
        --red: #dc3545;
        --bg: #f0f2f5;
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --green-soft: #e7faf3;
        --green-border: #b7ead7;
        --red-soft: #fdebea;
        --red-border: #f7c6c3;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        height: 100%;
        min-height: 100vh;
        overflow-x: hidden;
        background: var(--bg);
        color: #344054;
        font-family: "Noto Sans Devanagari", "Poppins", system-ui, -apple-system,
          "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        scrollbar-width: none;
      }
      html::-webkit-scrollbar,
      body::-webkit-scrollbar,
      .content-area::-webkit-scrollbar,
      .activity-list::-webkit-scrollbar {
        width: 0;
        height: 0;
        display: none;
      }

      .mobile-container {
        width: 100%;
        height: 100dvh;
        min-height: 100svh;
        min-height: -webkit-fill-available;
        background: #fff;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* HEADER */
      .page-header {
        background: var(--green);
        color: #fff;
        padding: calc(56px + var(--safe-top)) 16px 16px;
      }
      .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      .header-content a {
        color: #fff;
        font-size: 20px;
        text-decoration: none;
        min-width: 28px;
        text-align: center;
      }
      .header-title-section {
        text-align: center;
        flex: 1;
        min-width: 0;
      }
      .header-title-section h1 {
        margin: 0;
        font-size: clamp(18px, 5vw, 22px);
        font-weight: 700;
        line-height: 1.1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .header-title-section p {
        margin: 0;
        font-size: 14px;
        opacity: 0.9;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* ACTION BUTTONS */
      .header-actions {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
        margin-top: 16px;
        width: 100%;
      }
      .header-btn {
        min-height: 48px;
        padding: 10px 12px;
        border: 0;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 700;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
      }
      .btn-rate {
        background: var(--blue);
        color: #fff;
      }
      .btn-resource {
        background: var(--red);
        color: #fff;
      }

      /* CONTENT */
      .content-area {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        background: #f8f9fa;
        padding: 16px;
        padding-bottom: calc(140px + 52px + var(--safe-bottom));
        scrollbar-width: none;
      }

      /* SUMMARY CARDS */
      .summary-cards {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }
      .summary-card {
        padding: 14px 12px;
        border-radius: 14px;
        text-align: center;
        background: #fff;
        border: 1px solid #eef0f2;
      }
      .summary-card.income {
        background: var(--green-soft);
        border-color: var(--green-border);
      }
      .summary-card.expense {
        background: var(--red-soft);
        border-color: var(--red-border);
      }
      .icon {
        margin-bottom: 6px;
        display: grid;
        place-items: center;
      }
      .icon img {
        width: 28px;
        height: 28px;
        display: block;
      }
      .amount {
        font-size: 20px;
        font-weight: 600; /* lighter */
        color: #0f172a;
      }
      .label {
        font-size: 13px;
        color: #475467;
      }

      /* SECTION HEAD + FILTER */
      .section-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 14px 2px 8px;
      }
      .section-title {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: #0f172a;
      }
      .filter-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #1ab189;
        color: #fff;
        border: 0;
        border-radius: 10px;
        padding: 8px 12px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      }

      /* EMPTY */
      .empty-full {
        display: none;
        text-align: center;
        color: #475467;
        padding: 22px 8px;
      }
      .empty-full.show {
        display: block;
      }
      .empty-full img {
        width: clamp(80px, 28vw, 120px);
        height: auto;
        display: block;
        margin: 8px auto 10px;
      }
      .empty-full h3 {
        margin: 0 0 6px;
        font-size: 16px;
        color: #0f172a;
      }
      .empty-full p {
        margin: 0;
        font-size: 14px;
      }

      /* LIST / TABLE */
      .activity-list {
        margin-top: 8px;
        background: #fff;
        border-radius: 12px;
        padding: 10px;
        flex: 1 1 auto;
        overflow: auto;
        min-height: 160px;
        position: relative;
        scrollbar-width: none;
      }
      .table-modern {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 14px;
      }
      .table-modern thead th {
        position: sticky;
        top: 0;
        z-index: 1;
        background: #f7faf9;
        color: #0f172a;
        font-weight: 700;
        padding: 10px 12px;
        border-bottom: 1px solid #e9eef3;
        text-align: left;
      }
      .table-modern tbody td {
        padding: 12px;
        border-bottom: 1px solid #f0f2f5;
        color: #344054;
      }
      .table-modern tbody tr:last-child td {
        border-bottom: 0;
      }
      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
      }
      .pill-income {
        background: #e6f4ea;
        color: #0e8d6a;
      }
      .pill-expense {
        background: #fde7e9;
        color: #c23a2b;
      }
      .text-end {
        text-align: right;
      }
      .actions {
        display: flex;
        gap: 6px;
        justify-content: flex-end;
      }
      .btn-icon {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid transparent;
        background: #eff6ff;
        color: #0b5db8;
      }
      .btn-icon.delete {
        background: #ffe9e7;
        color: #dc3545;
      }
      .btn-icon i {
        font-size: 14px;
        line-height: 1;
      }

      /* SHEET */
      .sheet-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        padding: 16px;
      }
      .sheet {
        width: min(92vw, 420px);
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
        overflow: hidden;
      }
      .sheet-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        font-weight: 700;
        font-size: 18px;
        color: #334155;
        cursor: pointer;
      }
      .sheet-row + .sheet-row {
        border-top: 1px solid #eef2f6;
      }
      .options-menu {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
      }
      .sheet-overlay.show {
        display: flex;
      }

      /* FLOATING ACTION BUTTONS */
      .bottom-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 64px;
        z-index: 5;
        background: transparent;
        border: 0;
        padding: 0 16px;
        pointer-events: none;
      }
      .bottom-row {
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: nowrap;
        padding-bottom: calc(14px + var(--safe-bottom));
        pointer-events: auto;
      }
      .bottom-bar .header-btn {
        flex: 1;
        min-width: 0;
        height: 48px;
      }
      .bottom-bar .header-btn img {
        width: 18px;
        height: 18px;
        display: block;
        filter: brightness(0) invert(1);
      }

      /* TOAST */
      #toast {
        position: fixed;
        top: calc(12px + var(--safe-top));
        right: calc(12px + var(--safe-right));
        transform: translateY(-8px);
        background: #fff;
        border: 1px solid #e5e7eb;
        color: #111827;
        border-radius: 12px;
        padding: 8px 12px 8px 10px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
        display: grid;
        grid-template-columns: 28px 1fr 18px;
        align-items: center;
        gap: 10px;
        width: max-content;
        max-width: 92vw;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.22s, transform 0.22s;
        z-index: 10000;
        line-height: 1.2;
      }
      #toast.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }
      .toast-badge {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        color: #fff;
        font-weight: 600;
      }
      .toast-badge.success {
        background: #74c69d;
      }
      .toast-badge.error {
        background: #ef4444;
      }
      .toast-msg {
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .toast-x {
        color: #6b7280;
        cursor: pointer;
        font-size: 18px;
        text-align: center;
        line-height: 1;
      }

      /* Bottom nav host */
      #bottom-nav-container {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 4;
      }
    </style>
  </head>

  <body>
    <div class="mobile-container">
      <header class="page-header">
        <div class="header-content">
          <a
            href="c-site-list.html"
            class="back-arrow"
            onclick="history.back(); return false;"
          >
            <i class="fas fa-chevron-left"></i>
          </a>
          <div class="header-title-section">
            <h1 id="site-name">लोड हुँदै...</h1>
            <p id="site-address"></p>
          </div>
          <a
            href="#"
            class="options-menu"
            id="open-actions"
            aria-label="अधिक विकल्प"
          >
            <i class="fas fa-ellipsis-v"></i>
          </a>
        </div>
        <div class="header-actions">
          <a id="rate-btn" class="header-btn btn-rate" href="#">दर सेटिङ</a>
          <a id="resource-btn" class="header-btn btn-resource" href="#">
            <i class="fas fa-cogs"></i> रिसोर्स
          </a>
        </div>
      </header>

      <main class="content-area">
        <div class="summary-cards">
          <div class="summary-card income">
            <div class="icon">
              <img src="healthicons_low-income-level.svg" alt="आम्दानी" />
            </div>
            <div class="amount" id="total-income">रु ०</div>
            <div class="label">आम्दानी</div>
          </div>
        <div class="summary-card expense">
            <div class="icon"><img src="Group 442.svg" alt="खर्च" /></div>
            <div class="amount" id="total-expense">रु ०</div>
            <div class="label">खर्च</div>
          </div>
        </div>

        <div class="section-head">
          <h2 class="section-title">हालका गतिविधिहरु</h2>
          <button id="filter-btn" class="filter-btn">
            <i class="fa-solid fa-filter"></i> छान्नुहोस्
          </button>
        </div>

        <section id="empty-full" class="empty-full">
          <img src="illustration.png" alt="Empty illustration" />
          <h3>अहिलेसम्म कुनै गतिविधि छैन</h3>
          <p>थप्न सुरु गर्न तलका बटन प्रयोग गर्नुहोस्।</p>
        </section>

        <div class="activity-list" id="activity-list">
          <p id="loading-activities">गतिविधिहरु लोड गर्दै...</p>
          <p
            id="auth-error-message"
            style="display: none; color: orange; font-weight: 700"
          >
            ⚠️ कृपया लगइन गर्नुहोस्।
          </p>
          <p id="activity-error" style="display: none; color: red">
            गतिविधिहरु लोड गर्न असफल भयो।
          </p>

          <table
            id="activities-table"
            class="table-modern"
            style="display: none"
          >
            <thead>
              <tr>
                <th style="width: 110px">मिति</th>
                <th>शीर्षक</th>
                <th style="width: 110px">प्रकार</th>
                <th style="width: 110px" class="text-end">रकम</th>
                <th>कैफियत</th>
                <th style="width: 84px" class="text-end">कार्य</th>
              </tr>
            </thead>
            <tbody id="activities-tbody"></tbody>
          </table>
        </div>
      </main>

      <!-- Floating two buttons -->
      <div class="bottom-bar">
        <div class="bottom-row">
          <button
            id="open-income-modal"
            class="header-btn"
            style="background: var(--blue); color: #fff"
          >
            <img src="healthicons_low-income-level.svg" alt="" /><span
              >आम्दानी थप्नुहोस्</span
            >
          </button>
          <button
            id="open-expense-modal"
            class="header-btn"
            style="background: var(--red); color: #fff"
          >
            <img src="Group 442.svg" alt="" /><span>खर्च थप्नुहोस्</span>
          </button>
        </div>
      </div>

      <div id="bottom-nav-container" aria-hidden="true"></div>
    </div>

    <!-- Kebab action sheet -->
    <div id="site-actions" class="sheet-overlay" aria-hidden="true">
      <div class="sheet" role="menu" aria-label="Site actions">
        <div id="action-edit" class="sheet-row">
          <i class="fa-solid fa-pen"></i><span>साइट एडिट गर्नुहोस्</span>
        </div>
      </div>
    </div>

    <!-- ===== Filter Modal (छान्नुहोस्) ===== -->
    <div id="filter-modal" class="sheet-overlay" aria-hidden="true">
      <div class="sheet" style="padding: 18px 16px">
        <h3 style="margin: 0 0 12px; font-size: 20px; color: #0f172a">
          समय अवधि छान्नुहोस्
        </h3>

        <div id="preset-opts" style="display: grid; gap: 12px">
          <button
            data-preset="7d"
            class="preset-btn"
            style="text-align:left;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;background:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;"
          >
            ७ दिन
          </button>
          <button
            data-preset="15d"
            class="preset-btn"
            style="text-align:left;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;background:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;"
          >
            १५ दिन
          </button>
          <button
            data-preset="1m"
            class="preset-btn"
            style="text-align:left;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;background:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;"
          >
            १ महिना
          </button>
          <button
            data-preset="custom"
            class="preset-btn"
            style="text-align:left;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;background:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;"
          >
            कस्टम
          </button>
        </div>

        <div style="margin-top: 12px">
          <label style="display: block; margin: 6px 2px 6px">सुरु मिति</label>
          <div style="display: flex; align-items: center">
            <input
              id="f-start"
              type="date"
              style="flex: 1; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 16px;"
            />
            <i class="fa-regular fa-calendar" style="margin-left: 10px; color: #11182780"></i>
          </div>
        </div>

        <div style="margin-top: 12px">
          <label style="display: block; margin: 6px 2px 6px">अन्त्य मिति</label>
          <div style="display: flex; align-items: center">
            <input
              id="f-end"
              type="date"
              style="flex: 1; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 16px;"
            />
            <i class="fa-regular fa-calendar" style="margin-left: 10px; color: #11182780"></i>
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 16px">
          <button
            id="apply-filter"
            class="header-btn"
            style="flex: 1; background: #1ab189; color: #fff"
          >
            लागू गर्नुहोस्
          </button>
          <button
            id="cancel-filter"
            class="header-btn"
            style="flex: 1; background: #e5e7eb; color: #334155"
          >
            रद्द गर्नुहोस्
          </button>
        </div>
      </div>
    </div>

    <!-- Income Modal -->
    <div id="income-modal" class="sheet-overlay">
      <div class="sheet" style="width: min(92vw, 380px); padding: 22px 24px">
        <div
          style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;"
        >
          <h2 style="margin: 0; font-size: 18px">आम्दानी थप्नुहोस्</h2>
          <button
            id="close-income-modal"
            class="modal-close-btn"
            style="background: none; border: 0; font-size: 26px; cursor: pointer; color: #555;"
          >
            &times;
          </button>
        </div>
        <form id="income-form" novalidate>
          <label>शीर्षक</label>
          <input
            id="income-title"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="none"
            spellcheck="false"
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          />
          <div class="field-error" id="income-title-err"></div>

          <label style="display: block; margin: 10px 0 6px">रकम</label>
          <input
            type="number"
            id="income-amount"
            min="0"
            step="0.01"
            inputmode="decimal"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="none"
            spellcheck="false"
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          />
          <div class="field-error" id="income-amount-err"></div>

          <label style="display: block; margin: 10px 0 6px">मिति</label>
          <input
            type="date"
            id="income-date"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="none"
            spellcheck="false"
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          />
          <div class="field-error" id="income-date-err"></div>

          <label style="display: block; margin: 10px 0 6px">टिप्पणी</label>
          <textarea
            id="income-notes"
            rows="3"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="none"
            spellcheck="false"
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          ></textarea>
          <div class="field-error" id="income-notes-err"></div>

          <button
            type="submit"
            class="header-btn"
            style="margin-top: 16px; width: 100%; background: var(--blue); color: #fff"
          >
            सेभ गर्नुहोस्
          </button>
        </form>
      </div>
    </div>

    <!-- Expense Modal -->
    <div id="expense-modal" class="sheet-overlay">
      <div class="sheet" style="width: min(92vw, 380px); padding: 22px 24px">
        <div
          style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;"
        >
          <h2 style="margin: 0; font-size: 18px">खर्च थप्नुहोस्</h2>
          <button
            id="close-expense-modal"
            class="modal-close-btn"
            style="background: none; border: 0; font-size: 26px; cursor: pointer; color: #555;"
          >
            &times;
          </button>
        </div>
        <form id="expense-form" novalidate>
          <label>शीर्षक</label>
          <input
            id="expense-title"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="none"
            spellcheck="false"
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          />
          <div class="field-error" id="expense-title-err"></div>

          <label style="display: block; margin: 10px 0 6px">रकम</label>
          <input
            type="number"
            id="expense-amount"
            min="0"
            step="0.01"
            inputmode="decimal"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="none"
            spellcheck="false"
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          />
          <div class="field-error" id="expense-amount-err"></div>

          <label style="display: block; margin: 10px 0 6px">मिति</label>
          <input
            type="date"
            id="expense-date"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="none"
            spellcheck="false"
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          />
          <div class="field-error" id="expense-date-err"></div>

          <label style="display: block; margin: 10px 0 6px">टिप्पणी</label>
          <textarea
            id="expense-notes"
            rows="3"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="none"
            spellcheck="false"
            style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          ></textarea>
          <div class="field-error" id="expense-notes-err"></div>

          <button
            type="submit"
            class="header-btn"
            style="margin-top: 16px; width: 100%; background: var(--red); color: #fff;"
          >
            सेभ गर्नुहोस्
          </button>
        </form>
      </div>
    </div>

    <!-- Finance Edit Modal -->
    <div id="finance-edit-modal" class="sheet-overlay">
      <div class="sheet" style="width: min(92vw, 380px); padding: 22px 24px">
        <div
          style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;"
        >
          <h2 style="margin: 0; font-size: 18px">रेकर्ड सम्पादन</h2>
          <button
            id="close-finance-edit"
            class="modal-close-btn"
            style="background: none; border: 0; font-size: 26px; cursor: pointer; color: #555;"
          >
            &times;
          </button>
        </div>
        <form id="finance-edit-form" novalidate>
          <input type="hidden" id="fe-id" />
          <input type="hidden" id="fe-kind" />
          <input type="hidden" id="fe-ie-id" />
          <div style="margin: 8px 0">
            <label>शीर्षक</label>
            <input
              id="fe-title"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="none"
              spellcheck="false"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
            />
            <div class="field-error" id="fe-title-err"></div>
          </div>
          <div style="margin: 8px 0">
            <label>रकम</label>
            <input
              type="number"
              id="fe-amount"
              min="0"
              step="0.01"
              inputmode="decimal"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="none"
              spellcheck="false"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
            />
            <div class="field-error" id="fe-amount-err"></div>
          </div>
          <div style="margin: 8px 0">
            <label>मिति</label>
            <input
              type="date"
              id="fe-date"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="none"
              spellcheck="false"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
            />
            <div class="field-error" id="fe-date-err"></div>
          </div>
          <div style="margin: 8px 0">
            <label>टिप्पणी</label>
            <textarea
              id="fe-remark"
              rows="3"
              autocomplete="off"
              autocorrect="off"
              autocapitalize="none"
              spellcheck="false"
              style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
            ></textarea>
          </div>
          <button
            type="submit"
            class="header-btn"
            style="margin-top: 16px; width: 100%; background: var(--blue); color: #fff;"
          >
            सेभ गर्नुहोस्
          </button>
        </form>
      </div>
    </div>

    <!-- Finance Delete Modal -->
    <div id="finance-delete-modal" class="sheet-overlay">
      <div class="sheet" style="width: min(92vw, 360px); padding: 22px 24px">
        <h2 id="fd-title" style="margin: 0 0 8px; font-size: 18px">
          मेटाउने हो?
        </h2>
        <p
          id="fd-desc"
          style="margin: 0 0 16px; color: #475467; font-size: 14px"
        >
          के तपाईं यो रेकर्ड मेट्न पक्का हुनुहुन्छ?
        </p>
        <div style="display: flex; gap: 10px">
          <button
            id="fd-cancel"
            class="header-btn"
            style="flex: 1; background: #eef2f6; color: #475467"
          >
            रद्द
          </button>
          <button
            id="fd-confirm"
            class="header-btn"
            style="flex: 1; background: var(--red); color: #fff"
          >
            मेटाउनुहोस्
          </button>
        </div>
      </div>
    </div>

    <!-- Toast host -->
    <div id="toast" role="status" aria-live="polite"></div>

    <script>
      /* ---------- CONFIG & HELPERS ---------- */
      var API = "http://192.168.1.209:8000/api";
      var raw = localStorage.getItem("auth_token") || "";
      var TOKEN = raw.indexOf("|") !== -1 ? raw.split("|")[1] : raw;
      var qs = new URLSearchParams(location.search);
      var SITE_ID = qs.get("id") || localStorage.getItem("current_site_id");
      if (!SITE_ID) {
        alert("साइट चयन गरिएको छैन।");
        location.href = "c-site-list.html";
      }
      var authHeader = TOKEN
        ? { Authorization: "Bearer " + TOKEN, Accept: "application/json" }
        : { Accept: "application/json" };

      /* ===== Nepali numerals helpers ===== */
      var NP_DIG = ["०", "१", "२", "३", "४", "५", "६", "७", "८", "९"];
      var MAP_NP_EN = {
        "०": "0",
        "१": "1",
        "२": "2",
        "३": "3",
        "४": "4",
        "५": "5",
        "६": "6",
        "७": "7",
        "८": "8",
        "९": "9",
      };
      function toNP(s) {
        return String(s).replace(/\d/g, (d) => NP_DIG[d]);
      }
      function toEN(s) {
        return String(s).replace(/[०-९]/g, (d) => MAP_NP_EN[d] || d);
      }
      function formatCurrency(n) {
        var en = (Number(n) || 0).toLocaleString("en-IN", {
          maximumFractionDigits: 0,
        });
        return "रु " + toNP(en);
      }
      function bindNepaliAmountInput(el) {
        if (!el) return;
        el.addEventListener("keydown", function (e) {
          var m = MAP_NP_EN[e.key];
          if (m !== undefined) {
            e.preventDefault();
            var start = el.selectionStart,
              end = el.selectionEnd,
              v = el.value || "";
            el.value = v.slice(0, start) + m + v.slice(end);
            el.setSelectionRange(start + 1, start + 1);
            el.dispatchEvent(new Event("input", { bubbles: true }));
          }
        });
        el.addEventListener("input", function (e) {
          e.target.value = toEN(e.target.value).replace(/[^\d.]/g, "");
        });
      }
      function fmtDate(d) {
        return new Date(d).toISOString().slice(0, 10);
      }
      function addDays(d, n) {
        const t = new Date(d);
        t.setDate(t.getDate() + n);
        return t;
      }
      function nepYMD(dt) {
        if (!(dt instanceof Date) || isNaN(dt)) return "–";
        const y = dt.getFullYear(),
          m = String(dt.getMonth() + 1).padStart(2, "0"),
          d = String(dt.getDate()).padStart(2, "0");
        return toNP(`${y}/${m}/${d}`);
      }

      // Toast
      function toast(msg, kind) {
        if (kind !== "error") kind = "success";
        var t = document.getElementById("toast");
        if (!t) {
          t = document.createElement("div");
          t.id = "toast";
          document.body.appendChild(t);
        }
        t.innerHTML =
          '<span class="toast-badge ' +
          (kind === "error" ? "error" : "success") +
          '">' +
          (kind === "error" ? "✖" : "✓") +
          "</span>" +
          '<span class="toast-msg">' +
          (msg || "") +
          "</span>" +
          '<span class="toast-x" aria-label="Close">×</span>';
        t.classList.add("show");
        t.querySelector(".toast-x").onclick = function () {
          t.classList.remove("show");
        };
        clearTimeout(toast._t);
        toast._t = setTimeout(function () {
          t.classList.remove("show");
        }, 2000);
      }

      var recordsById = {};
      var totalIncome = 0,
        totalExpense = 0;
      var allItems = [];
      var overallTotals = { inc: 0, exp: 0 };

      /* ---------- HEADER ---------- */
      async function loadSiteInfo() {
        try {
          var res = await fetch(API + "/sites/" + SITE_ID, {
            headers: authHeader,
          });
          var site = await res.json();
          document.getElementById("site-name").textContent =
            site && site.name ? site.name : "साइट";
          var phone =
            site && site.owner && site.owner.phone_no
              ? site.owner.phone_no
              : (site && site.phone_no) || "";
          var address = (site && site.address) || "";
          document.getElementById("site-address").textContent = toNP(
            [address, phone].filter(Boolean).join(" | ")
          );
        } catch (e) {}
        document.getElementById("rate-btn").href =
          "ratesetting.html?site_id=" + SITE_ID;
        document.getElementById("resource-btn").href =
          "site-resources.html?site_id=" + SITE_ID;
        localStorage.setItem("current_site_id", SITE_ID);
      }

      /* ---------- TABLE / LIST ---------- */
      function num(v) {
        v = (v == null ? "" : String(v)).replace(/[,\s]/g, "");
        var n = Number(v);
        return isNaN(n) ? 0 : n;
      }
      function pickKindAndAmount(r) {
        var c = num(r && (r.credit != null ? r.credit : r.credit_amount));
        var d = num(r && (r.debit != null ? r.debit : r.debit_amount));
        var a = num(r && (r.amount != null ? r.amount : r.value));
        if (r && typeof r.is_income === "boolean")
          return {
            kind: r.is_income ? "income" : "expense",
            amount: a || (r.is_income ? c : d) || Math.max(c, d),
          };
        if (c > 0 && d === 0) return { kind: "income", amount: c };
        if (d > 0 && c === 0) return { kind: "expense", amount: d };
        var t = String(
          (r && r.type) ||
            (r && r.income_expense && r.income_expense.type) ||
            ""
        ).toLowerCase();
        if (t.indexOf("exp") !== -1 || t.indexOf("खर्च") !== -1)
          return { kind: "expense", amount: a || d || c };
        if (t.indexOf("inc") !== -1 || t.indexOf("आम") !== -1)
          return { kind: "income", amount: a || c || d };
        return { kind: d >= c ? "expense" : "income", amount: Math.max(d, c) };
      }
      function clearTable() {
        document.getElementById("activities-tbody").innerHTML = "";
        recordsById = {};
      }

      function addRowToTable(data) {
        var tbody = document.getElementById("activities-tbody");
        var ka = pickKindAndAmount(data);
        var kind = ka.kind,
          amount = ka.amount;

        var ieId =
          data && data.income_expense_id != null
            ? data.income_expense_id
            : data && data.income_expense
            ? data.income_expense.id
            : null;
        recordsById[data.id] = Object.assign({}, data, {
          _kind: kind,
          _amt: amount,
          income_expense_id: ieId,
        });

        var title =
          data && data.title
            ? data.title
            : data && data.income_expense && data.income_expense.title
            ? data.income_expense.title
            : "—";
        var badge =
          kind === "income"
            ? '<span class="pill pill-income">आम्दानी</span>'
            : '<span class="pill pill-expense">खर्च</span>';
        var dt = new Date(data && data.date);
        var dateText = nepYMD(dt);

        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" +
          dateText +
          "</td>" +
          "<td>" +
          title +
          "</td>" +
          "<td>" +
          badge +
          "</td>" +
          '<td class="text-end">' +
          formatCurrency(amount) +
          "</td>" +
          "<td>" +
          ((data && (data.remark || data.remarks)) || "") +
          "</td>" +
          '<td class="text-end"><div class="actions">' +
          '<button class="btn-icon edit" data-id="' +
          data.id +
          '" title="सम्पादन"><i class="fas fa-pen"></i></button>' +
          '<button class="btn-icon delete" data-id="' +
          data.id +
          '" title="हटाउनुहोस्"><i class="fas fa-trash"></i></button>' +
          "</div></td>";
        tbody.appendChild(tr);
      }
      function setSummaryTotals(i, e) {
        totalIncome = i;
        totalExpense = e;
        updateTotals();
      }
      function updateTotals() {
        document.getElementById("total-income").textContent =
          formatCurrency(totalIncome);
        document.getElementById("total-expense").textContent =
          formatCurrency(totalExpense);
      }

      // newest first
      function renderTable(items) {
        const table = document.getElementById("activities-table");
        clearTable();
        const sorted = [...items].sort(
          (a, b) => new Date(b && b.date) - new Date(a && a.date)
        );
        sorted.forEach(addRowToTable);
        table.style.display = "table";
      }

      async function loadFinanceRecords() {
        const loading = document.getElementById("loading-activities");
        const emptyFull = document.getElementById("empty-full");
        const auth = document.getElementById("auth-error-message");
        const err = document.getElementById("activity-error");
        const table = document.getElementById("activities-table");
        const card = document.getElementById("activity-list");

        emptyFull.classList.remove("show");
        emptyFull.style.display = "none";
        card.style.display = "block";
        loading.style.display = "block";
        auth.style.display = "none";
        err.style.display = "none";
        table.style.display = "none";
        clearTable();

        if (!TOKEN) {
          loading.style.display = "none";
          auth.style.display = "block";
          return;
        }

        try {
          const res = await fetch(
            API + "/finance/site/" + SITE_ID + "/details?include_party=false",
            { headers: authHeader }
          );
          if (!res.ok) throw new Error("HTTP " + res.status);
          const data = await res.json();
          allItems =
            (data && (data.finance_records || data.records || data.data)) || [];
          loading.style.display = "none";

          if (allItems.length === 0) {
            card.style.display = "none";
            emptyFull.classList.add("show");
            emptyFull.style.display = "block";
            setSummaryTotals(0, 0);
            return;
          }

          let inc = 0,
            exp = 0;
          allItems.forEach((r) => {
            const k = pickKindAndAmount(r);
            if (k.kind === "income") inc += k.amount;
            else exp += k.amount;
          });
          overallTotals = { inc, exp };
          setSummaryTotals(inc, exp);

          renderTable(allItems);
        } catch (e) {
          loading.style.display = "none";
          err.style.display = "block";
        }
      }

      /* ---------- KEBAB ---------- */
      var sheet = document.getElementById("site-actions");
      document
        .getElementById("open-actions")
        .addEventListener("click", function (e) {
          e.preventDefault();
          sheet.classList.add("show");
          sheet.setAttribute("aria-hidden", "false");
        });
      sheet.addEventListener("click", function (e) {
        if (e.target === sheet) {
          sheet.classList.remove("show");
          sheet.setAttribute("aria-hidden", "true");
        }
      });
      document
        .getElementById("action-edit")
        .addEventListener("click", function () {
          location.href = "site-edit.html?id=" + encodeURIComponent(SITE_ID);
        });

      /* ---------- FILTER MODAL LOGIC (with persistent selection) ---------- */
      const filterModal = document.getElementById("filter-modal");
      const fStart = document.getElementById("f-start");
      const fEnd = document.getElementById("f-end");
      let currentPreset = "1m"; // default for this page session

      function setDateInputsEnabled(enabled) {
        fStart.disabled = !enabled;
        fEnd.disabled = !enabled;
        fStart.style.opacity = enabled ? "1" : ".6";
        fEnd.style.opacity = enabled ? "1" : ".6";
      }

      // green dot on active preset
      function markActivePreset(preset) {
        document.querySelectorAll(".preset-btn").forEach((b) => {
          const is = b.dataset.preset === preset;
          b.style.borderColor = is ? "#1ab189" : "#e5e7eb";
          b.style.background = is ? "#e7faf3" : "#fff";
          let dot = b.querySelector(".preset-dot");
          if (!dot) {
            dot = document.createElement("span");
            dot.className = "preset-dot";
            dot.style.cssText =
              "width:8px;height:8px;border-radius:50%;background:#1ab189;display:inline-block;margin-left:8px;";
            b.appendChild(dot);
          }
          dot.style.visibility = is ? "visible" : "hidden";
        });
      }

      function presetRange(preset) {
        const today = new Date();
        let start = null,
          end = today;
        if (preset === "7d") start = addDays(today, -6); // inclusive of today
        else if (preset === "15d") start = addDays(today, -14);
        else if (preset === "1m")
          start = new Date(today.getFullYear(), today.getMonth(), 1);
        else {
          start = new Date(fStart.value || today);
          end = new Date(fEnd.value || today);
        }
        return { start, end };
      }

      function syncFieldsToPreset(preset) {
        const rng = presetRange(preset);
        fStart.value = fmtDate(rng.start);
        fEnd.value = fmtDate(rng.end);
      }

      function openFilter() {
        // use the last selected preset (persisted for this session)
        syncFieldsToPreset(currentPreset);
        markActivePreset(currentPreset);
        setDateInputsEnabled(currentPreset === "custom");
        filterModal.classList.add("show");
        filterModal.setAttribute("aria-hidden", "false");
      }

      function applyPreset(preset) {
        currentPreset = preset; // persist selection until page refresh
        syncFieldsToPreset(currentPreset);
        markActivePreset(currentPreset);
        setDateInputsEnabled(currentPreset === "custom");
      }

      function doFilter() {
        const start = new Date(fStart.value),
          end = new Date(fEnd.value);
        const filtered = allItems.filter((r) => {
          const d = new Date(r && r.date);
          if (isNaN(d)) return false;
          return (
            d >=
              new Date(
                start.getFullYear(),
                start.getMonth(),
                start.getDate(),
                0,
                0,
                0
              ) &&
            d <=
              new Date(
                end.getFullYear(),
                end.getMonth(),
                end.getDate(),
                23,
                59,
                59
              )
          );
        });
        renderTable(filtered); // still newest → oldest
        setSummaryTotals(overallTotals.inc, overallTotals.exp); // summary remains overall
        filterModal.classList.remove("show");
        filterModal.setAttribute("aria-hidden", "true");
      }

      document
        .getElementById("filter-btn")
        .addEventListener("click", openFilter);
      document
        .getElementById("cancel-filter")
        .addEventListener("click", function () {
          filterModal.classList.remove("show");
          filterModal.setAttribute("aria-hidden", "true");
        });
      document
        .getElementById("apply-filter")
        .addEventListener("click", doFilter);
      document
        .getElementById("preset-opts")
        .addEventListener("click", function (e) {
          const b = e.target.closest(".preset-btn");
          if (!b) return;
          applyPreset(b.getAttribute("data-preset"));
        });
      filterModal.addEventListener("click", function (e) {
        if (e.target === filterModal) {
          filterModal.classList.remove("show");
          filterModal.setAttribute("aria-hidden", "true");
        }
      });

      /* ---------- MODALS (income/expense) ---------- */
      var incomeModal = document.getElementById("income-modal");
      var expenseModal = document.getElementById("expense-modal");
      var todayStr = new Date().toISOString().split("T")[0];

      document.getElementById("open-income-modal").onclick = function () {
        document.getElementById("income-form").reset();
        [
          "income-title-err",
          "income-amount-err",
          "income-date-err",
          "income-notes-err",
        ].forEach((id) => {
          var el = document.getElementById(id);
          if (el) el.textContent = "";
        });
        document.getElementById("income-date").value = todayStr;
        incomeModal.classList.add("show");
      };
      document.getElementById("open-expense-modal").onclick = function () {
        document.getElementById("expense-form").reset();
        [
          "expense-title-err",
          "expense-amount-err",
          "expense-date-err",
          "expense-notes-err",
        ].forEach((id) => {
          var el = document.getElementById(id);
          if (el) el.textContent = "";
        });
        document.getElementById("expense-date").value = todayStr;
        expenseModal.classList.add("show");
      };
      document.getElementById("close-income-modal").onclick = function () {
        incomeModal.classList.remove("show");
      };
      document.getElementById("close-expense-modal").onclick = function () {
        expenseModal.classList.remove("show");
      };
      incomeModal.addEventListener("click", (e) => {
        if (e.target === incomeModal) incomeModal.classList.remove("show");
      });
      expenseModal.addEventListener("click", (e) => {
        if (e.target === expenseModal) expenseModal.classList.remove("show");
      });

      // CREATE income
      document
        .getElementById("income-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          var title = document.getElementById("income-title").value;
          var amount =
            Number(document.getElementById("income-amount").value) || 0;
          var date = document.getElementById("income-date").value;
          var remark = document.getElementById("income-notes").value.trim();

          var ok = true;
          if (!title.trim()) {
            document.getElementById("income-title-err").textContent =
              "शीर्षक आवश्यक छ";
            ok = false;
          }
          if (!(amount > 0)) {
            document.getElementById("income-amount-err").textContent =
              "रकम आवश्यक छ";
            ok = false;
          }
          if (!date) {
            document.getElementById("income-date-err").textContent =
              "मिति आवश्यक छ";
            ok = false;
          }
          if (!ok) return;

          try {
            var ieRes = await fetch(API + "/income-expense", {
              method: "POST",
              headers: Object.assign({}, authHeader, {
                "Content-Type": "application/json",
              }),
              body: JSON.stringify({
                title: title.trim(),
                remarks: remark,
                type: "other",
              }),
            });
            var ie = await ieRes.json();
            if (!ieRes.ok || !(ie && ie.id))
              throw new Error((ie && ie.message) || "IE create failed");

            var finRes = await fetch(API + "/finance", {
              method: "POST",
              headers: Object.assign({}, authHeader, {
                "Content-Type": "application/json",
              }),
              body: JSON.stringify({
                site_id: Number(SITE_ID),
                debit: 0,
                credit: amount,
                remark: remark,
                date: date,
                income_expense_id: ie.id,
              }),
            });
            if (!finRes.ok) throw new Error("Finance create failed");

            incomeModal.classList.remove("show");
            await loadFinanceRecords();
            toast("आम्दानी सफलतापूर्वक थपियो", "success");
          } catch (err) {
            toast(err && err.message ? err.message : "सेभ असफल", "error");
          }
        });

      // CREATE expense
      document
        .getElementById("expense-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          var title = document.getElementById("expense-title").value;
          var amount =
            Number(document.getElementById("expense-amount").value) || 0;
          var date = document.getElementById("expense-date").value;
          var remark = document.getElementById("expense-notes").value.trim();

          var ok = true;
          if (!title.trim()) {
            document.getElementById("expense-title-err").textContent =
              "शीर्षक आवश्यक छ";
            ok = false;
          }
          if (!(amount > 0)) {
            document.getElementById("expense-amount-err").textContent =
              "रकम आवश्यक छ";
            ok = false;
          }
          if (!date) {
            document.getElementById("expense-date-err").textContent =
              "मिति आवश्यक छ";
            ok = false;
          }
          if (!ok) return;

          try {
            var ieRes = await fetch(API + "/income-expense", {
              method: "POST",
              headers: Object.assign({}, authHeader, {
                "Content-Type": "application/json",
              }),
              body: JSON.stringify({
                title: title.trim(),
                remarks: remark,
                type: "other",
              }),
            });
            var ie = await ieRes.json();
            if (!ieRes.ok || !(ie && ie.id))
              throw new Error((ie && ie.message) || "IE create failed");

            var finRes = await fetch(API + "/finance", {
              method: "POST",
              headers: Object.assign({}, authHeader, {
                "Content-Type": "application/json",
              }),
              body: JSON.stringify({
                site_id: Number(SITE_ID),
                debit: amount,
                credit: 0,
                remark: remark,
                date: date,
                income_expense_id: ie.id,
              }),
            });
            if (!finRes.ok) throw new Error("Finance create failed");

            expenseModal.classList.remove("show");
            await loadFinanceRecords();
            toast("खर्च सफलतापूर्वक थपियो", "success");
          } catch (err) {
            toast(err && err.message ? err.message : "सेभ असफल", "error");
          }
        });

      /* ---------- EDIT / DELETE ---------- */
      document
        .getElementById("activities-tbody")
        .addEventListener("click", function (e) {
          var btn = e.target.closest("button.btn-icon");
          if (!btn) return;
          var id = btn.getAttribute("data-id");
          var rec = recordsById[id];
          if (!rec) return;

          if (btn.classList.contains("edit")) {
            document.getElementById("fe-id").value = id;
            document.getElementById("fe-kind").value = rec._kind;
            document.getElementById("fe-ie-id").value =
              rec.income_expense && rec.income_expense.id
                ? rec.income_expense.id
                : rec.income_expense_id || "";
            document.getElementById("fe-title").value =
              rec.income_expense && rec.income_expense.title
                ? rec.income_expense.title
                : rec.title || "";
            document.getElementById("fe-amount").value = rec._amt || 0;
            document.getElementById("fe-date").value = String(
              rec.date || ""
            ).slice(0, 10);
            document.getElementById("fe-remark").value =
              rec.remark || rec.remarks || "";
            ["fe-title-err", "fe-amount-err", "fe-date-err"].forEach((id) => {
              var el = document.getElementById(id);
              if (el) el.textContent = "";
            });
            document.getElementById("finance-edit-modal").classList.add("show");
          } else if (btn.classList.contains("delete")) {
            var kind = rec._kind === "income" ? "income" : "expense";
            var fdTitle = document.getElementById("fd-title");
            var fdDesc = document.getElementById("fd-desc");
            var fdBtn = document.getElementById("fd-confirm");
            fdBtn.setAttribute("data-id", id);
            fdBtn.setAttribute("data-kind", kind);
            if (kind === "income") {
              fdTitle.textContent = "आम्दानी मेटाउने हो?";
              fdDesc.textContent =
                "के तपाईं यो आम्दानी रेकर्ड मेट्न पक्का हुनुहुन्छ?";
              fdBtn.textContent = "आम्दानी मेटाउनुहोस्";
            } else {
              fdTitle.textContent = "खर्च मेटाउने हो?";
              fdDesc.textContent =
                "के तपाईं यो खर्च रेकर्ड मेट्न पक्का हुनुहुन्छ?";
              fdBtn.textContent = "खर्च मेटाउनुहोस्";
            }
            document
              .getElementById("finance-delete-modal")
              .classList.add("show");
          }
        });
      document.getElementById("close-finance-edit").onclick = function () {
        document.getElementById("finance-edit-modal").classList.remove("show");
      };
      document.getElementById("fd-cancel").onclick = function () {
        document
          .getElementById("finance-delete-modal")
          .classList.remove("show");
      };
      ["finance-edit-modal", "finance-delete-modal"].forEach(function (id) {
        var el = document.getElementById(id);
        el.addEventListener("click", function (e) {
          if (e.target === el) el.classList.remove("show");
        });
      });

      // UPDATE
      document
        .getElementById("finance-edit-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          var id = document.getElementById("fe-id").value;
          var kind = document.getElementById("fe-kind").value;
          var ieId = document.getElementById("fe-ie-id").value;
          var title = document.getElementById("fe-title").value;
          var amount = Number(document.getElementById("fe-amount").value) || 0;
          var date = document.getElementById("fe-date").value;
          var remark = document.getElementById("fe-remark").value.trim();

          var ok = true;
          if (!title.trim()) {
            document.getElementById("fe-title-err").textContent =
              "शीर्षक आवश्यक छ";
            ok = false;
          }
          if (!(amount > 0)) {
            document.getElementById("fe-amount-err").textContent =
              "रकम आवश्यक छ";
            ok = false;
          }
          if (!date) {
            document.getElementById("fe-date-err").textContent =
              "मिति आवश्यक छ";
            ok = false;
          }
          if (!ok) return;

          try {
            if (ieId) {
              var ieRes = await fetch(API + "/income-expense/" + ieId, {
                method: "PUT",
                headers: Object.assign({}, authHeader, {
                  "Content-Type": "application/json",
                }),
                body: JSON.stringify({ title: title.trim(), remarks: remark }),
              });
              if (!ieRes.ok)
                throw new Error((await ieRes.text()) || "IE update failed");
            }

            var body = { date: date, remark: remark, title: title.trim() };
            if (kind === "income") {
              body.debit = 0;
              body.credit = amount;
            } else {
              body.debit = amount;
              body.credit = 0;
            }

            var fRes = await fetch(API + "/finance/" + id, {
              method: "PUT",
              headers: Object.assign({}, authHeader, {
                "Content-Type": "application/json",
              }),
              body: JSON.stringify(body),
            });
            if (!fRes.ok)
              throw new Error((await fRes.text()) || "Finance update failed");

            document
              .getElementById("finance-edit-modal")
              .classList.remove("show");
            toast("सम्पादन सफल भयो", "success");
            await loadFinanceRecords();
          } catch (err) {
            toast(err && err.message ? err.message : "अपडेट असफल", "error");
          }
        });

      // DELETE
      document
        .getElementById("fd-confirm")
        .addEventListener("click", async function () {
          var btn = document.getElementById("fd-confirm");
          var id = btn.getAttribute("data-id");
          var kind = btn.getAttribute("data-kind");
          if (!id) return;
          try {
            var res = await fetch(API + "/finance/" + id, {
              method: "DELETE",
              headers: authHeader,
            });
            if (!res.ok) {
              res = await fetch(API + "/finance/" + id, {
                method: "POST",
                headers: Object.assign({}, authHeader, {
                  "Content-Type": "application/json",
                }),
                body: JSON.stringify({ _method: "DELETE" }),
              });
            }
            if (!res.ok) throw new Error("HTTP " + res.status);
            document
              .getElementById("finance-delete-modal")
              .classList.remove("show");
            toast(
              kind === "income" ? "आम्दानी मेटाइयो" : "खर्च मेटाइयो",
              "success"
            );
            await loadFinanceRecords();
          } catch (err) {
            toast(
              kind === "income" ? "आम्दानी मेटाउन असफल" : "खर्च मेटाउन असफल",
              "error"
            );
          }
        });

      /* ---------- INIT ---------- */
      loadSiteInfo();
      loadFinanceRecords();

      bindNepaliAmountInput(document.getElementById("income-amount"));
      bindNepaliAmountInput(document.getElementById("expense-amount"));
      bindNepaliAmountInput(document.getElementById("fe-amount"));
    </script>

    <script>
      // Shared toast fallback
      window.toast =
        window.toast ||
        window.showToast ||
        function (msg, kind) {
          var t = document.getElementById("toast");
          if (!t) {
            t = document.createElement("div");
            t.id = "toast";
            document.body.appendChild(t);
          }
          t.innerHTML =
            '<span class="toast-badge ' +
            (kind === "error" ? "error" : "success") +
            '">' +
            (kind === "error" ? "✖" : "✓") +
            "</span>" +
            '<span class="toast-msg">' +
            (msg || "") +
            "</span>" +
            '<span class="toast-x" aria-label="Close">×</span>';
          t.classList.add("show");
          t.querySelector(".toast-x").onclick = function () {
            t.classList.remove("show");
          };
          clearTimeout(window.__tT);
          window.__tT = setTimeout(function () {
            t.classList.remove("show");
          }, 2000);
        };

      (function consumeCrossPageToast() {
        var kMsg = "toast_msg",
          kKind = "toast_kind";
        var msg = sessionStorage.getItem(kMsg);
        if (!msg) return;
        var kind = sessionStorage.getItem(kKind) || "success";
        function show() {
          toast(msg, kind);
          sessionStorage.removeItem(kMsg);
          sessionStorage.removeItem(kKind);
        }
        if (document.readyState === "loading")
          document.addEventListener("DOMContentLoaded", show);
        else setTimeout(show, 0);
      })();
    </script>

    <!-- Load shared bottom navbar and set "site" active -->
   <!-- Load shared bottom navbar and set "site" active (robust) -->
<script>
  (async function loadBottomNav() {
    try {
      const res = await fetch("bottom.html", { cache: "no-store" });
      if (!res.ok) throw new Error("nav load");
      const html = await res.text();
      const host = document.getElementById("bottom-nav-container");
      host.innerHTML = html;

      // Wait a tick in case the injected HTML has its own scripts/styles
      requestAnimationFrame(() => {
        const root = host; // search within injected container

        // Helper: try many options to find the "site" tab/button
        function findSiteEl() {
          const selectors = [
            '[data-page="site"]',
            '[data-nav="site"]',
            '[data-tab="site"]',
            '#nav-site',
            'a[href*="c-site-list"]',
            'a[href*="site"]',
            'button[href*="site"]',
            'a[data-route*="site"]',
            'button[data-route*="site"]'
          ];
          for (const sel of selectors) {
            const el = root.querySelector(sel);
            if (el) return el;
          }
          // Fallbacks: try by link text
          const candidates = root.querySelectorAll('a,button,li');
          for (const el of candidates) {
            const t = (el.textContent || "").trim().toLowerCase();
            if (t.includes("site") || t.includes("साइट")) return el;
          }
          return null;
        }

        function activate(el) {
          if (!el) return;
          // Clear any previous active states inside the nav
          root.querySelectorAll(".active, [aria-current='page']").forEach(x => {
            x.classList.remove("active");
            x.removeAttribute("aria-current");
          });
          // Set active on the target
          el.classList.add("active");
          el.setAttribute("aria-current", "page");
        }

        activate(findSiteEl());

        // Optional: keep active state when clicking tabs (single-page apps)
        root.addEventListener("click", (e) => {
          const link = e.target.closest("a,button");
          if (!link) return;
          // If user taps a “site” tab, mark active instantly
          const href = (link.getAttribute("href") || "") + (link.dataset.route || "");
          const dataKeys = [link.dataset.page, link.dataset.nav, link.dataset.tab].join("|");
          const text = (link.textContent || "").toLowerCase();
          if (/site/i.test(href) || /site/i.test(dataKeys) || /साइट/.test(text)) {
            activate(link);
          }
        });
      });
    } catch (e) {
      /* ignore if nav file missing */
    }
  })();
</script>

  </body>
</html>
