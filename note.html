<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>рдиреЛрдЯ рд╡рд┐рд╡рд░рдг / рд╕рдореНрдкрд╛рджрди</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="page-container">
    <header class="header">
        <a href="notelist.html" class="back-arrow">&#8592;</a>
        <h1 class="page-title" id="note-title">рдиреЛрдЯ</h1>
        <button id="delete-note" class="delete-button">
            <span class="delete-icon">ЁЯЧСя╕П</span> рдореЗрдЯрд╛рдЙрдиреБ
        </button>
    </header>
    <main class="content">
        <div class="input-group">
            <input type="text" id="note-title-input" class="note-input" placeholder="рд╢реАрд░реНрд╖рдХ рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН...">
        </div>

        <div class="note-card green-border">
            <textarea id="note-description" class="note-content-textarea" placeholder="рдиреЛрдЯрдХреЛ рд╡рд┐рд╡рд░рдг рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реН..."></textarea>
        </div>

        <p id="note-date" class="note-date"></p>

        <div class="priority-checkbox-group">
            <input type="checkbox" id="highPriority" class="custom-checkbox">
            <label for="highPriority" class="checkbox-label">рдЙрдЪреНрдЪ рдкреНрд░рд╛рдердорд┐рдХрддрд╛</label>
        </div>
    </main>
    <footer class="footer">
        <div class="action-buttons">
            <button id="save-note" class="save-button">рд╕реЗрдн рдЧрд░реНрдиреБрд╣реЛрд╕реН</button>
            <button id="cancel" class="cancel-button">рд░рджреНрдж рдЧрд░реНрдиреБрд╣реЛрд╕реН</button>
        </div>
    </footer>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal">
  <div class="modal-content">
    <p>рдиреЛрдЯ рдореЗрдЯрд╛рдЙрди рдЪрд╛рд╣рдиреБрд╣реБрдиреНрдЫ?</p>
    <div class="modal-actions">
      <button id="confirm-delete" class="delete-button-modal">рдореЗрдЯрд╛рдЙрдиреБрд╣реЛрд╕реН</button>
      <button id="cancel-delete" class="cancel-button-modal">рд░рджреНрдж рдЧрд░реНрдиреБрд╣реЛрд╕реН</button>
    </div>
  </div>
</div>


<script>
const API_BASE = "http://192.168.1.209:8000/api";
const NOTE_ID = new URLSearchParams(window.location.search).get("id");
const token = localStorage.getItem("auth_token");

if (!token) {
    alert("You are not logged in!");
    window.location.href = "login.html";
}

// Load note data
async function loadNote() {
    if (!NOTE_ID) return; // new note
    try {
        const res = await fetch(`${API_BASE}/notes/${NOTE_ID}`, {
            headers: { "Authorization": `Bearer ${token}`, "Accept": "application/json" }
        });
        if (!res.ok) throw new Error("рдиреЛрдЯ рд▓реЛрдб рдЧрд░реНрди рдЕрд╕рдлрд▓");

        const note = await res.json();

        document.getElementById("note-title").textContent = note.title || "рд╢реАрд░реНрд╖рдХ рдЫреИрди";
        document.getElementById("note-title-input").value = note.title || "";
        document.getElementById("note-description").value = note.description || "";
        document.getElementById("highPriority").checked = note.high_priority ?? false;

        document.getElementById("note-date").textContent = note.created_at
            ? `рдорд┐рддрд┐: ${new Date(note.created_at).toLocaleDateString('ne-NP')}`
            : "";
    } catch (err) {
        alert(err.message);
    }
}
// Save note
document.getElementById("save-note").addEventListener("click", async () => {
    const title = document.getElementById("note-title-input").value.trim();
    const description = document.getElementById("note-description").value.trim();
    const highPriority = document.getElementById("highPriority").checked;

    if (!title) {
        alert("рд╢реАрд░реНрд╖рдХ рдЖрд╡рд╢реНрдпрдХ рдЫ!");
        return;
    }

    try {
        const res = await fetch(
            NOTE_ID ? `${API_BASE}/notes/${NOTE_ID}` : `${API_BASE}/notes`,
            {
                method: NOTE_ID ? "PUT" : "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`,
                    "Accept": "application/json"
                },
                body: JSON.stringify({ title, description, high_priority: highPriority })
            }
        );

        if (!res.ok) {
            const errData = await res.json().catch(() => ({}));
            throw new Error(errData.message || "рдиреЛрдЯ рдмрдЪрд╛рдЙрди рдЕрд╕рдлрд▓");
        }

        alert(NOTE_ID ? "рдиреЛрдЯ рдЕрдкрдбреЗрдЯ рдЧрд░рд┐рдпреЛ!" : "рдиреЛрдЯ рдмрдиреНрдпреЛ!");
        // Redirect to notelist.html after save
        window.location.href = "notelist.html";

    } catch (err) {
        alert(err.message);
    }
});


// Cancel тЖТ back to list
document.getElementById("cancel").addEventListener("click", () => {
    window.location.href = "notelist.html";
});

// Delete note
// Show modal when clicking delete
const deleteBtn = document.getElementById("delete-note");
const deleteModal = document.getElementById("delete-modal");
const confirmDelete = document.getElementById("confirm-delete");
const cancelDelete = document.getElementById("cancel-delete");

deleteBtn.addEventListener("click", () => {
    deleteModal.style.display = "block";
});

// Cancel delete
cancelDelete.addEventListener("click", () => {
    deleteModal.style.display = "none";
});

// Confirm delete
confirmDelete.addEventListener("click", async () => {
    if (!NOTE_ID) return;

    const res = await fetch(`${API_BASE}/notes/${NOTE_ID}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
    });

    if (res.ok) {
        alert("рдиреЛрдЯ рдореЗрдЯрд╛рдЗрдпреЛ!");
        window.location.href = "notelist.html";
    } else {
        alert("рдиреЛрдЯ рдореЗрдЯрд╛рдЙрди рдЕрд╕рдлрд▓");
    }
});

// Close modal if clicking outside modal content
window.addEventListener("click", (e) => {
    if (e.target === deleteModal) {
        deleteModal.style.display = "none";
    }
});


loadNote();
</script>
</body>
</html>
