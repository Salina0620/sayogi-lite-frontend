<!DOCTYPE html>
<html lang="ne">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>साइटको जानकारी (सम्पादन)</title>

    <!-- Fonts / Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <style>
      :root {
        --brand-green:#13a87d;
        --cta-blue:#186b97;
        --red:#e74c3c;
        --bg:#fafafa;
        --surface:#fff;
        --border:#d0d5dd;
        --text:#0f172a;
        --muted:#667085;
        --safe-top:env(safe-area-inset-top,0px);
        --safe-bottom:env(safe-area-inset-bottom,0px);
        --safe-right:env(safe-area-inset-right,0px);
      }

      *{ box-sizing:border-box; }
      html,body{ margin:0; height:100%; }
      body{
        font-family:"Poppins", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        background:var(--surface); color:var(--text); overflow:hidden;
      }

      .page{ position:fixed; inset:0; display:flex; flex-direction:column; overflow:hidden; }

      /* Header */
      .header{ background:var(--brand-green); color:#fff; }
      .header-row{ display:flex; align-items:center; gap:8px; padding:calc(16px + var(--safe-top)) 16px 12px; }
      .back{ color:#fff; text-decoration:none; font-size:20px; }
      .title{ margin:0 auto; font-weight:500; font-size:18px; }

      /* Content */
      .content{ flex:1; overflow:auto; background:var(--bg); padding:16px 16px calc(18px + var(--safe-bottom)); }

      .field-label{ display:block; margin:10px 2px 6px; color:#555; font-size:14px; font-weight:500; }

      /* White fields */
      .form-control,.form-select{
        height:48px; padding:10px 12px; font-size:15px; color:var(--text);
        background:#fff; border:1.5px solid var(--border); border-radius:6px; outline:none; width:100%;
      }
      .form-control::placeholder{ color:#a3aab6; }
      .form-control:focus,.form-select:focus{ border-color:var(--brand-green); box-shadow:0 0 0 2px rgba(19,168,125,.18); }
      textarea.form-control{ min-height:96px; height:auto; }

      /* Owner row (fixed vertical alignment) */
      .input-row{ display:grid; grid-template-columns:auto 1fr; align-items:center; }
      .owner-group .input-group-text{
        display:flex; align-items:center; justify-content:center;
        background:#fff; color:#9ca3af; border:1.5px solid var(--border);
        border-right:0; border-radius:6px 0 0 6px; height:48px; padding:0 12px; line-height:1;
      }
      .owner-group .form-select{
        border:1.5px solid var(--border); border-left:0; background:#fff; border-radius:0 6px 6px 0;
      }

      /* Image box */
      .image-upload-box{
        width:100%; border:1.5px dashed var(--border); border-radius:8px;
        padding:14px; display:flex; flex-direction:column; align-items:center; gap:6px;
        color:#475467; background:#fff; cursor:pointer;
      }

      /* Hide the real file input (no Bootstrap here) */
      .visually-hidden-input{
        position:absolute !important;
        width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
        clip:rect(0 0 0 0); clip-path:inset(50%); border:0;
      }

      #imagePreview{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
      #imagePreview .thumb{
        position:relative; width:70px; height:70px; border:1px solid #e6e7ea; border-radius:8px; overflow:hidden; background:#fff; cursor:pointer;
      }
      #imagePreview .thumb img{ width:100%; height:100%; object-fit:cover; }
      #imagePreview .thumb .x{
        position:absolute; top:6px; right:6px; width:22px; height:22px; border-radius:50%;
        background:#fff; border:1px solid #d0d5dd; font-weight:900; font-size:14px; line-height:20px; text-align:center; color:#111; cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,.15);
      }

      /* Fullscreen viewer */
      .viewer{ position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index:9999; }
      .viewer img{ max-width:92vw; max-height:82vh; border-radius:10px; }
      .viewer .close{ position:absolute; top:14px; right:14px; color:#fff; font-size:32px; line-height:1; cursor:pointer; }
      .viewer .nav{ position:absolute; top:50%; transform:translateY(-50%); font-size:36px; color:#fff; cursor:pointer; user-select:none; }
      .viewer .prev{ left:14px; } .viewer .next{ right:14px; }
      .show{ display:flex !important; }

      /* Buttons */
      .btn{ height:48px; border:0; border-radius:12px; font-weight:700; font-size:16px; cursor:pointer; width:100%; }
      .btn-primary-action{ background:var(--cta-blue); color:#fff; }
      .btn-secondary-action{ background:var(--red); color:#fff; }
      .btn-secondary-action:hover{ background:#c0392b; }
      .btn-wrap{ display:grid; gap:12px; margin-top:16px; }

      /* Errors & toast */
      .err{ color:var(--red); font-size:12px; margin:4px 2px 0; min-height:14px; }
      .is-invalid{ border-color:var(--red) !important; box-shadow:0 0 0 2px rgba(231,76,60,.15) !important; }

      #toast{
        position:fixed; top:calc(12px + var(--safe-top)); right:calc(12px + var(--safe-right));
        background:#fff; border:0; border-radius:12px; padding:10px 14px 10px 10px; box-shadow:0 10px 24px rgba(0,0,0,.18);
        display:grid; grid-template-columns:32px 1fr 24px; align-items:center; gap:12px; width:max-content; max-width:92vw;
        transform:translateY(-8px); opacity:0; pointer-events:none; transition:.22s ease; z-index:10000;
      }
      #toast.show{ opacity:1; transform:translateY(0); pointer-events:auto; }
      .toast-badge{ width:28px; height:28px; border-radius:50%; display:grid; place-items:center; background:#74c69d; }
      .toast-badge.error{ background:#ef4444; }
      #toast svg{ width:18px; height:18px; stroke:#fff; stroke-width:3; fill:none; stroke-linecap:round; stroke-linejoin:round; }
      .toast-msg{ font-size:16px; font-weight:600; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      .toast-x{ color:#4b5563; font-size:18px; line-height:1; cursor:pointer; user-select:none; }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="header">
        <div class="header-row">
          <a class="back" href="javascript:history.back()"><i class="fas fa-chevron-left"></i></a>
          <h1 class="title">साइटको जानकारी</h1>
          <span style="width:20px"></span>
        </div>
      </header>

      <main class="content">
        <form id="siteForm" autocomplete="off" novalidate>
          <label class="field-label" for="name">साइटको नाम</label>
          <div class="mb-2">
            <input id="name" type="text" class="form-control" placeholder="रानीपोवा १०, रामको घर" />
            <small class="err" id="err-name"></small>
          </div>

          <label class="field-label" for="address">ठेगाना</label>
          <div class="mb-2">
            <input id="address" type="text" class="form-control" placeholder="रानीपोवा १०," />
            <small class="err" id="err-address"></small>
          </div>

          <label class="field-label" for="ownerSelect">घरधनी</label>
          <div class="owner-group mb-2">
            <div class="input-row">
              <span class="input-group-text"><i class="fas fa-user"></i></span>
              <select id="ownerSelect" class="form-select" required>
                <option value="" selected disabled>घरधनी छान्नुहोस्…</option>
              </select>
            </div>
            <input type="hidden" id="ownerId" />
          </div>
          <small class="err" id="err-owner"></small>

          <label class="field-label" for="start_date">सुरु मिति</label>
          <div class="mb-2">
            <input id="start_date" type="date" class="form-control" />
            <small class="err" id="err-start"></small>
          </div>

          <label class="field-label" for="end_date">समाप्ति मिति</label>
          <div class="mb-2">
            <input id="end_date" type="date" class="form-control" />
            <small class="err" id="err-end"></small>
          </div>

          <label class="field-label" for="budget">अनुमानित बजेट</label>
          <div class="mb-2">
            <input id="budget" type="text" class="form-control" inputmode="numeric" placeholder="८० लाख रुपैयाँ" />
            <small class="err" id="err-budget"></small>
          </div>

          <label class="field-label" for="description">विवरण</label>
          <div class="mb-2">
            <textarea id="description" class="form-control" placeholder="विवरण लेख्नुहोस्..." rows="3"></textarea>
            <small class="err" id="err-description"></small>
          </div>

          <h5 style="font-size:15px; font-weight:400; margin:14px 2px 8px;">साइट कागजातहरू</h5>
          <label for="filePicker" class="image-upload-box">
            <i class="fas fa-image"></i><span>फोटो हाल्नुहोस्</span>
          </label>
          <!-- Hidden real file input (no native bar) -->
          <input id="filePicker" type="file" accept="image/*" multiple class="visually-hidden-input" />
          <div id="imagePreview"></div>
          <small class="err" id="photoError"></small>

          <label class="field-label" for="status">स्थिति</label>
          <div class="mb-2">
            <select id="status" class="form-select" required>
              <option value="ongoing">प्रगतिमा</option>
              <option value="completed">सम्पन्न</option>
            </select>
            <small class="err" id="err-status"></small>
          </div>

          <div class="btn-wrap mt-4">
            <button id="save" type="button" class="btn btn-primary-action">अपडेट गर्नुहोस्</button>
            <button id="cancel" type="button" class="btn btn-secondary-action">रद्द गर्नुहोस्</button>
          </div>
        </form>
      </main>
    </div>

    <!-- Fullscreen viewer -->
    <div id="viewer" class="viewer" role="dialog" aria-modal="true">
      <span id="viewerClose" class="close">&times;</span>
      <span id="viewerPrev" class="nav prev">&#10094;</span>
      <img id="viewerImg" alt="Preview" />
      <span id="viewerNext" class="nav next">&#10095;</span>
    </div>

    <!-- Toast -->
    <div id="toast" role="status" aria-live="polite"></div>

    <script>
      /* ===== Toast ===== */
      function showToast(msg, kind = "success") {
        const t = document.getElementById("toast");
        const icon =
          kind === "error"
            ? `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12"/></svg>`
            : `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6L9 17l-5-5"/></svg>`;
        t.innerHTML = `
          <span class="toast-badge ${kind === "error" ? "error" : ""}">${icon}</span>
          <span class="toast-msg">${msg || ""}</span>
          <span class="toast-x" aria-label="Close">×</span>
        `;
        t.classList.add("show");
        t.querySelector(".toast-x").onclick = () => t.classList.remove("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => t.classList.remove("show"), 2000);
      }

      /* ===== Config & auth ===== */
      const API = "http://192.168.1.209:8000/api";
      const API_BASE = API.replace(/\/api\/?$/, "");
      const MAX_IMAGES = 5;

      const rawToken = localStorage.getItem("auth_token") || "";
      const TOKEN = rawToken.includes("|") ? rawToken.split("|")[1] : rawToken;
      if (!TOKEN){ showToast("कृपया लगइन गर्नुहोस्।","error"); location.href="login.html"; }

      const headers = { Authorization:"Bearer "+TOKEN, Accept:"application/json" };

      const qs = new URLSearchParams(location.search);
      const SITE_ID = qs.get("id");
      if (!SITE_ID){ showToast("साइट ID हरायो।","error"); location.href="c-site-list.html"; }

      /* ===== DOM refs ===== */
      const ownerSelect = document.getElementById("ownerSelect");
      const ownerIdInput = document.getElementById("ownerId");
      const nameEl = document.getElementById("name");
      const addressEl = document.getElementById("address");
      const startEl = document.getElementById("start_date");
      const endEl = document.getElementById("end_date");
      const budgetEl = document.getElementById("budget");
      const descEl = document.getElementById("description");
      const statusEl = document.getElementById("status");

      const errName = document.getElementById("err-name");
      const errOwner = document.getElementById("err-owner");
      const errStart = document.getElementById("err-start");
      const errEnd = document.getElementById("err-end");
      const errBudget = document.getElementById("err-budget");
      const errStatus = document.getElementById("err-status");

      const picker = document.getElementById("filePicker");
      const preview = document.getElementById("imagePreview");
      const photoError = document.getElementById("photoError");

      const viewer = document.getElementById("viewer");
      const viewerImg = document.getElementById("viewerImg");
      const viewerPrev = document.getElementById("viewerPrev");
      const viewerNext = document.getElementById("viewerNext");
      const viewerClose = document.getElementById("viewerClose");

      /* ===== Helpers ===== */
      const NP="०१२३४५६७८९", EN="0123456789";
      const toEn = (s) => String(s||"").replace(/[०-९]/g, d => EN[NP.indexOf(d)]);
      const toNp = (s) => String(s||"").replace(/\d/g, d => NP[d]);
      const onlyDigits = (s) => String(s||"").replace(/[^\d]/g,"");

      function setErr(el, msg, input){ el.textContent = msg || ""; if(input){ input.classList.toggle("is-invalid", !!msg); } }
      function clearAllErr(){
        [nameEl, ownerSelect, startEl, endEl, budgetEl, statusEl].forEach(i=> i.classList.remove("is-invalid"));
        [errName, errOwner, errStart, errEnd, errBudget, errStatus].forEach(e=> e.textContent="");
      }

      /* ===== Owners ===== */
      let owners = [];
      async function fetchOwners(){
        try{ const res = await fetch(`${API}/owners`, { headers }); if(res.ok) owners = await res.json(); }catch(e){ console.error(e); }
        renderOwnerOptions(owners);
      }
      function renderOwnerOptions(list){
        ownerSelect.innerHTML = '<option value="" disabled selected>घरधनी छान्नुहोस्…</option>' +
          (list||[]).map(o=>`<option value="${o.id}">${o.name || "(No name)"}</option>`).join("");
        if (ownerIdInput.value) ownerSelect.value = ownerIdInput.value;
        ownerSelect.classList.toggle("has-value", !!ownerSelect.value);
      }
      ownerSelect.addEventListener("change", ()=>{
        ownerIdInput.value = ownerSelect.value || "";
        ownerSelect.classList.toggle("has-value", !!ownerSelect.value);
        setErr(errOwner,"",ownerSelect);
      });

      /* ===== Images / viewer ===== */
      let images = []; // {kind:"server"|"local", src, file?, rel?}
      let initialServerUrls = [];

      function renderThumbs(){
        preview.innerHTML = "";
        images.forEach((it, idx)=>{
          const t = document.createElement("div");
          t.className = "thumb";
          t.innerHTML = `<img src="${it.src}" alt="photo"><button type="button" class="x">&times;</button>`;
          t.querySelector(".x").onclick = (e)=>{ e.stopPropagation(); removeImage(idx); };
          t.onclick = ()=> openViewer(idx);
          preview.appendChild(t);
        });
      }
      function removeImage(i){ images.splice(i,1); renderThumbs(); photoError.textContent=""; }
      function addFiles(fileList){
        const MAX = 5;
        const files = Array.from(fileList || []);
        const remaining = MAX - images.length;
        if (remaining <= 0){ photoError.textContent = `अधिकतम ${MAX} तस्वीर मात्र चयन गर्न सकिन्छ।`; return; }
        const use = files.slice(0, remaining);
        const readers = use.map(f => new Promise(res => { const r=new FileReader(); r.onload=()=>res({src:r.result,kind:"local",file:f}); r.readAsDataURL(f); }));
        Promise.all(readers).then(list => { images = images.concat(list); renderThumbs(); });
      }
      picker.addEventListener("change", (e)=> addFiles(e.target.files));

      let viewerIndex = 0;
      function openViewer(i){ if(!images.length) return; viewerIndex=i; viewerImg.src=images[i].src; viewer.classList.add("show"); }
      function closeViewer(){ viewer.classList.remove("show"); }
      function nav(d){ if(!images.length) return; viewerIndex=(viewerIndex+d+images.length)%images.length; viewerImg.src=images[viewerIndex].src; }
      viewerPrev.onclick = ()=> nav(-1);
      viewerNext.onclick = ()=> nav(+1);
      viewerClose.onclick = closeViewer;
      viewer.addEventListener("click", (e)=>{ if(e.target===viewer) closeViewer(); });
      document.addEventListener("keydown", (e)=>{ if(!viewer.classList.contains("show")) return; if(e.key==="Escape") closeViewer(); if(e.key==="ArrowLeft") nav(-1); if(e.key==="ArrowRight") nav(+1); });

      function imagesChanged(){
        const currentServer = images.filter(i=>i.kind==="server").map(i=>i.src);
        const locals = images.filter(i=>i.kind==="local").length;
        const removed = initialServerUrls.filter(u => !currentServer.includes(u)).length;
        return locals>0 || removed>0;
      }
      function absStorageUrl(u){
        if (!u) return "";
        if (/^https?:\/\//i.test(u)) return u;
        if (u.startsWith("/")) return API_BASE + u;
        if (u.startsWith("storage/")) return API_BASE + "/" + u;
        return API_BASE + "/storage/" + u.replace(/^\/?storage\//,"");
      }

      /* ===== Load existing site ===== */
      function extractServerImages(site){
        let urls = Array.isArray(site.images_urls) && site.images_urls.length ? site.images_urls : (Array.isArray(site.images) ? site.images : []);
        return urls.slice(0, MAX_IMAGES).map(absStorageUrl);
      }
      async function loadSite(){
        try{
          const res = await fetch(`${API}/sites/${SITE_ID}`, { headers });
          if (!res.ok) throw new Error();
          const site = await res.json();

          nameEl.value = site.name || "";
          addressEl.value = site.address || "";
          startEl.value = (site.start_date||"").slice(0,10);
          endEl.value   = (site.end_date||"").slice(0,10);
          budgetEl.value = toNp(String(site.estimated_budget ?? ""));
          descEl.value = site.description || "";
          statusEl.value = site.status || "ongoing";

          const oid = site.owner_id || site.owner?.id || "";
          ownerIdInput.value = oid ? String(oid) : "";
          renderOwnerOptions(owners);

          const rels = Array.isArray(site.images) ? site.images : [];
          const urls = extractServerImages(site);
          initialServerUrls = urls.slice();
          images = urls.map((u,i)=>({ src:u, kind:"server", rel:rels[i] || null }));
          renderThumbs();
        }catch(_){
          images = []; renderThumbs();
        }
      }

      /* ===== Validation & save ===== */
      function validateForm(){
        clearAllErr();
        let ok = true;

        if(!nameEl.value.trim()){
          setErr(errName,"साइटको नाम आवश्यक छ।", nameEl); ok = false;
        }
        if(!ownerSelect.value){
          setErr(errOwner,"घरधनी छान्नुहोस्।", ownerSelect); ok = false;
        }

        const s = startEl.value ? new Date(startEl.value) : null;
        const e = endEl.value ? new Date(endEl.value) : null;
        if(s && e && e < s){
          setErr(errEnd,"समाप्ति मिति सुरु मितिभन्दा पछाडि हुनुपर्छ।", endEl);
          ok = false;
        }

        if(budgetEl.value.trim()){
          const en = onlyDigits(toEn(budgetEl.value));
          if(!en){ setErr(errBudget,"मान्य रकम लेख्नुहोस्।", budgetEl); ok = false; }
        }
        if(!statusEl.value){
          setErr(errStatus,"स्थिति छान्नुहोस्।", statusEl); ok = false;
        }
        return ok;
      }

      function buildScalarPayload(){
        const budgetEn = onlyDigits(toEn(budgetEl.value));
        return {
          name: nameEl.value.trim(),
          address: addressEl.value.trim(),
          owner_id: ownerSelect.value || null,
          start_date: startEl.value || null,
          end_date: endEl.value || null,
          estimated_budget: budgetEn ? String(budgetEn) : null,
          description: descEl.value.trim(),
          status: statusEl.value || "ongoing",
        };
      }

      async function saveDetails(){
        if(!validateForm()){ showToast("कृपया फारम ठीक मिलाउनुहोस्।","error"); return; }
        const payload = buildScalarPayload();

        // 1) Update scalar fields
        let res, ok=false, data=null;
        try{
          res = await fetch(`${API}/sites/${SITE_ID}`, {
            method:"PATCH", headers:{ ...headers, "Content-Type":"application/json" }, body: JSON.stringify(payload)
          });
          if (!res.ok){
            res = await fetch(`${API}/sites/${SITE_ID}`, {
              method:"POST", headers:{ ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ ...payload, _method:"PUT" })
            });
          }
          data = await res.json().catch(()=> ({}));
          ok = res.ok;
        }catch(_){ ok = false; }

        if (!ok){
          if (res && res.status === 422 && data?.errors){
            if (data.errors.name) setErr(errName, String(data.errors.name[0]||data.errors.name), nameEl);
            if (data.errors.owner_id) setErr(errOwner, String(data.errors.owner_id[0]||data.errors.owner_id), ownerSelect);
            if (data.errors.start_date) setErr(errStart, String(data.errors.start_date[0]||data.errors.start_date), startEl);
            if (data.errors.end_date) setErr(errEnd, String(data.errors.end_date[0]||data.errors.end_date), endEl);
            if (data.errors.estimated_budget) setErr(errBudget, String(data.errors.estimated_budget[0]||data.errors.estimated_budget), budgetEl);
            if (data.errors.status) setErr(errStatus, String(data.errors.status[0]||data.errors.status), statusEl);
            showToast("त्रुटि भेटियो, कृपया सच्याउनुहोस्।","error");
          } else {
            showToast(data?.message || "अपडेट असफल भयो।","error");
          }
          return;
        }

        // 2) Photos if changed
        if (imagesChanged()){
          try{
            const form = new FormData();
            Object.entries(payload).forEach(([k,v])=> { if(v!==undefined && v!==null) form.append(k, v); });
            const keepRel = images.filter(it => it.kind==="server" && it.rel).map(it => it.rel);
            keepRel.forEach(p => form.append("keep_images[]", p));
            for(const it of images){ if(it.kind==="local" && it.file) form.append("images[]", it.file); }
            form.append("_method","PUT");

            const res2 = await fetch(`${API}/sites/${SITE_ID}`, {
              method:"POST", headers:{ Authorization: headers.Authorization, Accept: headers.Accept }, body: form
            });
            if(!res2.ok) throw new Error("Image update failed");
          }catch(e){
            console.error(e); showToast("फोटो अपडेट गर्दा समस्या भयो।","error"); return;
          }
        }

        // Success
        sessionStorage.setItem("toast_msg", "साइट सफलतापूर्वक अपडेट भयो");
        sessionStorage.setItem("toast_kind", "success");
        history.back();
      }

      // Budget input filter
      budgetEl.addEventListener("input", (e)=>{
        e.target.value = e.target.value.replace(/[^\d०-९\u0900-\u097F\s,.\-]/g,"");
        setErr(errBudget,"", budgetEl);
      });

      document.getElementById("save").addEventListener("click", saveDetails);
      document.getElementById("cancel").addEventListener("click", ()=> history.back());

      /* Init */
      (async function init(){
        await fetchOwners();
        await loadSite();
      })();
    </script>
  </body>
</html>
