<!DOCTYPE html>
<html lang="ne">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>‡§∏‡§æ‡§á‡§ü‡§ï‡•ã ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet" />

    <style>
      :root{
        --green:#13a87d; --blue:#186b97; --red:#e2544b;
        --border:#e5e7eb; --text:#0f172a; --muted:#667085;
        --safe-top:env(safe-area-inset-top,0px); --safe-bottom:env(safe-area-inset-bottom,0px);
      }
      *{ box-sizing:border-box; }
      html,body{ margin:0; height:100%; }
      body{
        -webkit-font-smoothing:antialiased;
        font-family:"Noto Sans Devanagari",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        background:#fff; color:var(--text); overflow:hidden;
      }

      .page{ position:fixed; inset:0; display:flex; flex-direction:column; overflow:hidden; }

      /* Header */
      .header{
        background:var(--green); color:#fff; display:flex; align-items:center; gap:10px;
        padding:calc(14px + var(--safe-top)) 16px 14px;
      }
      .back{ color:#fff; text-decoration:none; font-size:22px; line-height:1; padding:10px 12px; border-radius:12px; }
      .title{ margin:0; flex:1; text-align:center; font-weight:700; font-size:20px; transform:translateX(-12px); }

      /* Content */
      .content{ flex:1 1 auto; min-height:0; overflow:auto; background:#f8fafb; padding:16px 16px calc(16px + var(--safe-bottom)); }
      .vstack{ display:flex; flex-direction:column; gap:16px; }

      label{ font-weight:700; font-size:14px; margin:0 0 6px; color:#374151; }
      .input,.textarea,.select{
        width:100%; border:1.5px solid var(--border); border-radius:0; padding:12px 14px; font-size:15px; background:#f8fafc; outline:none;
      }
      .input:focus,.textarea:focus,.select:focus{ border-color:var(--green); box-shadow:0 0 0 2px rgba(19,168,125,.18); }
      .textarea{ min-height:96px; resize:vertical; background:#fff; }
      .select{ appearance:none; background:#f8fafc; }

      /* Owner row */
      .owner-row{ display:grid; grid-template-columns:auto 1fr; gap:0; }
      .owner-icon{ display:inline-flex; align-items:center; padding:0 12px; border:1.5px solid var(--border); border-right:0; background:#f8fafc; }
      .owner-select{ border-left:0; border-right:0; border-radius:0; height:48px; }

      /* Photos */
      .photos-field{ display:flex; flex-direction:column; gap:10px; }
      .photos-title{ display:flex; align-items:baseline; gap:8px; }
      .count{ font-size:12px; color:var(--muted); font-weight:700; }
      .photos-drop{
        width:100%; border:1.5px dashed #d0d5dd; border-radius:8px; background:#fff; padding:14px; cursor:pointer;
        display:flex; align-items:center; justify-content:center; gap:10px; color:#475467; font-weight:700;
      }
      .photos-drop:focus-visible{ outline:2px solid rgba(26,177,137,.25); outline-offset:2px; }
      .plus{ display:inline-grid; place-items:center; width:28px; height:28px; border-radius:8px; border:1px solid #cfd6df; background:#fff; font-size:18px; line-height:1; }

      .thumbs{ display:grid; grid-template-columns:repeat(3,1fr); gap:8px; }
      .thumb{ position:relative; width:100%; padding-top:100%; border:1px solid #e6e7ea; border-radius:10px; overflow:hidden; background:#fff; }
      .thumb>img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
      .thumb .x{
        position:absolute; top:6px; right:6px; width:22px; height:22px; border-radius:50%; background:#fff; color:#111;
        border:1px solid #d0d5dd; font-weight:900; font-size:14px; line-height:20px; text-align:center; cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,.15);
      }

      /* Fullscreen viewer */
      .viewer{ position:fixed; inset:0; background:rgba(0,0,0,.85); display:none; align-items:center; justify-content:center; z-index:9999; }
      .viewer img{ max-width:92vw; max-height:82vh; border-radius:10px; }
      .viewer .close{ position:absolute; top:14px; right:14px; color:#fff; font-size:32px; line-height:1; cursor:pointer; }
      .viewer .nav{ position:absolute; top:50%; transform:translateY(-50%); font-size:36px; color:#fff; cursor:pointer; user-select:none; }
      .viewer .prev{ left:14px; } .viewer .next{ right:14px; }
      .show{ display:flex !important; }

      /* Bottom actions */
      .actions{ position:sticky; bottom:0; background:#fff; padding:14px 0 0; }
      .btn-row{ display:grid; gap:12px; padding:0 16px 16px; }
      .btn{ height:52px; border:0; border-radius:12px; font-weight:700; font-size:16px; cursor:pointer; }
      .btn-primary{ background:#1f6790; color:#fff; }
      .btn-danger{ background:var(--red); color:#fff; }

      /* Inline errors */
      .err{ color:#dc2626; font-size:12px; min-height:14px; margin:4px 0 2px; }
      .is-invalid{ border-color:#dc2626 !important; box-shadow:0 0 0 2px rgba(220,38,38,.12); }

      /* === Toast (same look as create) === */
      #toast {
        position: fixed;
        top: calc(12px + env(safe-area-inset-top));
        right: calc(12px + env(safe-area-inset-right));
        background: #ffffff;
        border: 0;
        border-radius: 12px;
        padding: 10px 14px 10px 10px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
        display: grid;
        grid-template-columns: 32px 1fr 24px;
        align-items: center;
        gap: 12px;
        width: max-content;
        max-width: 92vw;
        transform: translateY(-8px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.22s ease, transform 0.22s ease;
        z-index: 10000;
      }
      #toast.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
      .toast-badge {
        width: 28px; height: 28px; border-radius: 50%; display: grid; place-items: center; background: #74c69d;
      }
      .toast-badge.error { background:#ef4444; }
      .toast-badge svg { width:18px; height:18px; stroke:#fff; stroke-width:3; fill:none; stroke-linecap:round; stroke-linejoin:round; }
      .toast-msg { font-size:16px; font-weight:600; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; letter-spacing:0; }
      .toast-x { color:#4b5563; font-size:18px; line-height:1; cursor:pointer; user-select:none; }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="header">
        <a class="back" href="javascript:history.back()" aria-label="‡§™‡§õ‡§æ‡§°‡§ø">&#8592;</a>
        <h1 class="title">‡§∏‡§æ‡§á‡§ü‡§ï‡•ã ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h1>
      </header>

      <main class="content">
        <form id="siteForm" class="vstack" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
          <!-- 1. ‡§∏‡§æ‡§á‡§ü‡§ï‡•ã ‡§®‡§æ‡§Æ -->
          <div>
            <label for="name">‡§∏‡§æ‡§á‡§ü‡§ï‡•ã ‡§®‡§æ‡§Æ</label>
            <input id="name" class="input" placeholder="‡§∞‡§æ‡§®‡•Ä‡§™‡•ã‡§µ‡§æ ‡•ß‡•¶, ‡§∞‡§æ‡§Æ‡§ï‡•ã ‡§ò‡§∞"
              autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
            <div class="err" id="err-name"></div>
          </div>

          <!-- 2. ‡§†‡•á‡§ó‡§æ‡§®‡§æ -->
          <div>
            <label for="address">‡§†‡•á‡§ó‡§æ‡§®‡§æ</label>
            <input id="address" class="input" placeholder="‡§∞‡§æ‡§®‡•Ä‡§™‡•ã‡§µ‡§æ ‡•ß‡•¶,"
              autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
            <div class="err" id="err-address"></div>
          </div>

          <!-- 3. ‡§ò‡§∞‡§ß‡§®‡•Ä -->
          <div>
            <label for="ownerSelect">‡§ò‡§∞‡§ß‡§®‡•Ä</label>
            <div class="owner-row">
              <span class="owner-icon">üë§</span>
              <select id="ownerSelect" class="select owner-select" required
                autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
                <option value="" selected disabled>‡§ò‡§∞‡§ß‡§®‡•Ä ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‚Ä¶</option>
              </select>
            </div>
            <input type="hidden" id="ownerId" />
            <div class="err" id="err-owner"></div>
          </div>

          <!-- 4. ‡§∏‡•Å‡§∞‡•Å ‡§Æ‡§ø‡§§‡§ø -->
          <div>
            <label for="start_date">‡§∏‡•Å‡§∞‡•Å ‡§Æ‡§ø‡§§‡§ø</label>
            <input id="start_date" type="date" class="input"
              autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
            <div class="err" id="err-start"></div>
          </div>

          <!-- 5. ‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø -->
          <div>
            <label for="end_date">‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø</label>
            <input id="end_date" type="date" class="input"
              autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
            <div class="err" id="err-end"></div>
          </div>

          <!-- 6. ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§¨‡§ú‡•á‡§ü -->
          <div>
            <label for="budget">‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§¨‡§ú‡•á‡§ü</label>
            <input id="budget" class="input" placeholder="‡•Æ‡•¶ ‡§≤‡§æ‡§ñ ‡§∞‡•Å‡§™‡•à‡§Ø‡§æ‡§Å" inputmode="numeric"
              autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
            <div class="err" id="err-budget"></div>
          </div>

          <!-- 7. ‡§µ‡§ø‡§µ‡§∞‡§£ -->
          <div>
            <label for="description">‡§µ‡§ø‡§µ‡§∞‡§£</label>
            <textarea id="description" class="textarea" placeholder="‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç..."
              autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"></textarea>
            <div class="err" id="err-description"></div>
          </div>

          <!-- 8. ‡§∏‡§æ‡§á‡§ü ‡§ï‡§æ‡§ó‡§ú‡§æ‡§§‡§π‡§∞‡•Ç (‡§´‡•ã‡§ü‡•ã) -->
          <div class="photos-field">
            <div class="photos-title">
              <label>‡§∏‡§æ‡§á‡§ü ‡§ï‡§æ‡§ó‡§ú‡§æ‡§§‡§π‡§∞‡•Ç (‡§´‡•ã‡§ü‡•ã)</label>
              <span id="photoCount" class="count">0/5</span>
            </div>
            <span id="photoError" class="err" style="margin-top:0"></span>

            <button id="photosDrop" type="button" class="photos-drop" aria-label="‡§´‡•ã‡§ü‡•ã ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç">
              <span class="plus">Ôºã</span><span>‡§´‡•ã‡§ü‡•ã ‡§π‡§æ‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</span>
            </button>
            <input id="filePicker" type="file" accept="image/*" multiple hidden />
            <div id="thumbs" class="thumbs"></div>
          </div>

          <!-- 9. ‡§∏‡•ç‡§•‡§ø‡§§‡§ø -->
          <div>
            <label for="status">‡§∏‡•ç‡§•‡§ø‡§§‡§ø</label>
            <select id="status" class="select" required
              autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
              <option value="ongoing">‡§™‡•ç‡§∞‡§ó‡§§‡§ø‡§Æ‡§æ</option>
              <option value="completed">‡§∏‡§Æ‡•ç‡§™‡§®‡•ç‡§®</option>
            </select>
            <div class="err" id="err-status"></div>
          </div>
        </form>
      </main>

      <div class="actions">
        <div class="btn-row">
          <button id="save" class="btn btn-primary" type="button">‡§Ö‡§™‡§°‡•á‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
          <button id="delete" class="btn btn-danger" type="button">‡§°‡§ø‡§≤‡§ø‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
        </div>
      </div>
    </div>

    <!-- Fullscreen viewer -->
    <div id="viewer" class="viewer" role="dialog" aria-modal="true">
      <span id="viewerClose" class="close">&times;</span>
      <span id="viewerPrev" class="nav prev">&#10094;</span>
      <img id="viewerImg" alt="Preview" />
      <span id="viewerNext" class="nav next">&#10095;</span>
    </div>

    <!-- Toast host -->
    <div id="toast" role="status" aria-live="polite"></div>

    <script>
      /* ===== Toast (same behavior as create) ===== */
      function showToast(msg, kind = "success") {
        const t = document.getElementById("toast");
        const icon =
          kind === "error"
            ? `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12"/></svg>`
            : `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6L9 17l-5-5"/></svg>`;
        t.innerHTML = `
          <span class="toast-badge ${kind === "error" ? "error" : ""}">${icon}</span>
          <span class="toast-msg">${msg || ""}</span>
          <span class="toast-x" aria-label="Close">√ó</span>
        `;
        t.classList.add("show");
        t.querySelector(".toast-x").onclick = () => t.classList.remove("show");
        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => t.classList.remove("show"), 2000);
      }

      /* ===== Config & auth ===== */
      const API = "http://192.168.1.209:8000/api";
      const API_BASE = API.replace(/\/api\/?$/, "");
      const MAX_IMAGES = 5;

      const raw = localStorage.getItem("auth_token") || "";
      const TOKEN = raw.includes("|") ? raw.split("|")[1] : raw;
      if (!TOKEN){ showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ó‡§á‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§","error"); location.href="login.html"; }

      const qs = new URLSearchParams(location.search);
      const SITE_ID = qs.get("id");
      if (!SITE_ID){ showToast("‡§∏‡§æ‡§á‡§ü ID ‡§π‡§∞‡§æ‡§Ø‡•ã‡•§","error"); location.href="c-site-list.html"; }

      const headers = { Authorization:"Bearer "+TOKEN, Accept:"application/json" };

      /* ===== DOM ===== */
      const ownerSelect  = document.getElementById("ownerSelect");
      const ownerIdInput = document.getElementById("ownerId");

      const thumbsEl   = document.getElementById("thumbs");
      const dropBtn    = document.getElementById("photosDrop");
      const picker     = document.getElementById("filePicker");
      const photoCount = document.getElementById("photoCount");
      const errorSpan  = document.getElementById("photoError");

      const viewer = document.getElementById("viewer");
      const viewerImg = document.getElementById("viewerImg");
      const viewerPrev = document.getElementById("viewerPrev");
      const viewerNext = document.getElementById("viewerNext");
      const viewerClose = document.getElementById("viewerClose");

      const form = document.getElementById("siteForm");
      const nameEl = document.getElementById("name");
      const addressEl = document.getElementById("address");
      const startEl = document.getElementById("start_date");
      const endEl = document.getElementById("end_date");
      const budgetEl = document.getElementById("budget");
      const descEl = document.getElementById("description");
      const statusEl = document.getElementById("status");

      const errName = document.getElementById("err-name");
      const errOwner = document.getElementById("err-owner");
      const errStart = document.getElementById("err-start");
      const errEnd = document.getElementById("err-end");
      const errBudget = document.getElementById("err-budget");
      const errStatus = document.getElementById("err-status");

      /* ===== Helpers ===== */
      const setVal = (id,v)=>{ const el=document.getElementById(id); if(el) el.value=v??""; };
      const val = id => (document.getElementById(id)?.value ?? "").trim();

      // Nepali/English digit helpers
      const NP="‡•¶‡•ß‡•®‡•©‡•™‡•´‡•¨‡•≠‡•Æ‡•Ø", EN="0123456789";
      const toEn = (s) => String(s||"").replace(/[‡•¶-‡•Ø]/g, d => EN[NP.indexOf(d)]);
      const toNp = (s) => String(s||"").replace(/\d/g, d => NP[d]);
      const onlyDigits = (s) => String(s||"").replace(/[^\d]/g,"");

      function setErr(el, msg, input){
        el.textContent = msg || "";
        if(input){ input.classList.toggle("is-invalid", !!msg); }
      }
      function clearAllErr(){
        [nameEl, ownerSelect, startEl, endEl, budgetEl, statusEl].forEach(i=> i.classList.remove("is-invalid"));
        [errName, errOwner, errStart, errEnd, errBudget, errStatus].forEach(e=> e.textContent="");
      }

      /* ===== Images state ===== */
      let images = [];
      let initialServerUrls = [];
      let owners = [];

      function updateCount(){ photoCount.textContent = `${images.length}/${MAX_IMAGES}`; }

      function renderThumbs(){
        thumbsEl.innerHTML = "";
        images.forEach((it, idx) => {
          const t = document.createElement("div");
          t.className = "thumb";
          const img = document.createElement("img");
          img.src = it.src; img.alt = "photo";
          t.appendChild(img);

          const x = document.createElement("button");
          x.type = "button"; x.className = "x"; x.innerHTML = "&times;";
          x.addEventListener("click", (e)=>{ e.stopPropagation(); removeImage(idx); });
          t.appendChild(x);

          t.addEventListener("click", ()=> openViewer(idx));
          thumbsEl.appendChild(t);
        });
        updateCount();
      }

      function removeImage(index){ images.splice(index,1); renderThumbs(); if(images.length<MAX_IMAGES) errorSpan.textContent=""; }
      function canAdd(n=1){ return images.length + n <= MAX_IMAGES; }

      function addLocalFiles(fileList){
        const files = Array.from(fileList || []); if(!files.length) return;
        const remaining = MAX_IMAGES - images.length;
        if (remaining <= 0){ errorSpan.textContent = `‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ${MAX_IMAGES} ‡§´‡•ã‡§ü‡•ã ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§∞‡§æ‡§ñ‡•ç‡§® ‡§∏‡§ï‡§ø‡§®‡•ç‡§õ‡•§`; return; }

        const use = files.slice(0, remaining);
        const extra = files.length - use.length;
        errorSpan.textContent = extra>0 ? `‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ${MAX_IMAGES} ‡§´‡•ã‡§ü‡•ã ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§∞‡§æ‡§ñ‡•ç‡§® ‡§∏‡§ï‡§ø‡§®‡•ç‡§õ (‡§Ö‡§ù‡•à ${remaining} ‡§∏‡•ç‡§•‡§æ‡§® ‡§ñ‡§æ‡§≤‡•Ä).` : "";

        const readers = use.map(f => new Promise(res => { const r=new FileReader(); r.onload=()=>res({src:r.result,kind:"local",file:f}); r.readAsDataURL(f); }));
        Promise.all(readers).then(list => { images = images.concat(list); renderThumbs(); });
      }

      dropBtn.addEventListener("click", ()=>{ if (!canAdd()) { showToast("‡§´‡•ã‡§ü‡•ã ‡§∏‡•Ä‡§Æ‡§æ ‡§™‡•Å‡§ó‡§ø‡§∏‡§ï‡•á‡§ï‡•ã ‡§õ (5/5)‡•§","error"); return; } picker.click(); });
      picker.addEventListener("change", (e)=> addLocalFiles(e.target.files));

      /* ===== Fullscreen viewer ===== */
      let viewerIndex = 0;
      function openViewer(i){ viewerIndex=(i+images.length)%images.length; viewerImg.src=images[viewerIndex].src; viewer.classList.add("show"); }
      function closeViewer(){ viewer.classList.remove("show"); }
      function nav(d){ if(!images.length) return; openViewer((viewerIndex+d+images.length)%images.length); }
      viewerPrev.onclick = ()=> nav(-1);
      viewerNext.onclick = ()=> nav(+1);
      viewerClose.onclick = closeViewer;
      viewer.addEventListener("click", (e)=>{ if(e.target===viewer) closeViewer(); });
      document.addEventListener("keydown", (e)=>{ if(!viewer.classList.contains("show")) return; if(e.key==="Escape") closeViewer(); if(e.key==="ArrowLeft") nav(-1); if(e.key==="ArrowRight") nav(+1); });

      /* ===== Owners (dropdown) ===== */
      async function fetchOwners(){
        try{ const res = await fetch(`${API}/owners`, { headers }); if(res.ok) owners = await res.json(); }catch(e){ console.error(e); }
        renderOwnerOptions(owners);
      }
      function renderOwnerOptions(list){
        ownerSelect.innerHTML = '<option value="" disabled selected>‡§ò‡§∞‡§ß‡§®‡•Ä ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‚Ä¶</option>' + (list||[]).map(o=>`<option value="${o.id}">${o.name || "(No name)"}</option>`).join("");
        if (ownerIdInput.value) ownerSelect.value = ownerIdInput.value;
      }
      ownerSelect.addEventListener("change", ()=> { ownerIdInput.value = ownerSelect.value || ""; setErr(errOwner,"",ownerSelect); });

      /* ===== Image URL helper ===== */
      function absStorageUrl(u){
        if (!u) return "";
        if (/^https?:\/\//i.test(u)) return u;
        if (u.startsWith("/")) return API_BASE + u;
        if (u.startsWith("storage/")) return API_BASE + "/" + u;
        return API_BASE + "/storage/" + u.replace(/^\/?storage\//,"");
      }

      /* ===== Load site ===== */
      function extractServerImages(site){
        let urls = Array.isArray(site.images_urls) && site.images_urls.length ? site.images_urls : (Array.isArray(site.images) ? site.images : []);
        return urls.slice(0, MAX_IMAGES).map(absStorageUrl);
      }

      async function loadSite(){
        try{
          const res = await fetch(`${API}/sites/${SITE_ID}`, { headers });
          if (!res.ok) throw new Error();
          const site = await res.json();

          setVal("name",        site.name);
          setVal("address",     site.address);
          setVal("start_date", (site.start_date||"").slice(0,10));
          setVal("end_date",   (site.end_date||"").slice(0,10));

          // show existing amount in Nepali digits
          document.getElementById("budget").value = toNp(String(site.estimated_budget ?? ""));

          setVal("description", site.description);
          setVal("status",      site.status || "ongoing");

          const oid = site.owner_id || site.owner?.id || "";
          ownerIdInput.value = oid ? String(oid) : "";
          renderOwnerOptions(owners);

          const rels = Array.isArray(site.images) ? site.images : [];
          const urls = extractServerImages(site);

          initialServerUrls = urls.slice();
          images = urls.map((u,i)=>({ src:u, kind:"server", rel:rels[i] || null }));
          renderThumbs();
        }catch(_){
          images = []; renderThumbs();
        }
      }

      /* ===== Change detection for images ===== */
      function imagesChanged(){
        const currentServer = images.filter(i=>i.kind==="server").map(i=>i.src);
        const locals = images.filter(i=>i.kind==="local").length;
        const removed = initialServerUrls.filter(u => !currentServer.includes(u)).length;
        return locals>0 || removed>0;
      }

      /* ===== Validation ===== */
      function validateForm(){
        clearAllErr();
        let ok = true;

        if(!nameEl.value.trim()){
          setErr(errName,"‡§∏‡§æ‡§á‡§ü‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§õ‡•§", nameEl); ok = false;
        }

        if(!ownerSelect.value){
          setErr(errOwner,"‡§ò‡§∞‡§ß‡§®‡•Ä ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§", ownerSelect); ok = false;
        }

        const s = startEl.value ? new Date(startEl.value) : null;
        const e = endEl.value ? new Date(endEl.value) : null;
        if(s && e && e < s){
          setErr(errEnd,"‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø ‡§∏‡•Å‡§∞‡•Å ‡§Æ‡§ø‡§§‡§ø‡§≠‡§®‡•ç‡§¶‡§æ ‡§™‡§õ‡§æ‡§°‡§ø ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ‡•§", endEl);
          setErr(errStart,"", startEl);
          ok = false;
        }

        // Budget: allow Nepali digits; if entered, must be numeric
        if(budgetEl.value.trim()){
          const en = onlyDigits(toEn(budgetEl.value));
          if(!en){ setErr(errBudget,"‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∞‡§ï‡§Æ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§", budgetEl); ok = false; }
        }

        if(!statusEl.value){
          setErr(errStatus,"‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§", statusEl); ok = false;
        }

        if(!ok){
          const firstInvalid = document.querySelector(".is-invalid");
          if(firstInvalid) firstInvalid.scrollIntoView({behavior:"smooth", block:"center"});
        }
        return ok;
      }

      /* ===== Save (details + photos) ===== */
      function buildScalarPayload(){
        const budgetEn = onlyDigits(toEn(budgetEl.value));
        return {
          name:             nameEl.value.trim(),
          address:          addressEl.value.trim(),
          owner_id:         ownerSelect.value || null,
          start_date:       startEl.value || null,
          end_date:         endEl.value || null,
          // IMPORTANT: send as STRING to satisfy Laravel 'string' rule
          estimated_budget: budgetEn ? String(budgetEn) : null,
          description:      descEl.value.trim(),
          status:           statusEl.value || "ongoing",
        };
      }

      async function saveDetails(){
        if(!validateForm()) { showToast("‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§æ‡§∞‡§Æ ‡§†‡•Ä‡§ï ‡§Æ‡§ø‡§≤‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§","error"); return; }

        const payload = buildScalarPayload();

        // 1) Update scalar fields (JSON) with proper 422 handling
        let res, ok = false, data = null;
        try{
          res = await fetch(`${API}/sites/${SITE_ID}`, {
            method:"PATCH", headers:{ ...headers, "Content-Type":"application/json" }, body: JSON.stringify(payload)
          });
          if (!res.ok){
            // fallback for servers expecting PUT via _method
            res = await fetch(`${API}/sites/${SITE_ID}`, {
              method:"POST", headers:{ ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ ...payload, _method:"PUT" })
            });
          }
          data = await res.json().catch(()=> ({}));
          ok = res.ok;
        }catch(_){
          ok = false;
        }

        if (!ok) {
          if (res && res.status === 422 && data && data.errors){
            // map server errors to inline fields
            if (data.errors.name)        setErr(errName,   String(data.errors.name[0] || data.errors.name), nameEl);
            if (data.errors.owner_id)    setErr(errOwner,  String(data.errors.owner_id[0] || data.errors.owner_id), ownerSelect);
            if (data.errors.start_date)  setErr(errStart,  String(data.errors.start_date[0] || data.errors.start_date), startEl);
            if (data.errors.end_date)    setErr(errEnd,    String(data.errors.end_date[0] || data.errors.end_date), endEl);
            if (data.errors.estimated_budget) setErr(errBudget, String(data.errors.estimated_budget[0] || data.errors.estimated_budget), budgetEl);
            if (data.errors.status)      setErr(errStatus, String(data.errors.status[0] || data.errors.status), statusEl);
            showToast("‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§≠‡•á‡§ü‡§ø‡§Ø‡•ã, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡§ö‡•ç‡§Ø‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§","error");
          } else {
            showToast(data?.message || "‡§Ö‡§™‡§°‡•á‡§ü ‡§Ö‡§∏‡§´‡§≤ ‡§≠‡§Ø‡•ã‡•§","error");
          }
          return;
        }

        // 2) Photos if changed
        if (imagesChanged()){
          try{
            const form = new FormData();
            Object.entries(payload).forEach(([k,v])=> { if(v!==undefined && v!==null) form.append(k, v); });

            const keepRel = images.filter(it => it.kind==="server" && it.rel).map(it => it.rel);
            keepRel.forEach(p => form.append("keep_images[]", p));

            for(const it of images){ if(it.kind==="local" && it.file) form.append("images[]", it.file); }

            form.append("_method","PUT");
            const res2 = await fetch(`${API}/sites/${SITE_ID}`, {
              method:"POST", headers:{ Authorization: headers.Authorization, Accept: headers.Accept }, body: form
            });
            if(!res2.ok) throw new Error("Image update failed");
          }catch(e){
            console.error(e); showToast("‡§´‡•ã‡§ü‡•ã ‡§Ö‡§™‡§°‡•á‡§ü ‡§ó‡§∞‡•ç‡§¶‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§≠‡§Ø‡•ã‡•§","error"); return;
          }
        }

        // Success ‚Äî mimic create page behavior
        sessionStorage.setItem("toast_msg", "‡§∏‡§æ‡§á‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§≠‡§Ø‡•ã");
        sessionStorage.setItem("toast_kind", "success");
        location.href = "c-site-list.html";
      }

      async function deleteSite(){
        if (!confirm("‡§∏‡§æ‡§á‡§ü ‡§°‡§ø‡§≤‡§ø‡§ü ‡§ó‡§∞‡•ç‡§®‡•á ‡§π‡•ã?")) return;
        try{
          let res = await fetch(`${API}/sites/${SITE_ID}`, { method:"DELETE", headers });
          if (!res.ok){
            res = await fetch(`${API}/sites/${SITE_ID}`, {
              method:"POST", headers:{ ...headers, "Content-Type":"application/json" }, body: JSON.stringify({ _method:"DELETE" })
            });
          }
          if (!res.ok) throw new Error();
          sessionStorage.setItem("toast_msg","‡§∏‡§æ‡§á‡§ü ‡§Æ‡•á‡§ü‡§æ‡§á‡§Ø‡•ã");
          sessionStorage.setItem("toast_kind","success");
          location.href = "c-site-list.html";
        }catch(_){
          showToast("‡§Æ‡•á‡§ü‡§æ‡§â‡§® ‡§Ö‡§∏‡§´‡§≤ ‡§≠‡§Ø‡•ã‡•§","error");
        }
      }

      // Amount field: keep only Nepali/English digits while typing
      budgetEl.addEventListener("input", (e)=>{
        const raw = e.target.value;
        const normalized = raw.replace(/[^\d‡•¶-‡•Ø]/g,"");
        e.target.value = normalized;
        setErr(errBudget,"", budgetEl);
      });

      document.getElementById("save").addEventListener("click", saveDetails);
      document.getElementById("delete").addEventListener("click", deleteSite);

      /* ===== Init ===== */
      (async function init(){
        await fetchOwners();
        await loadSite();
      })();
    </script>
  </body>
</html>
