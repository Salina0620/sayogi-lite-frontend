<!DOCTYPE html>
<html lang="ne">
  <head>
    <meta charset="UTF-8" />
    <!-- Edge-to-edge & notches/home-indicator safe -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>OTP Verification</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --brand-green: #13a87d;
        --text-900: #0f172a;
        --text-800: #1f2937;
        --text-700: #374151;
        --text-600: #4b5563;
        --stroke: #e7ebf0;
        --panel: #ffffff;

        --r-lg: 28px;
        --r-sm: 14px;

        --safe-top: env(safe-area-inset-top, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
      }

      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: #f3f5f7;
        min-height: 100dvh;
      }

      .mobile-container {
        width: 100vw;
        max-width: none;
        min-height: 100dvh;
        background: var(--panel);
        border-radius: 0;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        padding-top: var(--safe-top);
        padding-bottom: var(--safe-bottom);
      }

      .top-space {
        height: 22px;
      }

      header.otp-header {
        display: flex;
        align-items: center;
        padding: 0 16px;
      }
      .back {
        color: var(--text-800);
        text-decoration: none;
        font-size: 50px;
        font-weight: 500;
        transform: scaleX(0.72);
        line-height: 1;
        display: inline-flex;
        width: 44px;
        height: 44px;
        align-items: center;
        justify-content: center;
      }

      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0 24px;
      }

      .otp-logo {
        width: 330px;
        max-width: 85%;
        height: auto;
        display: block;
        margin-top: -70px;
        margin-bottom: 1px;
      }

      .title {
        font-size: 19px;
        font-weight: 600;
        color: var(--brand-green);
        margin: -10 0 10px;
        line-height: 1.2;
        text-align: center;
        text-decoration-thickness: 2px;
      }
      .subtitle {
        font-size: 13px;
        color: var(--text-700);
        margin: 0 0 20px;
        text-align: center;
        line-height: 1.5;
      }

      .otp-inputs {
        display: flex;
        gap: 16px;
        margin: 0 0 14px;
      }
      .otp-digit {
        width: 60px;
        height: 60px;
        border: 1px solid var(--stroke);
        border-radius: var(--r-sm);
        background: #fbfcfd;
        text-align: center;
        font-size: 20px;
        font-weight: 500;
        color: var(--text-800);
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
        outline: none;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      .otp-digit:focus {
        border-color: var(--brand-green);
        box-shadow: 0 0 0 3px rgba(19, 168, 125, 0.18);
      }

      .timer {
        font-size: 13px;
        color: var(--text-600);
        margin: 4px 0 10px;
        text-align: center;
      }

      .actions {
        padding: 0 24px 24px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .btn-primary-otp {
        height: 52px;
        border: none;
        border-radius: 16px;
        background: var(--brand-green);
        color: #fff;
        font-weight: 600;
        font-size: 18px;
      }
      .btn-primary-otp:hover,
      .btn-primary-otp:focus,
      .btn-primary-otp:active {
        background: var(--brand-green) !important;
        color: #fff !important;
      }
      .btn-outline-otp {
        height: 52px;
        border-radius: 16px;
        background: #fff;
        border: 2px solid var(--brand-green);
        color: #0b2238;
        font-weight: 600;
        font-size: 18px;
      }
      .btn-outline-otp:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }

      @media (max-height: 750px) {
        .otp-logo {
          width: 300px;
          margin: 6px 0 14px;
        }
        .title {
          font-size: 26px;
          margin-bottom: 8px;
        }
        .subtitle {
          margin-bottom: 16px;
        }
        .otp-inputs {
          gap: 14px;
        }
      }

      .error-text {
        font-size: 13px;
        color: #dc3545;
        text-align: center;
        margin-top: 6px;
      }
      .info-text {
        font-size: 13px;
        color: #0b5db8;
        text-align: center;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="mobile-container">
      <div class="top-space"></div>

      <header class="otp-header">
        <a href="login.html" class="back">‚Äπ</a>
      </header>

      <div class="content">
        <img
          src="otp-removebg-preview.png"
          alt="OTP Illustration"
          class="otp-logo"
        />

        <h1 class="title">OTP ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•Ä‡§ï‡§∞‡§£</h1>
        <p class="subtitle" id="phoneDisplay">
          ‡§π‡§æ‡§Æ‡•Ä‡§≤‡•á ‡§™‡§†‡§æ‡§è‡§ï‡•ã ‡§ï‡•ã‡§° ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
        </p>

        <form
          id="otpForm"
          class="otp-inputs"
          autocomplete="one-time-code"
          novalidate
        >
          <input
            type="tel"
            maxlength="1"
            class="otp-digit"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="tel"
            maxlength="1"
            class="otp-digit"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="tel"
            maxlength="1"
            class="otp-digit"
            inputmode="numeric"
            pattern="[0-9]*"
          />
          <input
            type="tel"
            maxlength="1"
            class="otp-digit"
            inputmode="numeric"
            pattern="[0-9]*"
          />
        </form>

        <div id="otpFeedback"></div>
        <p class="timer">
          <span id="timer">‡•¨‡•¶</span> ‡§∏‡•á‡§ï‡•á‡§®‡•ç‡§°‡§Æ‡§æ ‡§ï‡•ã‡§° ‡§™‡•Å‡§®‡§É ‡§™‡§†‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç
        </p>
      </div>

      <div class="actions">
        <button class="btn-primary-otp" id="btnSubmit">‡§™‡•á‡§∂ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</button>
        <button class="btn-outline-otp" id="btnResend" disabled>
          ‡§ï‡•ã‡§° ‡§™‡•Å‡§®‡§É ‡§™‡§†‡§æ‡§â‡§®‡•Å‡§π‡•ã‡§∏‡•ç
        </button>
      </div>
    </div>

    <script>
      // ==== Params & phone display ====
      const params = new URLSearchParams(location.search);
      const userId = params.get("user_id");
      const phone = params.get("phone");
      const API_BASE = "http://192.168.1.209:8000/api";

      if (phone) {
        document.getElementById(
          "phoneDisplay"
        ).textContent = `‡§π‡§æ‡§Æ‡•Ä‡§≤‡•á ‡§™‡§†‡§æ‡§è‡§ï‡•ã ‡§ï‡•ã‡§° ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç: ${phone}`;
      }

      // ==== Elements ====
      const digits = document.querySelectorAll(".otp-digit");
      const form = document.getElementById("otpForm");
      const feedback = document.getElementById("otpFeedback");
      const btnSubmit = document.getElementById("btnSubmit");
      const btnResend = document.getElementById("btnResend");
      const timerEl = document.getElementById("timer");

      // ==== Input UX: auto-advance, backspace to previous, digits only ====
      setTimeout(() => digits[0].focus(), 150);
      digits.forEach((el, i) => {
        el.addEventListener("input", () => {
          el.value = el.value.replace(/\D/g, "").slice(0, 1);
          if (el.value && i < digits.length - 1) digits[i + 1].focus();
          if (feedback.textContent) clearFeedback();
        });
        el.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !el.value && i > 0)
            digits[i - 1].focus();
          if (e.key === "Enter") {
            e.preventDefault();
            verifyOTP();
          }
        });
      });

      function getOTP() {
        return Array.from(digits)
          .map((d) => d.value)
          .join("");
      }
      function clearInputs() {
        digits.forEach((d) => (d.value = ""));
        digits[0].focus();
      }
      function showError(msg) {
        feedback.textContent = msg;
        feedback.className = "error-text";
      }
      function showInfo(msg) {
        feedback.textContent = msg;
        feedback.className = "info-text";
      }
      function clearFeedback() {
        feedback.textContent = "";
        feedback.className = "";
      }

      // ==== Verify flow ====
      async function verifyOTP() {
        const otp = getOTP();
        clearFeedback();

        if (otp.length !== 4) {
          showError("‡§ï‡•É‡§™‡§Ø‡§æ ‡•™ ‡§Ö‡§Ç‡§ï‡§ï‡•ã OTP ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§");
          return;
        }
        if (!userId) {
          showError("User ID ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§õ‡•§");
          return;
        }

        btnSubmit.disabled = true;
        try {
          const res = await fetch(`${API_BASE}/verify-otp`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ user_id: userId, otp }),
          });
          const data = await res.json();

          if (res.ok) {
            if (data.token) localStorage.setItem("auth_token", data.token);
            if (data.user)
              localStorage.setItem("user", JSON.stringify(data.user));
            // üëâ No success message here ‚Äî go straight to home
            sessionStorage.setItem("show_otp_toast", "1");
            // optional custom text:
            // localStorage.setItem('flash_msg','OTP ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§ø‡§§ ‡§≠‡§Ø‡•ã');
            location.href = "home.html";
          } else {
            showError(data.message || "OTP ‡§Æ‡§ø‡§≤‡•á‡§®‡•§");
          }
        } catch (e) {
          showError("‡§∏‡§∞‡•ç‡§≠‡§∞‡§Æ‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§≠‡§Ø‡•ã‡•§");
        } finally {
          btnSubmit.disabled = false;
        }
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        verifyOTP();
      });
      btnSubmit.addEventListener("click", verifyOTP);

      // ==== Timer & Resend flow (with cooldown persistence) ====
      const STORAGE_KEY = userId
        ? `otp_resend_ready_at:${userId}`
        : `otp_resend_ready_at`;

      function toNepali(n) {
        const map = ["‡•¶", "‡•ß", "‡•®", "‡•©", "‡•™", "‡•´", "‡•¨", "‡•≠", "‡•Æ", "‡•Ø"];
        return String(n)
          .split("")
          .map((ch) => (/\d/.test(ch) ? map[+ch] : ch))
          .join("");
      }

      // Persist helpers
      function setResendReadyAfter(seconds) {
        const readyAt = Date.now() + seconds * 1000;
        localStorage.setItem(STORAGE_KEY, String(readyAt));
        return readyAt;
      }
      function getResendReadyAt() {
        const v = localStorage.getItem(STORAGE_KEY);
        const n = v ? Number(v) : NaN;
        return Number.isFinite(n) ? n : null;
      }

      let remaining = 60;
      let timerHandle = null;

      function startTimer(initialRemaining) {
        if (timerHandle) clearInterval(timerHandle);

        remaining =
          typeof initialRemaining === "number" ? initialRemaining : 60;

        if (remaining <= 0) {
          timerEl.textContent = "‡•¶";
          btnResend.disabled = false;
          return;
        }

        btnResend.disabled = true;
        timerEl.textContent = toNepali(remaining);

        timerHandle = setInterval(() => {
          remaining--;
          if (remaining <= 0) {
            clearInterval(timerHandle);
            timerHandle = null;
            timerEl.textContent = "‡•¶";
            btnResend.disabled = false;
          } else {
            timerEl.textContent = toNepali(remaining);
          }
        }, 1000);
      }

      // Initialize timer from storage so refresh can't bypass cooldown
      (function initCooldownFromStorage() {
        const readyAt = getResendReadyAt();
        if (!readyAt) {
          // First time on page after login: start and persist 60s
          setResendReadyAfter(60);
          startTimer(60);
          return;
        }
        const remain = Math.ceil((readyAt - Date.now()) / 1000);
        if (remain > 0) {
          startTimer(remain);
        } else {
          timerEl.textContent = "‡•¶";
          btnResend.disabled = false;
        }
      })();

      async function resendOTP() {
        btnResend.disabled = true;
        clearFeedback();
        try {
          const res = await fetch(`${API_BASE}/resend-otp`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({ user_id: userId, phone }),
          });
          const data = await res.json();

          if (res.ok) {
            showInfo(data.message || "OTP ‡§™‡•Å‡§®‡§É ‡§™‡§†‡§æ‡§á‡§Ø‡•ã‡•§");
            clearInputs();

            const seconds = Number(data.expires_in_seconds) || 60;
            setResendReadyAfter(seconds);
            startTimer(seconds);
          } else {
            showError(data.message || "OTP ‡§™‡•Å‡§®‡§É ‡§™‡§†‡§æ‡§â‡§® ‡§∏‡§ï‡•á‡§®‡•§");

            // Reflect real server-side cooldown if it exists in storage
            const readyAt = getResendReadyAt();
            const remain = readyAt
              ? Math.ceil((readyAt - Date.now()) / 1000)
              : 0;
            if (remain > 0) startTimer(remain);
            else btnResend.disabled = false;
          }
        } catch (e) {
          showError("‡§∏‡§∞‡•ç‡§≠‡§∞‡§Æ‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§≠‡§Ø‡•ã‡•§");
          const readyAt = getResendReadyAt();
          const remain = readyAt ? Math.ceil((readyAt - Date.now()) / 1000) : 0;
          if (remain > 0) startTimer(remain);
          else btnResend.disabled = false;
        }
      }

      btnResend.addEventListener("click", resendOTP);
    </script>
  </body>
</html>
