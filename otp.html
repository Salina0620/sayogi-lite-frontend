<!DOCTYPE html>
<html lang="ne">
  <head>
    <meta charset="UTF-8" />
    <!-- Edge-to-edge & notches/home-indicator safe -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>OTP Verification</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>

    <style>
      :root {
        --brand-green: #13a87d;
        --text-900: #0f172a;
        --text-800: #1f2937;
        --text-700: #374151;
        --text-600: #4b5563;
        --stroke: #e7ebf0;
        --panel: #ffffff;

        --r-lg: 28px;
        --r-sm: 14px;

        --safe-top: env(safe-area-inset-top, 0px);
        --safe-right: env(safe-area-inset-right, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-left: env(safe-area-inset-left, 0px);
      }

      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: "Poppins", sans-serif;
        background: #f3f5f7;
        min-height: 100svh;              /* modern viewport for mobile bars */
        -webkit-text-size-adjust: 100%;
        overflow: hidden;                 /* single fixed page, no scrollbars */
      }

      .mobile-container {
        width: 100vw;
        height: 100svh;                   /* fill the visual viewport */
        background: var(--panel);
        display: flex;
        flex-direction: column;
        /* edge-to-edge padding with safe areas */
        padding:
          calc(var(--safe-top) + 0px)
          calc(var(--safe-right) + clamp(16px, 5vw, 28px))
          calc(var(--safe-bottom) + clamp(12px, 2.2vh, 20px))
          calc(var(--safe-left) + clamp(16px, 5vw, 28px));
        box-sizing: border-box;
      }

      header.otp-header {
        display: flex;
        align-items: center;
        padding: 0;                        /* outer padding handled by container */
        flex: 0 0 auto;
      }
      /* Clean "<", 44x44 tap target */
      .back {
        color: var(--text-800);
        text-decoration: none;
        font-size: clamp(24px, 2.8vh, 28px);
        line-height: 1;
        display: inline-flex;
        width: 44px;
        height: 44px;
        align-items: center;
        justify-content: center;
      }

      /* Content stays near the top */
      .content {
        flex: 0 0 auto;                    /* don’t grow; sits at top */
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 0;                      /* top position controlled by logo+block */
      }

      .otp-logo {
        width: clamp(180px, 48vw, 320px);
        max-width: 85%;
        height: auto;
        display: block;
        margin: 2px 0 6px 0;               /* subtle spacing below logo */
      }

      /* Only the OTP block (title → subtitle → inputs → timer) is lifted */
      .otp-block {
        margin-top: -20px;                  /* move the marked area upward */
      }
      @media (max-height: 750px) {
        .otp-block { margin-top: -10px; }   /* gentler lift on short screens */
      }

      .title {
        font-size: clamp(18px, 2.2vh + 0.6vw, 24px);
        font-weight: 600;
        color: var(--brand-green);
        margin: 0 0 10px;
        line-height: 1.2;
        text-align: center;
      }
      .subtitle {
        font-size: clamp(12px, 1.6vh, 14px);
        color: var(--text-700);
        margin: 0 0 10px;
        text-align: center;
        line-height: 1.5;
      }

      .otp-inputs {
        display: flex;
        gap: clamp(10px, 3.5vw, 16px);
        margin: 0 0 10px;
      }
      .otp-digit {
        width: clamp(48px, 9.5vw, 64px);
        height: clamp(48px, 9.5vw, 64px);
        border: 1px solid var(--stroke);
        border-radius: var(--r-sm);
        background: #fbfcfd;
        text-align: center;
        font-size: clamp(18px, 2.2vh, 22px);
        font-weight: 500;
        color: var(--text-800);
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
        outline: none;
        transition: border-color 0.15s, box-shadow 0.15s;
      }
      .otp-digit:focus {
        border-color: var(--brand-green);
        box-shadow: 0 0 0 3px rgba(19, 168, 125, 0.18);
      }

      .timer {
        font-size: clamp(12px, 1.6vh, 14px);
        color: var(--text-600);
        margin: 4px 0 0;
        text-align: center;
      }

      /* Flexible middle gap without scrolling */
      .spacer {
        flex: 1 1 auto;
        min-height: 0;                      /* don’t trigger scroll */
      }

      /* Bottom actions */
      .actions {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        gap: clamp(10px, 1.8vh, 14px);
      }
      .btn-primary-otp,
      .btn-outline-otp {
        height: clamp(44px, 6.5vh, 56px);
        border-radius: 16px;
        font-weight: 600;
        font-size: clamp(16px, 1.9vh, 18px);
      }
      .btn-primary-otp {
        border: none;
        background: var(--brand-green);
        color: #fff;
      }
      .btn-primary-otp:hover,
      .btn-primary-otp:focus,
      .btn-primary-otp:active {
        background: var(--brand-green) !important;
        color: #fff !important;
      }
      .btn-outline-otp {
        background: #fff;
        border: 2px solid var(--brand-green);
        color: #0b2238;
      }
      .btn-outline-otp:disabled { opacity: 0.55; cursor: not-allowed; }

      /* Short screens — keep proportions tight */
      @media (max-height: 650px) {
        .otp-logo { width: clamp(160px, 42vw, 280px); margin: 0 0 4px; }
        .title { margin-bottom: 6px; }
        .subtitle { margin-bottom: 8px; }
      }

      .error-text {
        font-size: clamp(12px, 1.6vh, 14px);
        color: #dc3545;
        text-align: center;
        margin-top: 6px;
      }
      .info-text {
        font-size: clamp(12px, 1.6vh, 14px);
        color: #0b5db8;
        text-align: center;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="mobile-container">
      <header class="otp-header">
        <a href="login.html" class="back">&lt;</a>
      </header>

      <div class="content">
        <img src="otp-removebg-preview.png" alt="OTP Illustration" class="otp-logo" />

        <!-- Only the marked section is moved up via .otp-block -->
        <div class="otp-block">
          <h1 class="title">OTP प्रमाणीकरण</h1>
          <p class="subtitle" id="phoneDisplay">हामीले पठाएको कोड प्रविष्ट गर्नुहोस्</p>

          <form id="otpForm" class="otp-inputs" autocomplete="one-time-code" novalidate>
            <input type="tel" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]*"/>
            <input type="tel" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]*"/>
            <input type="tel" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]*"/>
            <input type="tel" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]*"/>
          </form>

          <div id="otpFeedback"></div>
          <p class="timer"><span id="timer">६०</span> सेकेन्डमा कोड पुनः पठाउनुहोस्</p>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="actions">
        <button class="btn-primary-otp" id="btnSubmit">पेश गर्नुहोस्</button>
        <button class="btn-outline-otp" id="btnResend" disabled>कोड पुनः पठाउनुहोस्</button>
      </div>
    </div>

    <script>
      // ==== Params & phone display ====
      const params = new URLSearchParams(location.search);
      const userId = params.get("user_id");
      const phone = params.get("phone");
      const API_BASE = "http://192.168.1.209:8000/api";

      if (phone) {
        document.getElementById("phoneDisplay").textContent = `हामीले पठाएको कोड प्रविष्ट गर्नुहोस्: ${phone}`;
      }

      // ==== Elements ====
      const digits = document.querySelectorAll(".otp-digit");
      const form = document.getElementById("otpForm");
      const feedback = document.getElementById("otpFeedback");
      const btnSubmit = document.getElementById("btnSubmit");
      const btnResend = document.getElementById("btnResend");
      const timerEl = document.getElementById("timer");

      // ==== Input UX ====
      setTimeout(() => digits[0].focus(), 150);
      digits.forEach((el, i) => {
        el.addEventListener("input", () => {
          el.value = el.value.replace(/\D/g, "").slice(0, 1);
          if (el.value && i < digits.length - 1) digits[i + 1].focus();
          if (feedback.textContent) clearFeedback();
        });
        el.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !el.value && i > 0) digits[i - 1].focus();
          if (e.key === "Enter") { e.preventDefault(); verifyOTP(); }
        });
      });

      function getOTP() { return Array.from(digits).map((d) => d.value).join(""); }
      function clearInputs() { digits.forEach((d) => (d.value = "")); digits[0].focus(); }
      function showError(msg) { feedback.textContent = msg; feedback.className = "error-text"; }
      function showInfo(msg) { feedback.textContent = msg; feedback.className = "info-text"; }
      function clearFeedback() { feedback.textContent = ""; feedback.className = ""; }

      // ==== Verify flow ====
      async function verifyOTP() {
        const otp = getOTP();
        clearFeedback();

        if (otp.length !== 4) { showError("कृपया ४ अंकको OTP प्रविष्ट गर्नुहोस्।"); return; }
        if (!userId) { showError("User ID आवश्यक छ।"); return; }

        btnSubmit.disabled = true;
        try {
          const res = await fetch(`${API_BASE}/verify-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Accept: "application/json" },
            body: JSON.stringify({ user_id: userId, otp }),
          });
          const data = await res.json();

          if (res.ok) {
            if (data.token) localStorage.setItem("auth_token", data.token);
            if (data.user) localStorage.setItem("user", JSON.stringify(data.user));
            sessionStorage.setItem("show_otp_toast", "1");
            location.href = "home.html";
          } else {
            showError(data.message || "OTP मिलेन।");
          }
        } catch (e) {
          showError("सर्भरमा समस्या भयो।");
        } finally {
          btnSubmit.disabled = false;
        }
      }

      form.addEventListener("submit", (e) => { e.preventDefault(); verifyOTP(); });
      btnSubmit.addEventListener("click", verifyOTP);

      // ==== Timer & Resend flow ====
      const STORAGE_KEY = userId ? `otp_resend_ready_at:${userId}` : `otp_resend_ready_at`;

      function toNepali(n) {
        const map = ["०","१","२","३","४","५","६","७","८","९"];
        return String(n).split("").map((ch) => (/\d/.test(ch) ? map[+ch] : ch)).join("");
      }

      function setResendReadyAfter(seconds) {
        const readyAt = Date.now() + seconds * 1000;
        localStorage.setItem(STORAGE_KEY, String(readyAt));
        return readyAt;
      }
      function getResendReadyAt() {
        const v = localStorage.getItem(STORAGE_KEY);
        const n = v ? Number(v) : NaN;
        return Number.isFinite(n) ? n : null;
      }

      let remaining = 60;
      let timerHandle = null;

      function startTimer(initialRemaining) {
        if (timerHandle) clearInterval(timerHandle);
        remaining = typeof initialRemaining === "number" ? initialRemaining : 60;

        if (remaining <= 0) { timerEl.textContent = "०"; btnResend.disabled = false; return; }

        btnResend.disabled = true;
        timerEl.textContent = toNepali(remaining);

        timerHandle = setInterval(() => {
          remaining--;
          if (remaining <= 0) {
            clearInterval(timerHandle);
            timerHandle = null;
            timerEl.textContent = "०";
            btnResend.disabled = false;
          } else {
            timerEl.textContent = toNepali(remaining);
          }
        }, 1000);
      }

      (function initCooldownFromStorage() {
        const readyAt = getResendReadyAt();
        if (!readyAt) { setResendReadyAfter(60); startTimer(60); return; }
        const remain = Math.ceil((readyAt - Date.now()) / 1000);
        if (remain > 0) { startTimer(remain); }
        else { timerEl.textContent = "०"; btnResend.disabled = false; }
      })();

      async function resendOTP() {
        btnResend.disabled = true;
        clearFeedback();
        try {
          const res = await fetch(`${API_BASE}/resend-otp`, {
            method: "POST",
            headers: { "Content-Type": "application/json", Accept: "application/json" },
            body: JSON.stringify({ user_id: userId, phone }),
          });
          const data = await res.json();

          if (res.ok) {
            showInfo(data.message || "OTP पुनः पठाइयो।");
            clearInputs();

            const seconds = Number(data.expires_in_seconds) || 60;
            setResendReadyAfter(seconds);
            startTimer(seconds);
          } else {
            showError(data.message || "OTP पुनः पठाउन सकेन।");
            const readyAt = getResendReadyAt();
            const remain = readyAt ? Math.ceil((readyAt - Date.now()) / 1000) : 0;
            if (remain > 0) startTimer(remain);
            else btnResend.disabled = false;
          }
        } catch (e) {
          showError("सर्भरमा समस्या भयो।");
          const readyAt = getResendReadyAt();
          const remain = readyAt ? Math.ceil((readyAt - Date.now()) / 1000) : 0;
          if (remain > 0) startTimer(remain);
          else btnResend.disabled = false;
        }
      }

      btnResend.addEventListener("click", resendOTP);
    </script>
  </body>
</html>
