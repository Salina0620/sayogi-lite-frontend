<!DOCTYPE html>
<html lang="ne">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OTP Verification</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- OTP Page Specific CSS -->
    <link rel="stylesheet" href="CSS/style.css" />
    <!-- Google Fonts & Font Awesome -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>
  <body>
    <div class="mobile-container otp-page-container">
      <header class="otp-page-header">
        <a href="login.html" class="back-arrow"
          ><i class="fas fa-chevron-left"></i
        ></a>
      </header>

      <main class="otp-content-wrapper">
        <div class="text-center">
          <div class="lock-illustration">
            <div class="lock-container">
              <div class="background-circle"></div>
              <div class="lock-shackle"></div>
              <div class="lock-body">
                <div class="keyhole"></div>
              </div>
              <div class="question-mark-circle">?</div>
            </div>
          </div>

          <h1 class="otp-title">OTP प्रमाणीकरण</h1>
          <p class="otp-subtitle" id="phoneDisplay">
            हामीले पठाएको कोड प्रविष्ट गर्नुहोस्
          </p>

          <!-- OTP Feedback Message (Initially empty) -->
          <div id="otpFeedback" class="mb-2"></div>

          <!-- OTP Input Boxes -->
          <form id="otpForm" class="otp-input-group">
            <input
              type="tel"
              class="form-control otp-digit"
              maxlength="1"
              required
              pattern="[0-9]"
              inputmode="numeric"
            />
            <input
              type="tel"
              class="form-control otp-digit"
              maxlength="1"
              required
              pattern="[0-9]"
              inputmode="numeric"
            />
            <input
              type="tel"
              class="form-control otp-digit"
              maxlength="1"
              required
              pattern="[0-9]"
              inputmode="numeric"
            />
            <input
              type="tel"
              class="form-control otp-digit"
              maxlength="1"
              required
              pattern="[0-9]"
              inputmode="numeric"
            />

            <div id="otpFeedback" class="mb-2"></div>
          </form>
          <button type="submit" class="btn btn-submit-otp w-100 mt-3">
            पेश गर्नुहोस्
          </button>
          <p class="resend-timer mt-3">६० सेकेन्डमा कोड पुनः पठाउनुहोस्</p>
          <button type="button" class="btn btn-resend-otp w-100">
            कोड पुनः पठाउनुहोस्
          </button>
        </div>
      </main>
    </div>

   <script>
  // Autofocus move and backspace handling
  const otpInputs = document.querySelectorAll(".otp-digit");
  otpInputs.forEach((input, index) => {
    input.addEventListener("input", () => {
      if (input.value.length === 1 && index < otpInputs.length - 1) {
        otpInputs[index + 1].focus();
      }
    });
    input.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && input.value.length === 0 && index > 0) {
        otpInputs[index - 1].focus();
      }
    });
  });

  // Read user_id and phone from URL query params
  const urlParams = new URLSearchParams(window.location.search);
  const userId = urlParams.get("user_id");
  const phoneFromLogin = urlParams.get("phone");

  if (phoneFromLogin) {
    document.getElementById(
      "phoneDisplay"
    ).textContent = `हामीले पठाएको कोड प्रविष्ट गर्नुहोस्: ${phoneFromLogin}`;
  }

  document
    .getElementById("otpForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const otpFeedback = document.getElementById("otpFeedback");
      otpFeedback.textContent = "";
      otpFeedback.classList.remove("text-danger", "text-success");

      // Collect OTP digits
      let otp = "";
      otpInputs.forEach((input) => (otp += input.value));

      if (otp.length !== 4) {
        otpFeedback.textContent = "कृपया ४ अंकको OTP प्रविष्ट गर्नुहोस्।";
        otpFeedback.classList.add("text-danger");
        return;
      }

      if (!userId) {
        otpFeedback.textContent =
          "User ID आवश्यक छ। कृपया पुनः लगइन गर्नुहोस्।";
        otpFeedback.classList.add("text-danger");
        return;
      }

      const payload = {
        user_id: userId,
        otp: otp,
      };

      try {
        const response = await fetch(
          "http://192.168.1.209:8000/api/verify-otp",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify(payload),
          }
        );

        const data = await response.json();

        if (response.ok) {
          otpFeedback.textContent = data.message || "OTP सत्यापित भयो!";
          otpFeedback.classList.remove("text-danger");
          otpFeedback.classList.add("text-success");

          // ✅ Save token under the same key as login page
          if (data.token) {
            localStorage.setItem("auth_token", data.token);
          }

          setTimeout(() => {
            window.location.href = "home.html";
          }, 2000);
        } else {
          otpFeedback.textContent =
            data.message || "OTP मिलेन। कृपया पुनः प्रयास गर्नुहोस्।";
          otpFeedback.classList.remove("text-success");
          otpFeedback.classList.add("text-danger");
        }
      } catch (err) {
        console.error("OTP verify error:", err);
        otpFeedback.textContent =
          "सर्भरमा समस्या भयो। कृपया पछि प्रयास गर्नुहोस्।";
        otpFeedback.classList.add("text-danger");
      }
    });

  document
    .querySelector(".btn-submit-otp")
    .addEventListener("click", function () {
      document
        .getElementById("otpForm")
        .dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
    });
</script>

  </body>
</html>
