<!DOCTYPE html>
<html lang="ne">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>नयाँ पार्टी थप्नुहोस्</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari&display=swap" rel="stylesheet" />
    <style>
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      :root{ --brand-green:#1AB189; }

      body::before{
        content:""; position:fixed; left:0; right:0; top:0;
        height:env(safe-area-inset-top);
        background:var(--brand-green);
        pointer-events:none; z-index:1000;
      }
      body{
        font-family:"Poppins", sans-serif;
        background:#fafafa; margin:0; color:#0f172a;
      }
      .mobile-container{
        width:100vw; min-height:100vh;
        display:flex; flex-direction:column; background:#f6f7f8;
      }
      .page-header{
        background:var(--brand-green); color:#fff;
        display:flex; flex-direction:column;
        padding-top:env(safe-area-inset-top);
        position:sticky; top:0; z-index:10;
      }
      .header-row{
        display:flex; align-items:center; justify-content:space-between;
        padding:16px; position:relative;
      }
      .back-btn{
        background:none; border:0; color:#fff; cursor:pointer;
        width:44px; height:44px; border-radius:12px;
        display:grid; place-items:center;
      }
      .back-btn svg{ width:29px; height:29px; display:block; fill:#fff; }
      .page-title{
        margin:0; font-size:20px; font-weight:500; text-align:center; flex:1;
        transform:translateX(-10px);
      }
      .header-divider{ height:0; display:none; }

      .content-area{
        flex:1; padding:20px 16px 0 16px;
        display:flex; flex-direction:column; gap:18px;
        background:#f8fafb;
      }
      .avatar-wrap{ display:grid; place-items:center; padding:20px 0 6px; }
      .avatar{
        width:120px; height:120px; border-radius:999px;
        background:var(--brand-green);
        display:grid; place-items:center;
        border:2px solid rgba(0,0,0,0.04);
      }
      .avatar svg{ width:86px; height:86px; fill:#ffffff; }

      label{ font-size:14px; color:#2f2f2f; margin:0 4px 6px; display:inline-block; }

      input[type="text"], input[type="tel"]{
        width:100%; padding:12px 14px; font-size:16px;
        border-radius:12px; background:#fff; outline:none;
        border:2px solid #9dd8cc; transition:border-color .15s ease;
      }
      input[type="text"]:focus, input[type="tel"]:focus{ border-color:var(--brand-green); }
      .field{ display:flex; flex-direction:column; gap:6px; }
      .invalid-feedback{ display:none; color:#e74c3c; font-size:12px; }
      .field.invalid .invalid-feedback{ display:block; }

      .button-row{
        margin-top:auto; display:flex; flex-direction:column; gap:14px;
        padding:18px 16px calc(18px + env(safe-area-inset-bottom,0));
      }
      .save-btn, .cancel-btn{
        width:100%; padding:14px; border:none; border-radius:14px;
        font-size:16px; font-weight:700; color:#fff; letter-spacing:.2px; cursor:pointer;
      }
      .save-btn{ background:#1f6790; }
      .cancel-btn{ background:#e74c3c; }

      @media (max-width:360px){
        .page-title{ font-size:18px; }
        .avatar{ width:104px; height:104px; }
        .avatar svg{ width:72px; height:72px; }
      }
    </style>
  </head>
  <body>
    <div class="mobile-container">
      <header class="page-header">
        <div class="header-row">
          <button class="back-btn" onclick="goBack()" aria-label="পछाडी जानुहोस्">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
            </svg>
          </button>
          <h1 class="page-title"> नयाँ पार्टी थप्नुहोस् </h1>
        </div>
        <div class="header-divider"></div>
      </header>

      <main class="content-area">
        <div class="avatar-wrap">
          <div class="avatar" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.42 0-8 2.24-8 5व1h16व-1c0-2.76-3.58-5-8-5Z"/>
            </svg>
          </div>
        </div>

        <div class="field" id="field-name">
          <label for="party-name">पार्टीको नाम</label>
          <input
            type="text"
            id="party-name"
            placeholder="पार्टीको नाम"
            autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
          />
          <div class="invalid-feedback">कृपया पार्टीको नाम लेख्नुहोस्।</div>
        </div>

        <div class="field" id="field-phone">
          <label for="phone-number">फोन नम्बर</label>
          <input
            type="tel"
            id="phone-number"
            placeholder="फोन नम्बर"
            inputmode="numeric"
            maxlength="10"
            autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
          />
          <div class="invalid-feedback" id="phone-err">फोन नम्बर १० अङ्कको हुनुपर्छ।</div>
        </div>

        <div class="button-row">
          <button class="save-btn" onclick="saveParty()">जानकारी बचत गर्नुहोस्</button>
          <button class="cancel-btn" onclick="goBack()">रद्द गर्नुहोस्</button>
        </div>
      </main>
    </div>

    <script>
      const API_BASE = "http://192.168.1.209:8000/api";
      const TOKEN = localStorage.getItem("auth_token");
      if (!TOKEN) { alert("कृपया लगइन गर्नुहोस्।"); window.location.href = "login.html"; }
      const REAL_TOKEN = TOKEN.includes("|") ? TOKEN.split("|")[1] : TOKEN;

      function goBack(){ window.location.href = "party.html"; }

      // Keep exactly what user types (Nepali or English digits). No conversion.
      const phoneEl = document.getElementById("phone-number");
      phoneEl.addEventListener("input", () => {
        const onlyDigits = (phoneEl.value || "").replace(/[^0-9\u0966-\u096F]/g, "");
        phoneEl.value = onlyDigits.slice(0, 10);
        clearError("phone");
      });

      const nameEl = document.getElementById("party-name");

      function setError(fieldKey, msg){
        const wrap = document.getElementById(`field-${fieldKey}`);
        if (!wrap) return;
        wrap.classList.add("invalid");
        const errEl = wrap.querySelector(".invalid-feedback");
        if (errEl && msg) errEl.textContent = msg;
      }
      function clearError(fieldKey){
        const wrap = document.getElementById(`field-${fieldKey}`);
        if (!wrap) return;
        wrap.classList.remove("invalid");
      }

      async function saveParty(){
        clearError("name"); clearError("phone");

        const name = (nameEl.value || "").trim();
        const phoneRaw = (phoneEl.value || "").trim();
        const digits = (phoneRaw.match(/[0-9\u0966-\u096F]/g) || []).length;

        let hasError = false;
        if (!name){
          setError("name","कृपया पार्टीको नाम लेख्नुहोस्।");
          hasError = true;
        }
        if (!phoneRaw){
          setError("phone","कृपया फोन नम्बर लेख्नुहोस्।");
          hasError = true;
        } else if (digits !== 10){
          setError("phone","फोन नम्बर १० अङ्कको हुनुपर्छ।");
          hasError = true;
        }
        if (hasError) return;

        try{
          // Send exactly what was typed (no conversion)
          const res = await fetch(`${API_BASE}/parties`, {
            method:"POST",
            headers:{ "Content-Type":"application/json", Authorization:`Bearer ${REAL_TOKEN}` },
            body: JSON.stringify({ name, phone_no: phoneRaw }),
          });

          const text = await res.text();
          let data;
          try{ data = JSON.parse(text); }
          catch(e){
            console.error("API response is not JSON:", text);
            alert("API बाट JSON प्रतिक्रिया प्राप्त भएन।");
            return;
          }

          if (!res.ok){
            const msg = data.errors ? Object.values(data.errors).flat().join("\n")
                     : data.message || "त्रुटि भयो।";
            throw new Error(msg);
          }

          localStorage.setItem("flash_msg","पार्टी सफलतापूर्वक थपियो।");
          goBack();
        }catch(err){
          console.error(err);
          alert(err.message || "डेटा बचत गर्न सकिएन। कृपया पुन: प्रयास गर्नुहोस्।");
        }
      }
    </script>
  </body>
</html>
