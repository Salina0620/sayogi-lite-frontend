<!DOCTYPE html>
<html lang="ne">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>‡§®‡§Ø‡§æ‡§Å ‡§∏‡§æ‡§á‡§ü ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <style>
      :root {
        --brand-green: #13a87d;
        --cta-blue: #186b97;
        --alert-red: #e74c3c;

        --bg: #fafafa;
        --surface: #fff;
        --text-900: #0f172a;
        --text-700: #344054;
        --text-600: #667085;
        --muted: #98a2b3;
      }

      body::before {
        content: "";
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        height: env(safe-area-inset-top);
        background: var(--brand-green);
        pointer-events: none;
        z-index: 1000;
      }
      html,
      body {
        height: 100%;
        width: 100%;
        margin: 0;
        background: var(--bg);
        color: var(--text-900);
        font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        overflow: hidden;
        overscroll-behavior: none;
      }

      #create-site-page.mobile-container {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100dvh;
        min-height: 100svh;
        min-height: -webkit-fill-available;
        background: var(--surface);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      #create-site-page .page-header {
        background: var(--brand-green);
        color: #fff;
        display: flex;
        flex-direction: column;
      }
      #create-site-page .header-content {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: calc(16px + env(safe-area-inset-top)) 16px 12px;
      }
      #create-site-page .back-arrow {
        color: #fff;
        font-size: 20px;
        text-decoration: none;
      }
      #create-site-page h1 {
        margin: 0 auto;
        font-size: 18px;
        font-weight: 500;
        letter-spacing: 0.2px;
      }

      #create-site-page .page-content {
        flex: 1 1 auto;
        overflow: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        background: #fafafa;
        padding: 16px 16px calc(18px + env(safe-area-inset-bottom));
        scrollbar-width: none;
      }
      #create-site-page .page-content::-webkit-scrollbar {
        width: 0;
        height: 0;
      }

      .field-label {
        display: block;
        margin: 10px 2px 6px;
        color: #555;
        font-size: 14px;
        font-weight: 500;
      }
      .form-control {
        height: 48px;
        padding: 10px 12px;
        font-size: 15px;
        background: #f8fafc;
        color: var(--text-900);
        border: 1.5px solid #d0d5dd;
        border-radius: 0 !important;
      }
      .form-control::placeholder {
        color: #a3aab6;
      }
      .form-control:focus {
        border-color: var(--brand-green);
        box-shadow: 0 0 0 2px rgba(19, 168, 125, 0.18);
      }
      textarea.form-control {
        min-height: 96px;
        height: auto;
      }

      .owner-group {
        position: relative;
      }
      .owner-group .input-group-text {
        background: #f8fafc;
        color: #9ca3af;
        border: 1.5px solid #d0d5dd;
        border-right: 0;
        border-radius: 0;
        height: 48px;
        padding: 0 12px;
      }
      .owner-group input {
        border-top: 1.5px solid #d0d5dd;
        border-bottom: 1.5px solid #d0d5dd;
        border-left: 0;
        border-right: 0;
        border-radius: 0;
        background: #f8fafc;
        height: 48px;
      }
      .btn-add-owner {
        background: var(--cta-blue);
        color: #fff;
        border: 1.5px solid var(--cta-blue);
        border-radius: 0;
        width: 54px;
        height: 48px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      #ownerDropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 54px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 6px 18px rgba(16, 24, 40, 0.08);
        max-height: 150px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
      }
      #ownerDropdown .list-group-item {
        border: 0;
        padding: 10px 12px;
        font-size: 14px;
        cursor: pointer;
      }
      #ownerDropdown .list-group-item:hover {
        background: #f3f5f7;
      }

      .document-section h5 {
        font-size: 15px;
        font-weight: 400;
        margin: 14px 2px 8px;
      }
      .image-upload-box {
        width: 100%;
        border: 1.5px dashed #d0d5dd;
        border-radius: 8px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        color: #475467;
        background: #fff;
        cursor: pointer;
      }
      #imagePreview img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
      }

      .btn-primary-action,
      .btn-secondary-action {
        border: none;
        height: 48px;
        border-radius: 12px;
        font-weight: 700;
      }
      .btn-primary-action {
        background: var(--cta-blue);
        color: #fff;
      }
      .btn-secondary-action {
        background: var(--alert-red);
        color: #fff;
      }
      .btn-primary-action,
      .btn-primary-action:hover,
      .btn-primary-action:active,
      .btn-primary-action:focus {
        background: var(--cta-blue) !important;
        border-color: var(--cta-blue) !important;
        color: #fff !important;
        box-shadow: none !important;
      }
      .btn-secondary-action,
      .btn-secondary-action:hover,
      .btn-secondary-action:active,
      .btn-secondary-action:focus {
        background: var(--alert-red) !important;
        border-color: var(--alert-red) !important;
        color: #fff !important;
        box-shadow: none !important;
      }

      @media (max-width: 340px) {
        .form-control {
          height: 46px;
        }
        .owner-group .input-group-text,
        .btn-add-owner {
          height: 46px;
        }
      }

      .owner-modal {
        border-radius: 12px;
      }
      .owner-modal .modal-title {
        font-weight: 700;
        font-size: 22px;
      }
      .owner-modal .form-control {
        border-radius: 0 !important;
      }

      /* tighter gaps */
      #create-site-page .page-content .mb-2,
      #create-site-page .page-content .input-group.mb-2,
      #create-site-page .page-content .owner-group.mb-2 {
        margin-bottom: 12px !important;
      }
      #create-site-page .page-content .mt-3 {
        margin-top: 14px !important;
      }

      .owner-group .form-select {
        height: 48px;
        padding: 10px 36px 10px 12px;
        font-size: 15px;
        background: #f8fafc;
        color: var(--muted);
        border-top: 1.5px solid #d0d5dd;
        border-bottom: 1.5px solid #d0d5dd;
        border-left: 0;
        border-right: 0;
        border-radius: 0 !important;
        box-shadow: none;
      }
      .owner-group .form-select.has-value {
        color: var(--text-900);
      }
      .owner-group .form-select:focus {
        border-color: var(--brand-green);
        box-shadow: 0 0 0 2px rgba(19, 168, 125, 0.18);
      }

      /* inline errors */
      .err {
        color: var(--alert-red);
        font-size: 12px;
        margin: 4px 2px 0;
      }
      .is-invalid {
        border-color: var(--alert-red) !important;
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.15) !important;
      }

      /* Toast */
      #toast {
        position: fixed;
        top: calc(12px + env(safe-area-inset-top));
        right: calc(12px + env(safe-area-inset-right));
        background: #ffffff;
        border: 0;
        border-radius: 12px;
        padding: 10px 14px 10px 10px;
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
        display: grid;
        grid-template-columns: 32px 1fr 24px;
        align-items: center;
        gap: 12px;
        width: max-content;
        max-width: 92vw;

        transform: translateY(-8px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.22s ease, transform 0.22s ease;
        z-index: 10000;
      }

      #toast.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }

      .toast-badge {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: #74c69d;
      }

      .toast-badge svg {
        width: 18px;
        height: 18px;
        stroke: #fff;
        stroke-width: 3;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .toast-msg {
        font-family: "Noto Sans Devanag‡§∞‡•Ä", system-ui, -apple-system, "Poppins",
          "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        letter-spacing: 0;
        text-decoration: none;
      }

      .toast-x {
        color: #4b5563;
        font-size: 18px;
        line-height: 1;
        cursor: pointer;
        user-select: none;
      }

      .toast-badge.error {
        background: #ef4444;
      }
    </style>
  </head>
  <body>
    <div id="create-site-page" class="mobile-container">
      <header class="page-header">
        <div class="header-content">
          <a href="c-site-list.html" class="back-arrow"
            ><i class="fas fa-chevron-left"></i
          ></a>
          <h1>‡§®‡§Ø‡§æ‡§Å ‡§∏‡§æ‡§á‡§ü ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£</h1>
          <span style="width: 20px"></span>
        </div>
      </header>

      <main class="content-area page-content">
        <form
          id="siteForm"
          enctype="multipart/form-data"
          autocomplete="off"
          novalidate
        >
          <label class="field-label">‡§∏‡§æ‡§á‡§ü‡§ï‡•ã ‡§®‡§æ‡§Æ</label>
          <div class="mb-2">
            <input
              type="text"
              class="form-control"
              name="name"
              placeholder="‡§∞‡§æ‡§®‡•Ä‡§™‡•ã‡§µ‡§æ ‡•ß‡•¶, ‡§∞‡§æ‡§Æ‡§ï‡•ã ‡§ò‡§∞"
              required
            />
            <small class="err" id="err-name"></small>
          </div>

          <label class="field-label">‡§†‡•á‡§ó‡§æ‡§®‡§æ</label>
          <div class="mb-2">
            <input
              type="text"
              class="form-control"
              name="address"
              placeholder="‡§∞‡§æ‡§®‡•Ä‡§™‡•ã‡§µ‡§æ ‡•ß‡•¶,"
            />
            <small class="err" id="err-address"></small>
          </div>

          <label class="field-label">‡§ò‡§∞‡§ß‡§®‡•Ä</label>
          <div class="input-group owner-group mb-2">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <select
              class="form-select"
              id="ownerSelect"
              aria-label="‡§ò‡§∞‡§ß‡§®‡•Ä ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç"
              required
            >
              <option value="" selected disabled>‡§ò‡§∞‡§ß‡§®‡•Ä ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‚Ä¶</option>
            </select>
            <button
              class="btn btn-add-owner"
              type="button"
              id="addOwnerBtn"
              title="‡§ò‡§∞‡§ß‡§®‡•Ä ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç"
            >
              <i class="fas fa-plus"></i>
            </button>
            <ul
              id="ownerDropdown"
              class="list-group"
              role="listbox"
              style="display: none"
            ></ul>
          </div>
          <small class="err" id="err-owner_id"></small>
          <input type="hidden" name="owner_id" id="ownerId" value="" />

          <label class="field-label">‡§∏‡•Å‡§∞‡•Å ‡§Æ‡§ø‡§§‡§ø</label>
          <div class="mb-2">
            <input
              type="text"
              class="form-control"
              name="start_date"
              placeholder="‡§Ö‡§∏‡§æ‡§∞ ‡•™,‡•®‡•¶‡•Æ‡•®"
              onfocus="(this.type='date')"
              required
            />
            <small class="err" id="err-start_date"></small>
          </div>

          <label class="field-label">‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø</label>
          <div class="mb-2">
            <input
              type="text"
              class="form-control"
              name="end_date"
              placeholder="‡§Ö‡§∏‡§æ‡§∞ ‡•™,‡•®‡•¶‡•Æ‡•®"
              onfocus="(this.type='date')"
            />
            <small class="err" id="err-end_date"></small>
          </div>

          <label class="field-label">‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§¨‡§ú‡•á‡§ü</label>
          <div class="mb-2">
            <input
              type="text"
              class="form-control"
              name="estimated_budget"
              id="estimated_budget"
              inputmode="numeric"
              placeholder="‡•Æ‡•¶ ‡§≤‡§æ‡§ñ ‡§∞‡•Å‡§™‡•à‡§Ø‡§æ‡§Å"
            />
            <small class="err" id="err-estimated_budget"></small>
          </div>

          <label class="field-label">‡§µ‡§ø‡§µ‡§∞‡§£</label>
          <div class="mb-2">
            <textarea
              class="form-control"
              name="description"
              placeholder="‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≤‡•á‡§ñ‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç..."
              rows="3"
            ></textarea>
            <small class="err" id="err-description"></small>
          </div>

          <div class="document-section">
            <h5>‡§∏‡§æ‡§á‡§ü ‡§ï‡§æ‡§ó‡§ú‡§æ‡§§‡§π‡§∞‡•Ç</h5>
            <label for="imageUpload" class="image-upload-box">
              <i class="fas fa-image"></i><span>‡§´‡•ã‡§ü‡•ã ‡§π‡§æ‡§≤‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</span>
            </label>
            <input
              type="file"
              id="imageUpload"
              name="images[]"
              class="d-none"
              multiple
              accept="image/*"
            />
            <div id="imagePreview" class="d-flex flex-wrap mt-2 gap-2"></div>
            <small class="err" id="err-images"></small>

            <label class="field-label">‡§∏‡•ç‡§•‡§ø‡§§‡§ø</label>
            <div class="mb-2">
              <select class="form-control" name="status" required>
                <option value="ongoing" selected>‡§™‡•ç‡§∞‡§ó‡§§‡§ø‡§Æ‡§æ</option>
                <option value="completed">‡§∏‡§Æ‡•ç‡§™‡§®‡•ç‡§®</option>
              </select>
              <small class="err" id="err-status"></small>
            </div>
          </div>

          <div class="mt-4">
            <button type="submit" class="btn btn-primary-action w-100">
              ‡§∏‡§æ‡§á‡§ü ‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
            </button>
            <button
              type="button"
              class="btn btn-secondary-action w-100 mt-2"
              onclick="window.location.href='c-site-list.html'"
            >
              ‡§∞‡§¶‡•ç‡§¶ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
            </button>
          </div>
        </form>
      </main>
    </div>

    <!-- Owner (+) Modal -->
    <div class="modal fade" id="ownerModal" tabindex="-1" aria-hidden="true">
      <div
        class="modal-dialog modal-dialog-centered"
        style="max-width: 420px; width: calc(100vw - 32px)"
      >
        <div class="modal-content owner-modal">
          <div class="modal-header border-0">
            <h5 class="modal-title">‡§®‡§Ø‡§æ‡§Å ‡§ò‡§∞‡§ß‡§®‡•Ä ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <form id="ownerForm" class="modal-body pt-0" novalidate>
            <div class="mb-3">
              <input
                id="om_name"
                type="text"
                class="form-control"
                placeholder="‡§ò‡§∞‡§ß‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ"
                required
              />
              <small class="err" id="err-om_name"></small>
            </div>
            <div class="mb-3">
              <input
                id="om_address"
                type="text"
                class="form-control"
                placeholder="‡§†‡•á‡§ó‡§æ‡§®‡§æ"
                required
              />
              <small class="err" id="err-om_address"></small>
            </div>
            <div class="mb-3">
              <input
                id="om_phone"
                type="tel"
                inputmode="numeric"
                class="form-control"
                placeholder="‡§´‡•ã‡§® ‡§®‡§Æ‡•ç‡§¨‡§∞ (‡•ß‡•¶ ‡§Ö‡§Ç‡§ï)"
                maxlength="10"
                required
              />
              <small class="err" id="err-om_phone"></small>
            </div>

            <div class="d-flex gap-2 pt-2">
              <button
                id="ownerSaveBtn"
                class="btn btn-success flex-fill"
                type="submit"
              >
                ‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
              </button>
              <button
                class="btn btn-light flex-fill"
                type="button"
                data-bs-dismiss="modal"
              >
                ‡§∞‡§¶‡•ç‡§¶ ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast host -->
    <div id="toast" role="status" aria-live="polite"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      /* ---------- Toast ---------- */
      function toast(msg, kind = "success") {
        const t = document.getElementById("toast");
        const icon =
          kind === "error"
            ? `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12"/></svg>`
            : `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 6L9 17l-5-5"/></svg>`;

        t.innerHTML = `
    <span class="toast-badge ${kind === "error" ? "error" : ""}">${icon}</span>
    <span class="toast-msg">${msg || ""}</span>
    <span class="toast-x" aria-label="Close">√ó</span>
  `;

        t.classList.add("show");
        t.querySelector(".toast-x").onclick = () => t.classList.remove("show");

        clearTimeout(toast._t);
        toast._t = setTimeout(() => t.classList.remove("show"), 2000);
      }

      // Nepali/English digit helpers + filter for the field
      const NP = "‡•¶‡•ß‡•®‡•©‡•™‡•´‡•¨‡•≠‡•Æ‡•Ø",
        EN = "0123456789";
      const toEn = (s) =>
        String(s || "").replace(/[‡•¶-‡•Ø]/g, (d) => EN[NP.indexOf(d)]);
      const onlyDigits = (s) => String(s || "").replace(/[^\d]/g, "");

      // === Budget input: allow Nepali text to remain visible ===
      const amtEl = document.getElementById("estimated_budget");
      amtEl.addEventListener("input", (e) => {
        // Keep Nepali letters, spaces, punctuation, and digits (EN/NP)
        // This way "‡•Æ‡•¶ ‡§≤‡§æ‡§ñ ‡§∞‡•Å‡§™‡•à‡§Ø‡§æ‡§Å" stays as typed.
        e.target.value = e.target.value.replace(
          /[^\d‡•¶-‡•Ø\u0900-\u097F\s,.\-]/g,
          ""
        );
        // Clear inline error while typing
        clearFieldError("estimated_budget");
      });

      /* --- OWNER: dropdown-only + (+) button --- */
      const ownerSelect = document.getElementById("ownerSelect");
      const ownerIdInput = document.getElementById("ownerId");
      const addOwnerBtn = document.getElementById("addOwnerBtn");

      let owners = [];

      async function fetchOwners() {
        const raw = localStorage.getItem("auth_token");
        if (!raw) return;
        const token = raw.includes("|") ? raw.split("|")[1] : raw;
        try {
          const res = await fetch("http://192.168.1.209:8000/api/owners", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (res.ok) {
            owners = await res.json();
            renderOwnerOptions(owners);
            updateOwnerSelectStyle();
          }
        } catch (e) {
          console.error("Error fetching owners", e);
        }
      }
      fetchOwners();

      function renderOwnerOptions(list) {
        ownerSelect.innerHTML =
          '<option value="" selected disabled>‡§ò‡§∞‡§ß‡§®‡•Ä ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‚Ä¶</option>' +
          (list || [])
            .map(
              (o) => `<option value="${o.id}">${o.name || "(No name)"}</option>`
            )
            .join("");
        if (ownerIdInput.value) ownerSelect.value = ownerIdInput.value;
        updateOwnerSelectStyle();
      }

      function updateOwnerSelectStyle() {
        const hasVal = !!(ownerSelect.value && ownerSelect.value !== "");
        ownerSelect.classList.toggle("has-value", hasVal);
      }

      ownerSelect.addEventListener("change", () => {
        ownerIdInput.value = ownerSelect.value || "";
        updateOwnerSelectStyle();
        clearFieldError("owner_id");
      });

      /* ------- Owner (+) modal wiring ------- */
      const ownerModalEl = document.getElementById("ownerModal");
      const ownerModal = new bootstrap.Modal(ownerModalEl);
      const ownerForm = document.getElementById("ownerForm");
      const ownerSaveBtn = document.getElementById("ownerSaveBtn");

      addOwnerBtn.addEventListener("click", () => {
        ownerForm.reset();
        clearOwnerAll();
        ownerModal.show();
        setTimeout(() => document.getElementById("om_name").focus(), 150);
      });
      ownerModalEl.addEventListener("hidden.bs.modal", clearOwnerAll);

      function getToken() {
        const raw = localStorage.getItem("auth_token");
        return raw && raw.includes("|") ? raw.split("|")[1] : raw;
      }

      function pickOwnerFromResponse(data) {
        if (!data) return null;
        if (data.id) return { id: String(data.id), name: data.name || "" };
        if (data.owner?.id)
          return { id: String(data.owner.id), name: data.owner.name || "" };
        if (data.data?.id)
          return { id: String(data.data.id), name: data.data.name || "" };
        if (data.data?.owner?.id)
          return {
            id: String(data.data.owner.id),
            name: data.data.owner.name || "",
          };
        if (Array.isArray(data) && data[0]?.id)
          return { id: String(data[0].id), name: data[0].name || "" };
        return null;
      }

      function upsertOwnerLocally(o) {
        if (!o || !o.id) return;
        const idx = owners.findIndex((x) => String(x.id) === String(o.id));
        if (idx >= 0) owners[idx] = o;
        else owners.push(o);
        renderOwnerOptions(owners);
      }

      /* ---- owner input helpers + validation ---- */
      const phoneInput = document.getElementById("om_phone");
      if (phoneInput) {
        phoneInput.addEventListener("input", () => {
          phoneInput.value = phoneInput.value.replace(/\D/g, "").slice(0, 10);
          clearOwnerErr("om_phone");
        });
      }

      // Nepali message helpers for server errors
      function npFieldLabel(field) {
        switch (field) {
          case "name":
          case "om_name":
            return "‡§ò‡§∞‡§ß‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ";
          case "address":
          case "om_address":
            return "‡§†‡•á‡§ó‡§æ‡§®‡§æ";
          case "phone_no":
          case "om_phone":
            return "‡§´‡•ã‡§® ‡§®‡§Æ‡•ç‡§¨‡§∞";
          default:
            return "‡§Ø‡•ã ‡§´‡§ø‡§≤‡•ç‡§°";
        }
      }
      function toNepaliOwnerError(field, rawMsg) {
        const label = npFieldLabel(field);
        const m = String(rawMsg || "").toLowerCase();
        if (m.includes("required")) return `${label} ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§õ‡•§`;
        if (m.includes("digits") || m.includes("size"))
          return "‡§´‡•ã‡§® ‡§®‡§Æ‡•ç‡§¨‡§∞ ‡•ß‡•¶ ‡§Ö‡§Ç‡§ï‡§ï‡•ã ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ‡•§";
        if (m.includes("numeric"))
          return "‡§´‡•ã‡§® ‡§®‡§Æ‡•ç‡§¨‡§∞‡§Æ‡§æ ‡§Ö‡§Ç‡§ï ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§";
        if (m.includes("unique")) return `${label} ‡§™‡§π‡§ø‡§≤‡•ç‡§Ø‡•à ‡§¶‡§∞‡•ç‡§§‡§æ ‡§≠‡§á‡§∏‡§ï‡•á‡§ï‡•ã ‡§õ‡•§`;
        if (m.includes("max") || m.includes("too long"))
          return `${label} ‡§ß‡•á‡§∞‡•à ‡§≤‡§æ‡§Æ‡•ã ‡§õ‡•§`;
        return rawMsg || `${label} ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§õ‡•§`;
      }

      ownerForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearOwnerAll();

        const name = document.getElementById("om_name").value.trim();
        const address = document.getElementById("om_address").value.trim();
        const phone = document.getElementById("om_phone").value.trim();

        // Client-side requireds (all three)
        let ok = true;
        if (!name) {
          setOwnerErr("om_name", "‡§ò‡§∞‡¶ß‡§®‡•Ä‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§õ‡•§");
          ok = false;
        }
        if (!address) {
          setOwnerErr("om_address", "‡§†‡•á‡§ó‡§æ‡§®‡§æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§õ‡•§");
          ok = false;
        }

        if (!phone) {
          setOwnerErr("om_phone", "‡§´‡•ã‡§® ‡§®‡§Æ‡•ç‡§¨‡§∞ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§õ‡•§");
          ok = false;
        } else if (!/^\d{10}$/.test(phone)) {
          setOwnerErr("om_phone", "‡§´‡•ã‡§® ‡§®‡§Æ‡•ç‡§¨‡§∞ ‡•ß‡•¶ ‡§Ö‡§Ç‡§ï‡§ï‡•ã ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ‡•§");
          ok = false;
        }
        if (!ok) return;

        const TOKEN = getToken();
        if (!TOKEN) {
          setOwnerErr("om_name", "‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ó‡§á‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§");
          return;
        }

        ownerSaveBtn.disabled = true;
        ownerSaveBtn.textContent = "‡§•‡§™‡§ø‡§Å‡§¶‡•à...";

        try {
          const res = await fetch("http://192.168.1.209:8000/api/owners", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${TOKEN}`,
              Accept: "application/json",
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name,
              address,
              phone_no: phone,
            }),
          });

          const raw = await res.json().catch(() => ({}));
          if (!res.ok) {
            if (res.status === 422 && raw?.errors) {
              if (raw.errors.name)
                setOwnerErr(
                  "om_name",
                  toNepaliOwnerError(
                    "name",
                    Array.isArray(raw.errors.name)
                      ? raw.errors.name[0]
                      : raw.errors.name
                  )
                );
              if (raw.errors.address)
                setOwnerErr(
                  "om_address",
                  toNepaliOwnerError(
                    "address",
                    Array.isArray(raw.errors.address)
                      ? raw.errors.address[0]
                      : raw.errors.address
                  )
                );
              if (raw.errors.phone_no)
                setOwnerErr(
                  "om_phone",
                  toNepaliOwnerError(
                    "phone_no",
                    Array.isArray(raw.errors.phone_no)
                      ? raw.errors.phone_no[0]
                      : raw.errors.phone_no
                  )
                );
              return;
            }
            throw new Error(raw?.message || `HTTP ${res.status}`);
          }

          const created = pickOwnerFromResponse(raw) || { id: raw.id, name };
          upsertOwnerLocally(created);

          ownerSelect.value = created.id;
          ownerIdInput.value = created.id;
          updateOwnerSelectStyle();
          clearFieldError("owner_id");

          ownerModal.hide();
          toast("‡§ò‡§∞‡§ß‡§®‡•Ä ‡§•‡§™‡§ø‡§Ø‡•ã", "success");
        } catch (err) {
          setOwnerErr(
            "om_name",
            "‡§ò‡§∞‡§ß‡§®‡•Ä ‡§•‡§™‡•ç‡§® ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ: " + (err.message || "‡§Ö‡§ú‡•ç‡§û‡§æ‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø")
          );
        } finally {
          ownerSaveBtn.disabled = false;
          ownerSaveBtn.textContent = "‡§•‡§™‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç";
        }
      });

      /* --- images --- */
      const MAX_FILES = 5,
        MAX_SIZE = 2 * 1024 * 1024;
      const imageInput = document.getElementById("imageUpload");
      const imagePreview = document.getElementById("imagePreview");
      let selectedFiles = [];

      imageInput.addEventListener("change", () => {
        const files = Array.from(imageInput.files);
        for (const f of files) {
          if (selectedFiles.length >= MAX_FILES) {
            setFieldError(
              "images",
              `‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ${MAX_FILES} ‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞ ‡§Æ‡§æ‡§§‡•ç‡§∞ ‡§ö‡§Ø‡§® ‡§ó‡§∞‡•ç‡§® ‡§∏‡§ï‡§ø‡§®‡•ç‡§õ‡•§`
            );
            break;
          }
          if (f.size > MAX_SIZE) {
            setFieldError(
              "images",
              `"${f.name}" ‡§ï‡•ã ‡§∏‡§æ‡§á‡§ú ‡§ß‡•á‡§∞‡•à ‡§†‡•Ç‡§≤‡•ã ‡§õ (‡•®MB max).`
            );
            continue;
          }
          selectedFiles.push(f);
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.style.width = "70px";
            img.style.height = "70px";
            img.style.objectFit = "cover";
            img.classList.add("border", "rounded");
            imagePreview.appendChild(img);
          };
          reader.readAsDataURL(f);
        }
        imageInput.value = "";
      });

      /* ---------- Site form inline errors ---------- */
      const formEl = document.getElementById("siteForm");
      const fieldMap = {
        name: () => formEl.name,
        address: () => formEl.address,
        owner_id: () => ownerSelect,
        start_date: () => formEl.start_date,
        end_date: () => formEl.end_date,
        estimated_budget: () => formEl.estimated_budget,
        description: () => formEl.description,
        images: () => imageInput,
        status: () => formEl.status,
      };

      function setFieldError(field, msg) {
        const errEl = document.getElementById(`err-${field}`);
        if (errEl) {
          errEl.textContent = msg || "";
        }
        const input = fieldMap[field]?.();
        if (input) {
          input.classList.add("is-invalid");
        }
      }
      function clearFieldError(field) {
        const errEl = document.getElementById(`err-${field}`);
        if (errEl) {
          errEl.textContent = "";
        }
        const input = fieldMap[field]?.();
        if (input) {
          input.classList.remove("is-invalid");
        }
      }
      function clearAllErrors() {
        Object.keys(fieldMap).forEach(clearFieldError);
      }

      [
        "name",
        "address",
        "start_date",
        "end_date",
        "estimated_budget",
        "description",
      ].forEach((n) => {
        const el = formEl[n];
        el && el.addEventListener("input", () => clearFieldError(n));
      });
      formEl.status &&
        formEl.status.addEventListener("change", () =>
          clearFieldError("status")
        );

      // ===== Date validation (format + sensible year range) =====
      const MIN_YEAR = 1900;
      const MAX_YEAR = 2100;

      function validDateYMD(str) {
        if (!str) return false;
        // accept Nepali digits too: normalize to EN
        const s = toEn(str);
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return false;
        const y = parseInt(m[1], 10);
        const mo = parseInt(m[2], 10);
        const d = parseInt(m[3], 10);
        if (y < MIN_YEAR || y > MAX_YEAR) return "year";
        if (mo < 1 || mo > 12) return false;
        const dt = new Date(y, mo - 1, d);
        const ok =
          dt.getFullYear() === y &&
          dt.getMonth() === mo - 1 &&
          dt.getDate() === d;
        return ok ? true : false;
      }

      function validateDateField(nameKey) {
        const el = formEl[nameKey];
        if (!el || !el.value) {
          // handled by required check elsewhere
          return true;
        }
        const res = validDateYMD(el.value);
        if (res === true) {
          clearFieldError(nameKey);
          return true;
        }
        if (res === "year") {
          setFieldError(
            nameKey,
            `‡§µ‡§∞‡•ç‡§∑ ${MIN_YEAR}‚Äì${MAX_YEAR} ‡§¨‡•Ä‡§ö ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ‡•§`
          );
          return false;
        }
        setFieldError(nameKey, "‡§Æ‡§ø‡§§‡§ø ‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§õ (YYYY-MM-DD ‡§¢‡§æ‡§Å‡§ö‡§æ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç)‡•§");
        return false;
      }

      // Validate on blur as well
      formEl.start_date.addEventListener("blur", () =>
        validateDateField("start_date")
      );
      formEl.end_date.addEventListener("blur", () =>
        validateDateField("end_date")
      );

      document
        .getElementById("siteForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          clearAllErrors();

          let ok = true;
          if (!this.name.value.trim()) {
            setFieldError("name", "‡§∏‡§æ‡§á‡§ü‡§ï‡•ã ‡§®‡§æ‡§Æ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§õ‡•§");
            ok = false;
          }
          if (!ownerIdInput.value.trim()) {
            setFieldError("owner_id", "‡§ò‡§∞‡§ß‡§®‡•Ä ‡§õ‡§æ‡§®‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§");
            ok = false;
          }
          if (!this.start_date.value) {
            setFieldError("start_date", "‡§∏‡•Å‡§∞‡•Å ‡§Æ‡§ø‡§§‡§ø ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§õ‡•§");
            ok = false;
          } else if (!validateDateField("start_date")) {
            ok = false;
          }

          if (this.end_date.value && !validateDateField("end_date")) {
            ok = false;
          }

          /* NEW: end_date must not be before start_date */
          if (
            ok &&
            this.end_date.value &&
            this.start_date.value &&
            validDateYMD(this.start_date.value) === true &&
            validDateYMD(this.end_date.value) === true
          ) {
            const s = new Date(toEn(this.start_date.value));
            const eDate = new Date(toEn(this.end_date.value));
            if (eDate < s) {
              setFieldError(
                "end_date",
                "‡§∏‡§Æ‡§æ‡§™‡•ç‡§§‡§ø ‡§Æ‡§ø‡§§‡§ø ‡§∏‡•Å‡§∞‡•Å ‡§Æ‡§ø‡§§‡§ø‡§≠‡§®‡•ç‡§¶‡§æ ‡§™‡§õ‡§æ‡§°‡§ø ‡§π‡•Å‡§®‡•Å‡§™‡§∞‡•ç‡§õ‡•§"
              );
              clearFieldError("start_date");
              ok = false;
            }
          }

          if (!ok) {
            const firstErr = document.querySelector(".is-invalid");
            firstErr &&
              firstErr.scrollIntoView({ behavior: "smooth", block: "center" });
            return;
          }

          const raw = localStorage.getItem("auth_token");
          if (!raw) {
            setFieldError("name", "‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§≤‡§ó‡§á‡§® ‡§ó‡§∞‡•ç‡§®‡•Å‡§π‡•ã‡§∏‡•ç‡•§");
            return;
          }
          const token = raw.includes("|") ? raw.split("|")[1] : raw;

          const form = new FormData();
          form.append("name", this.name.value);
          form.append("address", this.address.value);
          form.append("owner_id", ownerIdInput.value.trim());
          form.append("start_date", this.start_date.value);
          form.append("end_date", this.end_date.value);
          // Send numeric-only to API but keep Nepali text in UI
          form.append(
            "estimated_budget",
            onlyDigits(toEn(this.estimated_budget.value))
          );
          form.append("description", this.description.value);
          form.append("status", this.status.value);
          for (let i = 0; i < selectedFiles.length; i++) {
            form.append("images[]", selectedFiles[i]);
          }

          try {
            const response = await fetch(
              "http://192.168.1.209:8000/api/sites",
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${token}`,
                  Accept: "application/json",
                },
                body: form,
              }
            );
            const data = await response.json().catch(() => ({}));
            if (response.ok) {
              sessionStorage.setItem("toast_msg", "‡§∏‡§æ‡§á‡§ü ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§•‡§™‡§ø‡§Ø‡•ã");
              sessionStorage.setItem("toast_kind", "success");
              window.location.href = "c-site-list.html";
              return;
            } else {
              if (response.status === 422 && data?.errors) {
                Object.entries(data.errors).forEach(([field, msgs]) => {
                  setFieldError(
                    field,
                    Array.isArray(msgs) ? msgs[0] : String(msgs)
                  );
                });
                const firstErr = document.querySelector(".is-invalid");
                firstErr &&
                  firstErr.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                  });
              } else {
                setFieldError("name", data?.message || "‚ùå ‡§∏‡§æ‡§á‡§ü ‡§•‡§™‡•ç‡§® ‡§∏‡§ï‡•á‡§®");
                console.error(data);
              }
            }
          } catch (err) {
            console.error(err);
            setFieldError("name", "üì° ‡§∏‡§∞‡•ç‡§≠‡§∞‡§Æ‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§≠‡§Ø‡•ã");
          }
        });

      /* ---- owner error helpers ---- */
      function setOwnerErr(id, msg) {
        const input = document.getElementById(id);
        const row = document.getElementById("err-" + id);
        if (input) input.classList.add("is-invalid");
        if (row) row.textContent = msg || "";
      }
      function clearOwnerErr(id) {
        const input = document.getElementById(id);
        const row = document.getElementById("err-" + id);
        if (input) input.classList.remove("is-invalid");
        if (row) row.textContent = "";
      }
      function clearOwnerAll() {
        ["om_name", "om_address", "om_phone"].forEach(clearOwnerErr);
      }
      ["om_name", "om_address", "om_phone"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", () => clearOwnerErr(id));
      });
    </script>
  </body>
</html>
