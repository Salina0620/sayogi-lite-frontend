<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Site</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="CSS/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
</head>
<body>

<div class="mobile-container">
    <!-- Page Header -->
    <header class="page-header">
        <div class="header-content mb-3 pt-3 d-flex align-items-center">
            <a href="c-site-list.html" class="back-arrow me-3"><i class="fas fa-chevron-left"></i></a>
            <h1 class="mb-0">नयाँ साइट निर्माण</h1>
            <div class="header-placeholder flex-grow-1"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="content-area page-content">
        <form id="siteForm" enctype="multipart/form-data" autocomplete="off">
            <div class="mb-3">
                <input type="text" class="form-control" placeholder="साइटको नाम" name="name" required />
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" placeholder="ठेगाना" name="address" />
            </div>
            <div class="input-group mb-3 position-relative">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input
                    type="text"
                    class="form-control"
                    placeholder="घरधनी खोज्नुहोस्"
                    id="ownerNameInput"
                    required
                    aria-autocomplete="list"
                />
                <button class="btn btn-add-owner" type="button" title="घरधनी थप्नुहोस्" id="addOwnerBtn">
                    <i class="fas fa-plus"></i>
                </button>

                <!-- Dropdown container -->
                <ul
                    id="ownerDropdown"
                    class="list-group position-absolute"
                    style="top: 100%; left: 0; right: 50px; z-index: 1000; max-height: 150px; overflow-y: auto; display:none;"
                    role="listbox"
                ></ul>
            </div>

            <!-- Hidden owner_id input -->
            <input type="hidden" name="owner_id" id="ownerId" value="" />

            <div class="mb-3">
                <input type="text" class="form-control" placeholder="सुरु मिति" name="start_date" onfocus="(this.type='date')" required />
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" placeholder="समाप्ति मिति" name="end_date" onfocus="(this.type='date')" />
            </div>
            <div class="mb-3">
                <input type="text" class="form-control" placeholder="अनुमानित बजेट" name="estimated_budget" />
            </div>
            <div class="mb-3">
                <textarea class="form-control" rows="3" placeholder="विवरण" name="description"></textarea>
            </div>

            <hr />

            <!-- Documents Section -->
            <div class="document-section">
    <h5>साइट कागजातहरू</h5>
    <label for="imageUpload" class="image-upload-box" style="cursor:pointer;">
        <i class="fas fa-image"></i>
        <span>फोटो हाल्नुहोस्</span>
    </label>
    <input type="file" id="imageUpload" name="images[]" class="d-none" multiple accept="image/*" />

    <!-- Thumbnails preview -->
    <div id="imagePreview" class="d-flex flex-wrap mt-2 gap-2"></div>

   <div class="mt-3">
    <select class="form-control" name="status" required>
        <option value="ongoing" selected>Ongoing</option>
        <option value="completed">Completed</option>
    </select>
</div>


</div>

            <div class="action-buttons mt-4">
                <button type="submit" class="btn btn-primary-action w-100">साइट निर्माण गर्नुहोस्</button>
                <button type="button" class="btn btn-secondary-action w-100 mt-2" onclick="window.location.href='c-site-list.html'">रद्द गर्नुहोस्</button>
            </div>
        </form>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const ownerNameInput = document.getElementById('ownerNameInput');
const ownerDropdown = document.getElementById('ownerDropdown');
const ownerIdInput = document.getElementById('ownerId');
const addOwnerBtn = document.getElementById('addOwnerBtn');

let owners = [];

// Fetch owners on page load
async function fetchOwners() {
    const token = localStorage.getItem('auth_token');
    if (!token) return;

    try {
        const res = await fetch('http://192.168.1.209:8000/api/owners', {
            headers: { Authorization: `Bearer ${token}` }
        });
        if (res.ok) {
            owners = await res.json();
            console.log('Owners loaded:', owners);
        } else {
            console.error('Failed to fetch owners', res.status);
        }
    } catch (e) {
        console.error('Error fetching owners', e);
    }
}

fetchOwners();

// Owner dropdown logic (unchanged)
ownerNameInput.addEventListener('input', () => {
    const query = ownerNameInput.value.trim().toLowerCase();
    ownerIdInput.value = '';

    if (!query) {
        ownerDropdown.style.display = 'none';
        return;
    }

    const filtered = owners.filter(o => o.name.toLowerCase().includes(query));
    if (filtered.length === 0) {
        ownerDropdown.style.display = 'none';
        return;
    }

    ownerDropdown.innerHTML = filtered
        .map(o => `<li class="list-group-item list-group-item-action" data-id="${o.id}" role="option">${o.name}</li>`)
        .join('');

    ownerDropdown.style.display = 'block';
});
ownerNameInput.addEventListener('focus', () => {
    const query = ownerNameInput.value.trim().toLowerCase();
    if (!query) {
        if (owners.length === 0) {
            ownerDropdown.style.display = 'none';
            return;
        }

        ownerDropdown.innerHTML = owners
            .map(o => `<li class="list-group-item list-group-item-action" data-id="${o.id}" role="option">${o.name}</li>`)
            .join('');
        ownerDropdown.style.display = 'block';
        ownerIdInput.value = '';
        return;
    }

    const filtered = owners.filter(o => o.name.toLowerCase().includes(query));
    if (filtered.length === 0) {
        ownerDropdown.style.display = 'none';
        return;
    }
    ownerDropdown.innerHTML = filtered
        .map(o => `<li class="list-group-item list-group-item-action" data-id="${o.id}" role="option">${o.name}</li>`)
        .join('');
    ownerDropdown.style.display = 'block';
});

ownerDropdown.addEventListener('click', (e) => {
    if (e.target.tagName === 'LI') {
        ownerNameInput.value = e.target.textContent;
        ownerIdInput.value = e.target.dataset.id;
        ownerDropdown.style.display = 'none';
    }
});

document.addEventListener('click', (e) => {
    if (!ownerNameInput.contains(e.target) && !ownerDropdown.contains(e.target)) {
        ownerDropdown.style.display = 'none';
    }
});

addOwnerBtn.addEventListener('click', () => {
    window.location.href = 'addowner.html';
});

// ----- IMAGE UPLOAD PREVIEW & VALIDATION -----
const MAX_FILES = 5;
const MAX_SIZE = 2 * 1024 * 1024; // 2MB
const imageInput = document.getElementById('imageUpload');

// Create preview container dynamically
let imagePreview = document.getElementById('imagePreview');
if (!imagePreview) {
    imagePreview = document.createElement('div');
    imagePreview.id = 'imagePreview';
    imagePreview.classList.add('mt-2', 'd-flex', 'gap-2', 'flex-wrap');
    imageInput.parentNode.appendChild(imagePreview);
}

let selectedFiles = [];

imageInput.addEventListener('change', () => {
    const files = Array.from(imageInput.files);

    for (const file of files) {
        if (selectedFiles.length >= MAX_FILES) {
            alert(`❌ अधिकतम ${MAX_FILES} तस्वीर मात्र चयन गर्न सकिन्छ।`);
            break;
        }

        if (file.size > MAX_SIZE) {
            alert(`❌ "${file.name}" को साइज धेरै ठूलो छ। अधिकतम 2MB मात्र।`);
            continue;
        }

        selectedFiles.push(file);

        const reader = new FileReader();
        reader.onload = e => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '70px';
            img.style.height = '70px';
            img.style.objectFit = 'cover';
            img.classList.add('border', 'rounded');
            imagePreview.appendChild(img);
        }
        reader.readAsDataURL(file);
    }

    // Reset the input so same file can be selected again if needed
    imageInput.value = '';
});

// Form submission with validation
document.getElementById('siteForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const selectedOwnerId = ownerIdInput.value.trim();
    const ownerName = ownerNameInput.value.trim();

    const matchedOwner = owners.find(o => o.id == selectedOwnerId && o.name === ownerName);

    if (!matchedOwner) {
        alert('कृपया सूचीबाट घरधनी छान्नुहोस् वा नयाँ घरधनी थप्नुहोस्।');
        return;
    }

    const token = localStorage.getItem('auth_token');
    if (!token) {
        alert("⚠️ कृपया लगइन गर्नुहोस्।");
        return;
    }

    const form = new FormData();
    form.append('name', this.name.value);
    form.append('address', this.address.value);
    form.append('owner_id', selectedOwnerId);
    form.append('start_date', this.start_date.value);
    form.append('end_date', this.end_date.value);
    form.append('estimated_budget', this.estimated_budget.value);
    form.append('description', this.description.value);
form.append('status', this.status.value);

    // Append selected files
    for (let i = 0; i < selectedFiles.length; i++) {
        form.append('images[]', selectedFiles[i]);
    }

    form.set('owner_id', selectedOwnerId);

    try {
        const response = await fetch('http://192.168.1.209:8000/api/sites', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json' 
            },
            body: form
        });

        const data = await response.json();

        if (response.ok) {
            alert("✅ साइट सफलतापूर्वक थपियो");
            window.location.href = "c-site-list.html";
        } else {
            alert(data.message || "❌ साइट थप्न सकेन");
            console.error(data);
        }
    } catch (error) {
        console.error(error);
        alert("📡 सर्भरमा समस्या भयो");
    }
});
</script>



</body>
</html>
