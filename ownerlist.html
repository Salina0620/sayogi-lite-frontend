<!DOCTYPE html>
<html lang="ne">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Owner List</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="CSS/style.css" />

    <!-- Fonts & Icons -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Noto+Sans+Devanagari:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>

  <body>
    <div class="mobile-container">
      <div id="successBanner" class="alert alert-success text-center m-3" style="display: none">
        ✔️ घरधनी सफलतापूर्वक थपियो!
      </div>

      <header class="page-header">
        <div class="header-content mb-3 pt-3">
          <a href="home.html" class="back-arrow"><i class="fas fa-chevron-left"></i></a>
          <h1><a href="ownerlist.html" class="text-decoration-none text-dark">घरधनी</a></h1>
          <div class="header-placeholder"></div>
        </div>
      </header>

      <main class="content-area page-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <a href="addowner.html" class="btn btn-add-new">
            <i class="fas fa-plus"></i> नयाँ
          </a>
        </div>

        <div class="search-bar-wrapper mb-4">
          <i class="fas fa-search search-icon"></i>
          <input
            type="text"
            class="form-control search-input"
            placeholder="खोज्नुहोस्..."
            oninput="filterOwners()"
          />
        </div>

        <div class="owner-list"></div>
      </main>
    </div>

    <!-- ✅ Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

   <script>
  document.addEventListener("DOMContentLoaded", () => {
    let ownerToDelete = null;
    let ownerElementToDelete = null;

    const editOwnerModal = new bootstrap.Modal(document.getElementById("editOwnerModal"));
    const editOwnerForm = document.getElementById("editOwnerForm");
    const deleteModal = new bootstrap.Modal(document.getElementById("deleteConfirmModal"));

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get("added") === "1") {
      showSuccessBanner("✔️ घरधनी सफलतापूर्वक थपियो!");
      history.replaceState(null, "", window.location.pathname);
    }

    loadOwners();

    async function loadOwners() {
      const token = localStorage.getItem("auth_token");
      if (!token) {
        alert("⚠️ कृपया पहिले लगइन गर्नुहोस्।");
        window.location.href = "login.html";
        return;
      }

      const REAL_TOKEN = token.includes("|") ? token.split("|")[1] : token;

      try {
        const res = await fetch("http://192.168.1.209:8000/api/owners", {
          headers: {
            Authorization: `Bearer ${REAL_TOKEN}`,
            Accept: "application/json",
          },
        });

        const owners = await res.json();
        if (!res.ok) return console.error("Failed to load owners", owners);

        const ownerList = document.querySelector(".owner-list");
        ownerList.innerHTML = "";

        if (owners.length === 0) {
          ownerList.innerHTML = `<p class="text-center">कोई घरधनी फेला परेन</p>`;
          return;
        }

        owners.forEach((owner) => {
          const ownerItem = document.createElement("div");
          ownerItem.className = "owner-item";
          ownerItem.setAttribute("data-owner-id", owner.id);
          ownerItem.innerHTML = `
            <div class="owner-info">
              <div class="owner-name">${owner.name}</div>
              <div class="owner-phone">${owner.phone_no}</div>
              <div class="owner-address">${owner.address}</div>
            </div>
            <div class="action-icons">
              <a href="#" class="edit-icon"><i class="fas fa-pencil-alt"></i></a>
              <a href="#" class="delete-icon"><i class="fas fa-trash-alt"></i></a>
            </div>
          `;
          ownerList.appendChild(ownerItem);
        });

        addEditListeners();
        addDeleteListeners();
      } catch (err) {
        console.error("Error loading owners:", err);
      }
    }

    function addDeleteListeners() {
      document.querySelectorAll(".delete-icon").forEach((icon) => {
        icon.addEventListener("click", (e) => {
          e.preventDefault();
          ownerElementToDelete = icon.closest(".owner-item");
          ownerToDelete = ownerElementToDelete.getAttribute("data-owner-id");
          if (ownerToDelete) deleteModal.show();
        });
      });
    }

    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
      const token = localStorage.getItem("auth_token");
      if (!token || !ownerToDelete || !ownerElementToDelete) return;

      const REAL_TOKEN = token.includes("|") ? token.split("|")[1] : token;

      try {
        const res = await fetch(`http://192.168.1.209:8000/api/owners/${ownerToDelete}`, {
          method: "DELETE",
          headers: {
            Authorization: `Bearer ${REAL_TOKEN}`,
            Accept: "application/json",
          },
        });

        if (res.ok) {
          deleteModal.hide();
          ownerElementToDelete.remove();
          showSuccessBanner("घरधनी सफलतापूर्वक हटाइयो।");
        } else {
          const err = await res.json();
          alert("हटाउन असफल भयो: " + (err.message || "Unknown error"));
        }
      } catch (err) {
        alert("नेटवर्क त्रुटि भयो।");
        console.error("Delete error:", err);
      }
    });

    function addEditListeners() {
      document.querySelectorAll(".edit-icon").forEach((icon) => {
        icon.addEventListener("click", async (e) => {
          e.preventDefault();
          const ownerItem = icon.closest(".owner-item");
          const ownerId = ownerItem.getAttribute("data-owner-id");
          const token = localStorage.getItem("auth_token");
          if (!token) return alert("⚠️ कृपया पहिले लगइन गर्नुहोस्।");

          const REAL_TOKEN = token.includes("|") ? token.split("|")[1] : token;

          try {
            const res = await fetch(`http://192.168.1.209:8000/api/owners/${ownerId}`, {
              headers: {
                Authorization: `Bearer ${REAL_TOKEN}`,
                Accept: "application/json",
              },
            });

            if (!res.ok) return alert("Failed to fetch owner details.");
            const owner = await res.json();

            document.getElementById("editOwnerId").value = owner.id;
            document.getElementById("editOwnerName").value = owner.name;
            document.getElementById("editOwnerPhone").value = owner.phone_no;
            document.getElementById("editOwnerAddress").value = owner.address;

            editOwnerModal.show();
          } catch (err) {
            alert("Error loading owner data.");
            console.error("Fetch error:", err);
          }
        });
      });
    }

    editOwnerForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const ownerId = document.getElementById("editOwnerId").value;
      const name = document.getElementById("editOwnerName").value.trim();
      const phone_no = document.getElementById("editOwnerPhone").value.trim();
      const address = document.getElementById("editOwnerAddress").value.trim();

      const token = localStorage.getItem("auth_token");
      if (!token) return alert("⚠️ कृपया पहिले लगइन गर्नुहोस्।");

      const REAL_TOKEN = token.includes("|") ? token.split("|")[1] : token;

      try {
        const res = await fetch(`http://192.168.1.209:8000/api/owners/${ownerId}`, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${REAL_TOKEN}`,
            "Content-Type": "application/json",
            Accept: "application/json",
          },
          body: JSON.stringify({ name, phone_no, address }),
        });

        const data = await res.json();

        if (res.ok) {
          const ownerItem = document.querySelector(`.owner-item[data-owner-id="${ownerId}"]`);
          ownerItem.querySelector(".owner-name").textContent = data.owner.name;
          ownerItem.querySelector(".owner-phone").textContent = data.owner.phone_no;
          ownerItem.querySelector(".owner-address").textContent = data.owner.address;

          editOwnerModal.hide();
          showSuccessBanner("✔️ सफलतापूर्वक अपडेट भयो");
        } else {
          alert(data.message || "Failed to update owner.");
        }
      } catch (err) {
        console.error("Update error:", err);
        alert("नेटवर्क त्रुटि भयो। कृपया पुन: प्रयास गर्नुहोस्।");
      }
    });

    window.filterOwners = function () {
      const query = document.querySelector(".search-input").value.toLowerCase();
      document.querySelectorAll(".owner-item").forEach((owner) => {
        const name = owner.querySelector(".owner-name").textContent.toLowerCase();
        const phone = owner.querySelector(".owner-phone").textContent.toLowerCase();
        const address = owner.querySelector(".owner-address").textContent.toLowerCase();

        owner.style.display =
          name.includes(query) || phone.includes(query) || address.includes(query)
            ? ""
            : "none";
      });
    };

    function showSuccessBanner(msg) {
      const banner = document.getElementById("successBanner");
      banner.textContent = msg;
      banner.style.display = "block";
      setTimeout(() => (banner.style.display = "none"), 3000);
    }
  });
</script>


    <!-- Edit Owner Modal -->
    <div class="modal fade" id="editOwnerModal" tabindex="-1" aria-labelledby="editOwnerLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form id="editOwnerForm" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editOwnerLabel">घरधनी सम्पादन गर्नुहोस्</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editOwnerId" name="id" />
            <div class="mb-3">
              <label for="editOwnerName" class="form-label">नाम</label>
              <input type="text" class="form-control" id="editOwnerName" name="name" required />
            </div>
            <div class="mb-3">
              <label for="editOwnerPhone" class="form-label">फोन नम्बर</label>
              <input type="text" class="form-control" id="editOwnerPhone" name="phone_no" required />
            </div>
            <div class="mb-3">
              <label for="editOwnerAddress" class="form-label">ठेगाना</label>
              <input type="text" class="form-control" id="editOwnerAddress" name="address" required />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">रद्द गर्नुहोस्</button>
            <button type="submit" class="btn btn-primary">अपडेट गर्नुहोस्</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div
      class="modal fade"
      id="deleteConfirmModal"
      tabindex="-1"
      aria-labelledby="deleteConfirmLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmLabel">पुष्टि गर्नुहोस्</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">के तपाईं साँच्चिकै यो घरधनी हटाउन चाहनुहुन्छ?</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">रद्द गर्नुहोस्</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">हटाउनुहोस्</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
