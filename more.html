<!DOCTYPE html>
<html lang="ne">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>अरू</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --brand-green:#13a87d; --alert-red:#dc3545;
      --bg:#f6f8f9; --surface:#fff; --text-800:#1f2937;
      --text-700:#344054; --text-600:#667085; --text-500:#98a2b3;
      --border:#e6e8eb;
      --shadow-card:0 1px 2px rgba(16,24,40,.06);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --nav-h:52px;
      --row-h:56px;
      --arrow-col:28px;
      --radius-card:14px;
      --icon-size:20px;
    }

    *{ box-sizing:border-box; }
    html,body{
      margin:0; min-height:100dvh;
      background:var(--bg);
      font-family:"Noto Sans Devanagari", system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      overflow:hidden; /* content scrolls, not body */
      font-weight:400; color:var(--text-800);
    }

    .mobile-container{
      width:100vw; height:100dvh; background:var(--surface);
      position:relative; display:flex; flex-direction:column;
      padding-top:var(--safe-top);
    }

    /* Header */
    .app-header{ background:var(--brand-green); color:#fff; padding:12px 16px; }
    .user-row{ display:flex; align-items:center; gap:12px; }
    .avatar{
      width:36px; height:36px; border-radius:50%;
      background:rgba(255,255,255,.15); color:#fff;
      display:grid; place-items:center; font-weight:700; font-size:16px;
    }
    .user-name{ font-size:16px; font-weight:700; }

    /* Content */
    .content-area{
      flex:1 1 auto; padding:12px 12px calc(var(--nav-h) + var(--safe-bottom) + 16px);
      background:#f8fafb; overflow:auto; overflow-x:hidden;
    }
    .section-title{ font-size:13px; font-weight:500; color:#475467; margin:12px 6px 8px; }

    /* Cards */
    .list-card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius-card);
      box-shadow:var(--shadow-card); margin:10px 4px; overflow:hidden;
    }

    /* Rows */
    .list-item{
      display:flex; align-items:center; min-height:var(--row-h);
      padding:0 12px; gap:12px; text-decoration:none; color:inherit;
    }
    .list-item + .list-item{ border-top:1px solid #eef2f6; }
    .list-action{ cursor:pointer; }

    .item-left{ display:flex; align-items:center; gap:10px; flex:1 1 auto; min-width:0; }

    /* Icons */
    .icon{ width:var(--icon-size); height:var(--icon-size); flex:0 0 var(--icon-size); display:block; color:#20262d; }
    .icon.red{ color:var(--alert-red); }

    .item-text{ font-weight:400; font-size:15px; color:var(--text-800); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Right arrow column */
    .item-right{ width:var(--arrow-col); flex:0 0 var(--arrow-col); display:flex; align-items:center; justify-content:flex-end; }
    .chev{ width:18px; height:18px; color:#a0a6ad; display:block; }

    /* Logout: red, no arrow */
    .list-card.logout .list-item{ color:var(--alert-red); }
    .list-card.logout .item-left .icon{ color:var(--alert-red); }
    .list-card.logout .item-right{ display:none !important; }

    /* Bottom nav */
    .bottom-nav{
      position:absolute; left:0; right:0; bottom:0; height:var(--nav-h); background:#fff;
      border-top:1px solid var(--border); display:flex; justify-content:space-around; align-items:center;
      padding-bottom:var(--safe-bottom);
    }
    .bottom-nav .nav-item{
      flex:1 1 0; text-decoration:none; color:#9aa4b2;
      display:flex; flex-direction:column; align-items:center; gap:2px; font-size:10px; padding-top:6px;
      font-weight:500;
    }
    .bottom-nav .nav-item i{ font-size:20px; line-height:1; }
    .bottom-nav .nav-item.active{ color:var(--brand-green); font-weight:700; }

    @media (max-height:700px){
      .list-item{ min-height:52px; }
    }
  </style>
</head>

<body>
  <div class="mobile-container">
    <!-- HEADER -->
    <header class="app-header">
      <div class="user-row">
        <div class="avatar" id="avatar">U</div>
        <div class="user-name" id="userName">प्रयोगकर्ता नाम</div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="content-area">

      <div class="list-card">
        <a href="profile.html" class="list-item">
          <div class="item-left">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14Z" fill="currentColor"/></svg>
            <div class="item-text">मेरो प्रोफाइल</div>
          </div>
          <div class="item-right">
            <svg class="chev" viewBox="0 0 24 24" fill="none"><path d="M5 12h12m-4-4 4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
        </a>
      </div>

      <div class="section-title">व्यवस्थापन</div>
      <div class="list-card">
        <a href="trash-history.html" class="list-item">
          <div class="item-left">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M5 3v4h4M21 12a9 9 0 1 1-9-9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8v5l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <div class="item-text">ट्र्यास हिस्ट्री</div>
          </div>
          <div class="item-right"><svg class="chev" viewBox="0 0 24 24" fill="none"><path d="M5 12h12m-4-4 4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
        </a>

        <a href="reports.html" class="list-item">
          <div class="item-left">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 20V10M10 20V4M16 20v-8M22 20H2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <div class="item-text">रिपोर्टहरू हेर्नुहोस्</div>
          </div>
          <div class="item-right"><svg class="chev" viewBox="0 0 24 24" fill="none"><path d="M5 12h12m-4-4 4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
        </a>

        <a href="settings.html" class="list-item">
          <div class="item-left">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="2"/><path d="M19 12a7 7 0 0 0-.1-1l2-1.5-2-3.5-2.4.9a7.5 7.5 0 0 0-1.5-.9L14.5 2h-5l-.5 3.1a7.5 7.5 0 0 0-1.5.9l-2.4-.9-2 3.5L4.9 11a7 7 0 0 0 0 2l-1.8 1.5 2 3.5 2.4-.9a7.5 7.5 0 0 0 1.5.9l.5 3.1h5l.5-3.1a7.5 7.5 0 0 0 1.5-.9l2.4.9 2-3.5L18.9 13a7 7 0 0 0 .1-1Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <div class="item-text">सेटिङ</div>
          </div>
          <div class="item-right"><svg class="chev" viewBox="0 0 24 24" fill="none"><path d="M5 12h12m-4-4 4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
        </a>
      </div>

      <div class="section-title">अन्य</div>
      <div class="list-card">
        <a href="#" class="list-item list-action" id="btnShare">
          <div class="item-left">
            <svg class="icon" viewBox="0 0 24 24" fill="none">
              <circle cx="18" cy="5" r="3" stroke="currentColor" stroke-width="2"/>
              <circle cx="6" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
              <circle cx="18" cy="19" r="3" stroke="currentColor" stroke-width="2"/>
              <path d="M8.6 11l6-3.5M8.6 13l6 3.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <div class="item-text">एप सेयर गर्नुहोस्</div>
          </div>
          <div class="item-right"><svg class="chev" viewBox="0 0 24 24" fill="none"><path d="M5 12h12m-4-4 4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
        </a>

        <a href="#" class="list-item list-action" id="btnRate">
          <div class="item-left">
            <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="m12 3 2.7 5.5L21 9.5l-4.5 4.4L17.4 21 12 18l-5.4 3 1-7.1L3 9.5l6.3-1z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/></svg>
            <div class="item-text">एपलाई रेटिङ दिनुहोस्</div>
          </div>
          <div class="item-right"><svg class="chev" viewBox="0 0 24 24" fill="none"><path d="M5 12h12m-4-4 4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
        </a>
      </div>

      <div class="list-card logout">
        <!-- Use data attributes so Bootstrap opens the modal; no JS init required -->
        <a href="#" class="list-item list-action" id="btnLogout"
           data-bs-toggle="modal" data-bs-target="#logoutModal">
          <div class="item-left">
            <svg class="icon red" viewBox="0 0 24 24" fill="none"><path d="M13 7V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M10 12h10m0 0-3-3m3 3-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <div class="item-text">लग आउट</div>
          </div>
          <div class="item-right"></div>
        </a>
      </div>

    </main>

    <!-- BOTTOM NAV from bottom.html -->
    <div id="bottom-nav"></div>
  </div>

  <!-- ✅ Logout Modal (Bootstrap) -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0">
        <div class="modal-header border-0">
          <h1 class="modal-title fs-5" id="logoutLabel">लग आउट गर्न चाहनुहुन्छ?</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="बन्द"></button>
        </div>
        <div class="modal-body pt-0">
          तपाईं यस खाताबाट बाहिर निस्कन लाग्नु भएको छ।
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">रद्द</button>
          <button type="button" class="btn btn-danger" id="confirmLogout">
            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
            लग आउट
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Load shared bottom.html + set active tab = "more" -->
  <script>
    (function () {
      const mount = document.getElementById('bottom-nav');

      const routes = {
        'home':   ['home','index'],
        'site':   ['c-site-list','c-list-info','new-site-list'],
        'karobar':['karobar','site-ledger','site-finance','site-income-expense','c-site-ledger','amdani-kharcha'],
        'party':  ['party','ownerlist'],
        'more':   ['more','settings','reports','trash-history','profile'] // this page -> "more"
      };

      function detectPageKey() {
        const file = (location.pathname.split('/').pop() || '').toLowerCase();
        const name = file.replace(/\.html(?:\?.*)?$/, '');
        for (const [key, list] of Object.entries(routes)) {
          if (list.some(n => n && name.startsWith(n))) return key;
        }
        return 'more';
      }

      function setActive(navRoot) {
        const activeKey = detectPageKey();
        navRoot.querySelectorAll('.nav-item').forEach(a => {
          a.classList.toggle('active', a.dataset.page === activeKey);
        });
      }

      function updateNavHeightVar() {
        const nav = document.querySelector('.bottom-nav');
        if (!nav) return;
        const h = Math.round(nav.getBoundingClientRect().height);
        document.documentElement.style.setProperty('--nav-h', h + 'px');
      }

      fetch('bottom.html', { cache: 'no-store' })
        .then(r => r.text())
        .then(html => {
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const nav = doc.querySelector('nav.bottom-nav');
          if (!nav) throw new Error('bottom.html: <nav.bottom-nav> not found');

          const styleEl = doc.querySelector('style'); // optional

          mount.innerHTML = '';
          if (styleEl) mount.appendChild(styleEl);
          mount.appendChild(nav);

          setActive(mount);
          updateNavHeightVar();

          addEventListener('resize', updateNavHeightVar);
          addEventListener('orientationchange', updateNavHeightVar);
          addEventListener('pageshow', updateNavHeightVar);
        })
        .catch(err => {
          console.error('Failed to load bottom.html:', err);
        });
    })();
  </script>

  <script>
    const API_BASE = "http://192.168.1.209:8000/api";
    const RAW_TOKEN = localStorage.getItem("auth_token");
    if (!RAW_TOKEN) { window.location.href = "login.html"; }
    const TOKEN = RAW_TOKEN.includes("|") ? RAW_TOKEN.split("|")[1] : RAW_TOKEN;
    const AUTH_HEADERS = { Authorization: `Bearer ${TOKEN}`, Accept: "application/json" };

    function initialsOf(name="") {
      const p = name.trim().split(/\स+/);
      if (!p[0]) return "U";
      if (p.length === 1) return p[0].charAt(0).toUpperCase();
      return (p[0].charAt(0) + p[p.length-1].charAt(0)).toUpperCase();
    }

    const nameEl = document.getElementById("userName");
    const avatarEl = document.getElementById("avatar");

    // --- Instant UI update helpers ---
    function updateDisplayName(name){
      const safe = (name && String(name).trim()) || "प्रयोगकर्ता नाम";
      nameEl.textContent = safe;
      avatarEl.textContent = initialsOf(safe);
    }

    function readNameFromLocal(){
      // prefer user_name; fall back to user.name
      let name = localStorage.getItem("user_name") || "";
      if (!name) {
        try {
          const u = JSON.parse(localStorage.getItem("user") || "{}");
          name = (u && u.name) || "";
        } catch {}
      }
      if (name) updateDisplayName(name);
    }

    async function fetchNameFromAPI(){
      try{
        const res = await fetch(`${API_BASE}/user`, { headers: AUTH_HEADERS });
        if (!res.ok) throw new Error("user fetch failed");
        const user = await res.json();
        const name = user?.name || user?.user?.name || "";
        if (name) {
          updateDisplayName(name);
          // keep local cache aligned for future pages
          localStorage.setItem("user_name", name);
          try {
            const u = JSON.parse(localStorage.getItem("user") || "{}");
            if (u && typeof u === "object") {
              u.name = name;
              localStorage.setItem("user", JSON.stringify(u));
            }
          } catch {}
        }
      }catch(e){
        console.warn("user fetch failed", e);
      }
    }

    // --- Live sync: update immediately when profile page changes localStorage ---
    window.addEventListener("storage", (e)=>{
      if (e.key === "user_name" || e.key === "user") {
        readNameFromLocal();
      }
    });
    // Also refresh name when returning to this tab/page
    window.addEventListener("focus", readNameFromLocal);
    document.addEventListener("visibilitychange", ()=>{ if (!document.hidden) readNameFromLocal(); });
    window.addEventListener("pageshow", readNameFromLocal);

    // Boot: show quickly from local cache, then confirm with API
    readNameFromLocal();
    fetchNameFromAPI();

    // Share
    document.getElementById("btnShare").addEventListener("click", async (e) => {
      e.preventDefault();
      const shareData = {
        title: "प्रोजेक्ट सहयोगी",
        text: "यस एप प्रयोग गरेर निर्माण खर्च/आय व्यवस्थापन गर्नुहोस्।",
        url: "https://example.com"
      };
      try{
        if (navigator.share) await navigator.share(shareData);
        else { await navigator.clipboard.writeText(shareData.url); alert("लिङ्क कपी भयो।"); }
      }catch{}
    });

    // Rate
    document.getElementById("btnRate").addEventListener("click", (e) => {
      e.preventDefault();
      window.location.href = "https://play.google.com/store/apps/details?id=com.yourapp";
    });

    // ✅ Logout handler
    async function doLogout(){
      const btn = document.getElementById("confirmLogout");
      const spn = btn.querySelector(".spinner-border");
      btn.disabled = true; spn.classList.remove("d-none");
      try{
        await fetch(`${API_BASE}/logout`, { method:"POST", headers: AUTH_HEADERS });
      }catch(e){
        // ignore errors
      }
      localStorage.removeItem("auth_token");
      window.location.href = "login.html";
    }
    document.getElementById("confirmLogout").addEventListener("click", doLogout);

    // Reset modal button state if user cancels
    document.getElementById("logoutModal").addEventListener("hidden.bs.modal", ()=>{
      const btn = document.getElementById("confirmLogout");
      const spn = btn.querySelector(".spinner-border");
      btn.disabled = false; spn.classList.add("d-none");
    });
  </script>

  <!-- Icons + Bootstrap JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
